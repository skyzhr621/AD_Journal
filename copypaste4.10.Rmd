---
title: "AD_model"
author: "Qing Liu"
date: "12/20/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 


```{r}
library(stringr)
library(CCA)
library(readxl)
library(dplyr)
library(drc)
library(cutpointr)
library(ggplot2)
library(mixtools)
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")
FDG_SUVR<-na.omit(FDG_SUVR)
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
Amyloid_SUVR<-na.omit(Amyloid_SUVR,  cols = c("DX"))
Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
#Tau_SUVR<-na.omit(Tau_SUVR)
```

```{r}
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
table(as.factor(Amyloid_SUVR$DX) )
 
```

```{r}
TABLE<-data.frame(table(Tau_SUVR$PTID))
TABLE<- TABLE[which(TABLE$Freq>2),]
 
Tau_first<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau_SUVR)))
Tau_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau_SUVR)))
for (i in 1:nrow(TABLE)){
Tau_first[i,] <- Tau_SUVR[min(which(Tau_SUVR$PTID == TABLE$Var1[i])), ]

Tau_last[i,] <- Tau_SUVR[max(which(Tau_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(Tau_first) <- colnames(Tau_SUVR)
colnames(Tau_last) <- colnames(Tau_SUVR)
```


```{r}
Tau_first_EMCI<-Tau_first[which(Tau_first$DX=="EMCI"),]
```

 

```{r}
Prob<-as.data.frame(matrix(0,148, 2))
colnames(Prob)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-Tau_first[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob[i,]<-ee[[1]] 
}
```

```{r}
Tau_simulated<- final_data_unscaled[, c(1, 152:299)]
colnames(Tau_simulated)[1]<-colnames(Tau_first)[1]
colnames(Tau_simulated)[2:149]<-colnames(Tau_first)[12:159]
```

```{r}
#intersect(Tau_first$PTID,Tau_simulated$PTID)

Tau_first<-semi_join(Tau_first,Tau_simulated, by = "PTID" )

Tau_last<-semi_join(Tau_last,Tau_simulated, by = "PTID" )
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))
colnames(Prob)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-Tau_first[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob[i,]<-ee[[1]] 
}
```

```{r}
Prob_last<-as.data.frame(matrix(0,148, 2))
colnames(Prob_last)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-Tau_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob_last[i,]<-ee[[1]] 
}
```




```{r}
Prob_predicted<-as.data.frame(matrix(0,148, 2))
colnames(Prob_predicted)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-Tau_simulated[, c(1+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true <- EST$mu
sigma.true <- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob_predicted[i,]<-ee[[1]] 
}
```

```{r}
hist(Prob$`P_Tau+`,breaks = 50)
```




```{r}
plot(x=Prob_predicted$`P_Tau+`, y=Prob$`P_Tau+`, xlab="predicted tau-positive probability",ylab="observed tau-positive probability")
```
```{r}
plot(x=Prob_predicted$`P_Tau+`, y=Prob_last$`P_Tau+`, xlab="predicted tau-positive probability",ylab="observed tau-positive probability")
```






```{r}
i=11
X<-Tau_first[, c(11+i)]
#X<-Tau_simulated[, c(11+i)]
#

hist(X )



EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")

```


```{r}
i=1
#X<-Tau_first[, c(11+i)]
X<-Tau_simulated[, c(11+i)]
#

hist(X )

EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")

```


```{r}
summary(as.factor(Tau_first$DX) )
```

 

```{r}
Tau_first_EMCI<-Tau_first[which(Tau_first$DX=="EMCI"),]
Tau_simulated_EMCI<-Tau_simulated[which(Tau_first$DX=="EMCI"),]
```


$mu
[1] 1.347684 1.615994

$sigma
[1] 0.1109001 0.2738805

```{r}
Prob_EMCI<-as.data.frame(matrix(0,148, 2))
colnames(Prob)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-Tau_first_EMCI[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = c(1.347684, 1.615994), sigma = c(0.1, 0.4), k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob_EMCI[i,]<-ee[[1]] 
}

###################

Prob_predicted_EMCI<-as.data.frame(matrix(0,148, 2))
colnames(Prob_predicted)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-Tau_simulated_EMCI[, c(1+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true <- EST$mu
sigma.true <- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob_predicted_EMCI[i,]<-ee[[1]] 
}

```



```{r}
simulation_roc <- read.csv("~/Documents/2020 research/AD_MODEL/simulation_roc.csv")
View(simulation_roc)
```

```{r}
Tau_new<-simulation_roc[, c(1,2,3,152:299)]

colnames(Tau_new)[1]<-colnames(Tau_first)[1]
colnames(Tau_new)[2]<-"DX"
colnames(Tau_new)[3]<- "DX_predict"

colnames(Tau_new)[4:151]<-colnames(Tau_first)[12:159]
Tau_new$DX_predict<-as.factor(Tau_new$DX_predict)
```
 

```{r}
#df<-SIGN_Amyloid0[which(SIGN_Amyloid0$AD %in% c("CN", "AD") ),]

i=2
X<-Tau_new[,3+i]

#X<-Tau_first[,11+i]

cp_youden <- cutpointr( Tau_new, X , DX_predict ,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

cp_sen_spec <- cutpointr( Tau_new, X , DX_predict ,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)

#summ<-summary(cp_amy)

#summ$cutpointr[1]
summary(cp_youden)
summary(cp_sen_spec)
```

```{r}
plot(cp_youden)
```

```{r}
Prob_pred_roc<-as.data.frame(matrix(0,148, 2))
colnames(Prob_pred_roc)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-simulation_roc[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = c(1.347684, 1.615994), sigma = c(0.1, 0.4), k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob_pred_roc[i,]<-ee[[1]] 
}

 
```

```{r}
i=1
#X<-Tau_first[, c(11+i)]
X<-simulation_roc[, c(11+i)]
#
X<-lastscanN[, c(3)]
hist(X )



EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")

```

```{r}
lastscan <- read.csv("~/Documents/2020 research/AD_MODEL/lastscan.csv")
```


 
```{r}
Prob_last<-as.data.frame(matrix(0,148, 2))
colnames(Prob_last)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  X<-lastscan[, c(3+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob_last[i,]<-ee[[1]] 
}

View(Prob_last)
```
 
```{r}
#PP<- t(replicate(nrow(lastscan), Prob_last$`P_Tau+`))
write.csv(PP,  file = "prob_matrix.csv")
```

```{r}

lastscan$Var3 <- relevel(lastscan$Var3, ref = "CN")
summary(lastscan$Var3)
```

```{r}
67/299
```


```{r}
for (i in 1:148){
  X<-lastscan[,c(i+299)]
m1<-glm(Var3 ~ X,family = binomial, data = lastscan)
 
PP[,i]<-m1$fitted.values
}
```

```{r}
max(PP)
```



```{r}
summary(m1)
```



```{r}
#lastscan$Var3<-as.numeric(lastscan$Var3) -1

m1<-glm(Var3 ~ Var300,family = binomial, data = lastscan)
summary(m1)
newdat <- data.frame(Var300=seq(min(lastscan$Var300), max(lastscan$Var300),len=100))
newdat$Var3 = predict(m1, newdata=newdat, type="response")
plot(Var3~Var300, data=lastscan, col="red4")
lines(Var3~Var300, newdat, col="green4", lwd=2)
```
 
 
 

















 

















 
```{r}
3+148+148
```


```{r}
multmixmodel.sel(lastscan$Var300, comps = 1:4, epsilon = 0.001)
```



```{r}
data("Waterdata")
cutpts <- 10.5*(-6:6)
watermult <- makemultdata(Waterdata, cuts = cutpts)
set.seed(10)
multmixmodel.sel(watermult, comps = 1:4, epsilon = 0.001)
```

```{r}
#data(Waterdata)
df<-t(as.matrix(lastscan[,300 ]))
set.seed(100)
out <- repnormmixmodel.sel(df, k = 2, epsilon = 5e-01)
out
```

```{r}

i=61
X<-cbind(Tau_first[,i+11],Tau_last[, i+11])


df<-t(X)
set.seed(100)
out <- repnormmixmodel.sel(df, k = 2, epsilon = 5e-01)
out
```



```{r}
library(MASS)
data(galaxies)
X = galaxies / 1000
library(mclust, quietly=TRUE)
fit = Mclust(X, G=1, model="V")
summary(fit)
```


4-BIC: -446.9829	
3-BIC: -459.4196	
2-BIC: -462.523
1-BIC: -489.4892	 




```{r}
lastscan_reversed <- read.csv("~/Documents/2020 research/AD_MODEL/lastscan_reversed.csv")
```


```{r}
BIC<-data.frame(matrix(0,148,2))
colnames(BIC)<-c("one_component","two_component")
```


```{r}
for (i in 1:148){
 tryCatch({
  X=lastscanN[,i+2]
fit1 = Mclust(X, G=1, model="V")
fit2 = Mclust(X, G=2, model="V")
BIC$one_component[i]<- summary(fit1)$bic
BIC$two_component[i]<- summary(fit2)$bic 
 }
   , error=function(e) NULL)

}
 
nrow(BIC[which(BIC$two_component < BIC$one_component ),])
```




NODE1:
1-BIC: 152.4673	
2-BIC: 146.6987	


NODE2:
1-BIC: 201.2246		
2-BIC: 194.3848	


NODE3:
1-BIC: 353.6366	
2-BIC: 341.8916	



```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))
colnames(Prob)<-c("P_Tau-","P_Tau+")
for (i in 1:148){
  
   tryCatch({
  X<-lastscanN[, c(2+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 MU[i, ]<-  EST$mu
 SIGMA[i, ]<-EST$sigma
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob[i,]<-ee[[1]] 
 }
   , error=function(e) NULL)
}
```


```{r}
nrow(MU[which(MU$V1>0),])
```


```{r}
i=6
 X<-lastscanN[, c(2+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
```





```{r}
MU[14,1]<MU[14,2]
```























```{r}
i=1
#X<-Tau_first[, c(11+i)]
X<-lastscan_reversed[, c(14)]
#

hist(X )



EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")

```





```{r}
# empirical conditional prob.
# column 300 -- 447
PP_reversed<-data.frame(matrix(0, nrow(lastscan_reversed), 148))
PP <-data.frame(matrix(0, nrow(lastscan_reversed), 148))
PP_2 <-data.frame(matrix(0, nrow(lastscan_reversed), 148))
#summary(lastscan_reversed$Var3)
pAD<-67/299
pCN<-232/299
 
#lastscan_reversedN<-lastscan_reversed[, c(1,3, 300:447)]
lastscanN<-lastscan[, c(1,3, 300:447)]
View(lastscanN)
```


```{r}
for (j in 3:150){
  for (i in 1:299){
    if (lastscan_reversedN[i,2]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     PP_reversed[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] >= lastscan_reversedN[i,j] ))/67     )/ (sum(as.numeric( lastscan_reversedN[ ,j] >= lastscan_reversedN[i,j] ))/299)
    }
    else {
    PP_reversed[i,j-2]<- 1- (pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] >= lastscan_reversedN[i,j] ))/232 )/(sum(as.numeric( lastscan_reversedN[ ,j] >= lastscan_reversedN[i,j] ))/299) 
    }
  }
}
 
for (j in 3:150){
  for (i in 1:299){
    if (lastscanN[i,2]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     PP[i,j-2]<-(pAD *sum(as.numeric( lastscanN[which(lastscanN$Var3=="AD") ,j] <= lastscanN[i,j] ))/67     )/ (sum(as.numeric( lastscanN[ ,j] <= lastscanN[i,j] ))/299)
     PP_2[i,j-2]<-(pAD *sum(as.numeric( lastscanN[which(lastscanN$Var3=="AD") ,j] <= lastscanN[i,j] ))/67     )/( pAD *sum(as.numeric( lastscanN[which(lastscanN$Var3=="AD") ,j] <= lastscanN[i,j] ))/67  + pCN *sum(as.numeric( lastscanN[which(lastscanN$Var3=="CN") ,j] <= lastscanN[i,j] ))/232 )
     
    }
    else {
    PP[i,j-2]<- 1 - (pCN *sum(as.numeric( lastscanN[which(lastscanN$Var3=="CN") ,j] <= lastscanN[i,j] ))/232 )/(sum(as.numeric( lastscanN[ ,j] <= lastscanN[i,j] ))/299) 
    
    PP_2[i,j-2]<- 1 - (pCN *sum(as.numeric( lastscanN[which(lastscanN$Var3=="CN") ,j] <= lastscanN[i,j] ))/232 )/( pAD *sum(as.numeric( lastscanN[which(lastscanN$Var3=="AD") ,j] <= lastscanN[i,j] ))/67  + pCN *sum(as.numeric( lastscanN[which(lastscanN$Var3=="CN") ,j] <= lastscanN[i,j] ))/232 )
    }
  }
}



```


```{r}
plot(x=PP$X1, y=PP_2$X1)
```




```{r}
apply(PP,2,max)

sum(as.numeric(PPP$X2>=0.5))/(299)


```



```{r}
i=175;j=3
  (pAD *sum(as.numeric( lastscanN[which(lastscanN$Var3== "AD") ,j] <= lastscanN[i,j] ))/67 )/(sum(as.numeric( lastscanN[ ,j] <= lastscanN[i,j] ))/299)
#sum(as.numeric( lastscanN[which(lastscanN$Var3== 0) ,j] <= lastscanN[i,j] ))
#sum(as.numeric( lastscanN[ ,j] <= lastscanN[i,j] ))
pAD
sum(as.numeric( lastscanN[which(lastscanN$Var3== "AD") ,j] <= lastscanN[i,j] ))/67
sum(as.numeric( lastscanN[ ,j] <= lastscanN[i,j] ))/299
#sum(as.numeric( lastscanN[which(lastscanN$Var3== 0) ,j] <= lastscanN[i,j] )
```


```{r}
 apply(PP[,c(4:151)], 2, max)  
```

```{r}
PP<-cbind(lastscan_com[,c(1:3)], PP)
```


```{r}
i=3
sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,i] <= lastscan_reversedN[14,i] ))
sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,i] <= lastscan_reversedN[14,i] ))

sum(as.numeric( lastscan_reversedAD[ ,i] <= lastscan_reversedAD[1,i] ))
sum(as.numeric( lastscan_reversedCN[ ,i] <= lastscan_reversedCN[1,i] ))

```



```{r}
lastscan_reversedAD<-lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,]
lastscan_reversedCN<-lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,]
```

 

```{r}
colmax<-c(0)
for (i in 1:148){
colmax[i]<-  max(PP[,i])
 
}
colmax
```


```{r}
write.csv(PP,  file = "prob_matrix.csv")
```

```{r}
nrow(BIC[which(BIC$two_component > BIC$one_component ),])
```

```{r}
MU[1,]
SIGMA[1,]
```

```{r}
lastscanN_AD<-lastscanN[ which(lastscanN$Var3 == "AD" ) ,]
meanAD<-mean(lastscanN_AD$Var301)
sdAD<-sd(lastscanN_AD$Var301)
lastscanN_CN<-lastscanN[ which(lastscanN$Var3 == "CN" ) ,]
meanCN<-mean(lastscanN_CN$Var301)
sdCN<-sd(lastscanN_CN$Var301)
```

```{r}
i=2
#X<-Tau_first[, c(11+i)]
#X<-lastscanN_AD[, c(3)]
#Y<-lastscanN_CN[, c(3)]
#
 

 X<-lastscanN[, c(2+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)

  mu.true<- EST$mu
sigma.true<- EST$sigma
  EST$mu
  EST$sigma
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
ee[[1]] 
```


```{r}
PPP<-data.frame(matrix(0, 299, 148))

PPP<-cbind(lastscanN[, c(1,2)],PPP)
```

```{r}
 
for (i in 1:299){
  
  if (lastscanN$Var3[i]=="AD"  ){
PPP[i, 3]  <-  pnorm(lastscanN$Var300[i], mean = mean(X), sd = sd(X), lower.tail = TRUE)

  }
else {
 PPP[i, 3]  <- 1 - pnorm(lastscanN$Var300[i], mean =  mean(Y), sd = sd(Y), lower.tail = TRUE)
}
  
}
```

```{r}
plot(PPP$X1)
plot(PP_reversed$X1)
```


```{r}
i=1
#X<-Tau_first[, c(11+i)]
#X<-lastscanN_AD[, c(3)]
#Y<-lastscanN_CN[, c(3)]
#
 

 X<-lastscan_reversedN[, c(2+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)

  mu.true<- EST$mu
sigma.true<- EST$sigma
  EST$mu
  EST$sigma
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
ee[[1]] 
#plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")
```


```{r}
#for (j in 3:150){
j=4
  for (i in 1:299){
    if (lastscanN[i,2]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     PPP[i,j]<-  (0.1182856 *pnorm(lastscanN$Var300[i], mean = 0.4176295, sd = 0.06164022, lower.tail = TRUE) )/(0.1182856 *pnorm(lastscanN$Var300[i], mean = 0.4176295, sd = 0.06164022, lower.tail = TRUE) +  0.8817144*pnorm(lastscanN$Var300[i], mean = 0.7111873, sd = 0.14801895, lower.tail = TRUE))  
    }
    else {
    PPP[i,j]<- 1- (0.8817144*pnorm(lastscanN$Var300[i], mean = 0.7111873, sd = 0.14801895, lower.tail = TRUE) )/ (0.1182856 *pnorm(lastscanN$Var300[i], mean = 0.4176295, sd = 0.06164022, lower.tail = TRUE) +  0.8817144*pnorm(lastscanN$Var300[i], mean = 0.7111873, sd = 0.14801895, lower.tail = TRUE)) 
    }
  }
#}

```



```{r}
plot(PPP$X2)
plot(PP$X2) 
``` 


```{r}
plot(x=lastscanN[which(lastscanN$Var3=="AD"),4 ],y=PPP[which(PPP$Var3=="AD"),4])
plot(x=lastscanN[which(lastscanN$Var3=="CN"),4 ],y=PPP[which(PPP$Var3=="CN"),4])

mm<-cbind(lastscanN[, c(2,4)],PPP[, c(4)] )
colnames(mm)<-c("DX", "N", "prob")

 
ggplot(mm, aes(x=N, y=prob,col=DX))+geom_point()
```


```{r}
mm<-cbind(lastscanN[, c(2,4)],PP[, c(4)] )
colnames(mm)<-c("DX", "N", "prob")

ggplot(mm, aes(x=N, y=prob,col=DX))+geom_point()
```


```{r}
c<-seq(0,max(lastscanN_AD$Var301),0.01)
lastscanN_AD<-lastscanN[ which(lastscanN$Var3 == "AD" ) ,]
meanAD<-mean(lastscanN_AD$Var301)
sdAD<-sd(lastscanN_AD$Var301)
lastscanN_CN<-lastscanN[ which(lastscanN$Var3 == "CN" ) ,]
meanCN<-mean(lastscanN_CN$Var301)
sdCN<-sd(lastscanN_CN$Var301)

```

[1] 0.7111873 0.4176295
[1] 0.14801895 0.06164022


```{r}
 
ADc <- dnorm(c, mean=meanAD, sd= sdAD)
CNc<-dnorm(c, mean=meanCN, sd= sdCN)
ADx_PP <- dnorm(c, mean=0.4176295, sd= 0.06164022)
CNx_PP <- dnorm(c, mean=0.7111873, sd= 0.14801895)

degf <- c(1, 3, 8, 30)
colors <- c("red", "blue", "darkgreen", "gold", "black")
labels <- c("df=1", "df=3", "df=8", "df=30", "normal")

plot(c, ADc, type="l", lty=2, xlab="x value",
  ylab="Density", main="Comparison of NORMAL Distributions",ylim = c(0,7))
lines(c, ADx_PP, lwd=2, col="red")
lines(c, CNx_PP, lwd=2, col="blue")
lines(c, CNc, lwd=2, col="green")
```

```{r}
i=4
#X<-Tau_first[, c(11+i)]
#X<-simulation_roc[, c(11+i)]
#
X<-lastscanN[, c(2+i)]
hist(X )



EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")
EST$loglik
```


```{r}


for (j in 3:150){

  for (i in 1:299){
    if (lastscanN[i,2]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     PPP[i,j]<-  (0.1182856 *pnorm(lastscanN$Var300[i], mean = 0.4176295, sd = 0.06164022, lower.tail = TRUE) )/(0.1182856 *pnorm(lastscanN$Var300[i], mean = 0.4176295, sd = 0.06164022, lower.tail = TRUE) +  0.8817144*pnorm(lastscanN$Var300[i], mean = 0.7111873, sd = 0.14801895, lower.tail = TRUE))  
    }
    else {
    PPP[i,j]<- 1- (0.8817144*pnorm(lastscanN$Var300[i], mean = 0.7111873, sd = 0.14801895, lower.tail = TRUE) )/ (0.1182856 *pnorm(lastscanN$Var300[i], mean = 0.4176295, sd = 0.06164022, lower.tail = TRUE) +  0.8817144*pnorm(lastscanN$Var300[i], mean = 0.7111873, sd = 0.14801895, lower.tail = TRUE)) 
    }
  }
}

```

 
```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info<-as.data.frame(matrix(0,148, 6))
colnames(Info)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-lastscan_reversedN[, c(2+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info[i,c(1,2) ]<-  EST$mu
 Info[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```
 
```{r}
nrow(Info[which(Info$mu1 <Info$mu2 ),])
```
 
 
 
 
```{r}

i=130
X<-lastscan_reversedN[, c(2+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 MU[i, ]<-  EST$mu
 SIGMA[i, ]<-EST$sigma
   EST$mu
  EST$sigma
  EST$loglik
  Info[i,]
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob[i,]<-ee[[1]] 
ee[[1]] 
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Tau")
 
```

```{r}
mean(lastscan_reversedN$Var303)
```



```{r}
i=130

hist(lastscan_reversedAD[, c(2+i)],breaks = 10); mean(lastscan_reversedAD[, c(2+i)])
hist(lastscan_reversedCN[, c(2+i)],breaks = 10); mean(lastscan_reversedCN[, c(2+i)])
```

```{r}
library(MASS)

i=7
X<-unlist(lastscan_reversedN[, c(2+i)])

library(fitdistrplus)
FIT <- fitdist(X, "norm")    ## note: it is "norm" not "normal"
FIT
class(FIT)
# [1] "fitdist"

plot(FIT)    ## use method `plot.fitdist`

hist(X, breaks = 100)
```

```{r}

```





```{r}
colnames(lastscan_re_aic)[2:149]<-colnames(Tau_first)[12:159]
```


```{r}
apply(lastscan_reversedN, 2, min)
```

```{r}
#lastscan_reversedN<-lastscan_reversedN[-c(71),]
```

 
```{r}
PPP<-data.frame(matrix(0, nrow(lastscan_reversedN), 148))
PPP<-cbind(lastscan_reversedN[,c(1,2)],PPP )
 for (j in 3:150){
  for (i in 1:nrow(lastscan_reversedN)){
    if (lastscan_reversedN[i,2]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     PPP[i,j]<-  (Info$P2[j-2] *pnorm(lastscan_reversedN[i,j], mean = Info$mu2[j-2], sd = Info$sigma2[j-2], lower.tail = TRUE)    )/ (Info$P2[j-2]*pnorm(lastscan_reversedN[i,j], mean = Info$mu2[j-2], sd = Info$sigma2[j-2], lower.tail = TRUE) +  Info$P1[j-2]*pnorm(lastscan_reversedN[i,j], mean = Info$mu1[j-2], sd = Info$sigma1[j-2], lower.tail = TRUE))  
    }
    else {
    PPP[i,j]<- 1- (Info$P1[j-2]*pnorm(lastscan_reversedN[i,j], mean = Info$mu1[j-2], sd = Info$sigma1[j-2], lower.tail = TRUE) )/ (Info$P1[j-2]*pnorm(lastscan_reversedN[i,j], mean = Info$mu1[j-2], sd = Info$sigma1[j-2], lower.tail = TRUE) +  Info$P2[j-2]*pnorm(lastscan_reversedN[i,j], mean = Info$mu2[j-2], sd = Info$sigma2[j-2], lower.tail = TRUE)) 
    }
  }
 }

```

```{r}
colnames(PPP)[3:150]<-colnames(Tau_first)[12:159]
```

```{r}
write.csv(PPP,  file = "Positive_prob_matrix_reversed.csv")
```


```{r}
Matt01<-data.frame(matrix(0, nrow(lastscan_reversedN), 148))

for (j in 1:148){
df<-lastscan_reversedN[,c(2,2+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01[,j]<- as.numeric(lastscan_reversedN[,c(2+j)]>cutpoint)
}
```

```{r}
Matt01<-cbind(lastscan_reversedN[, c(1,2)], Matt01)


write.csv(Matt01,  file = "Matrix_01.csv")
```

```{r}
summary(cp)
```


```{r}
summary(lastscan_reversedN$Var3)
```


```{r}
colnames(lastscan_reversedN)[1]<-"PTID"
FDG_first<-semi_join(FDG_SUVR, lastscan_reversedN, by= "PTID")
```

```{r}
TABLE<-data.frame(table(FDG_first$PTID))
TABLE<- TABLE[which(TABLE$Freq>2),]
```

```{r}
ptInfo_321 <- read.csv("~/Documents/2020 research/AD_MODEL/ptInfo_321.csv")

 
FDG_first<-semi_join(FDG_SUVR, ptInfo_321, by= "PTID")
TABLE<-data.frame(table(FDG_first$PTID))
```

```{r}
FDG_1<-as.data.frame(matrix(0, nrow(TABLE), ncol(FDG_first)) )
FDG_2<-as.data.frame(matrix(0, nrow(TABLE), ncol(FDG_first)) )
for (i in 1:nrow(TABLE)){
  FDG_1[i, ]<-FDG_first[min(which(FDG_first$PTID == TABLE$Var1[i] ) ),]
  FDG_2[i, ]<-FDG_first[max(which(FDG_first$PTID == TABLE$Var1[i] ) ),]
}
colnames(FDG_1)<-colnames(FDG_first)
colnames(FDG_2)<-colnames(FDG_first)
```

```{r}
max(apply(FDG_1[, c(12:159)], 2, max))
```

```{r}
FDG_2[, c(12:159)]  <-max(apply(FDG_1[, c(12:159)], 2, max)) - FDG_2[, c(12:159)]
```

 
```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info<-as.data.frame(matrix(0,148, 6))
colnames(Info)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-FDG_2[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info[i,c(1,2) ]<-  EST$mu
 Info[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
i=7
X<-FDG_2[, c(11+i)]
hist(X, breaks = 50)
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info[i,c(1,2) ]<-  EST$mu
 Info[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info[i,c(5,6)]<-ee[[1]]
```



```{r}
PPP<-data.frame(matrix(0, nrow(FDG_2), 148))
PPP<-cbind(FDG_2[,c(1:11)],PPP )
 for (j in 12:159){
  for (i in 1:nrow(FDG_2)){
    if (FDG_2$DX[i]=="AD" && Info$mu1[j-11]>0 ){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     PPP[i,j]<-  (Info$P2[j-11] *pnorm(FDG_2[i,j], mean = Info$mu2[j-11], sd = Info$sigma2[j-11], lower.tail = TRUE)    )/ (Info$P2[j-11]*pnorm(FDG_2[i,j], mean = Info$mu2[j-11], sd = Info$sigma2[j-11], lower.tail = TRUE) +  Info$P1[j-11]*pnorm(FDG_2[i,j], mean = Info$mu1[j-11], sd = Info$sigma1[j-11], lower.tail = TRUE))  
    }
    else {
    PPP[i,j]<- 1- (Info$P1[j-11]*pnorm(FDG_2[i,j], mean = Info$mu1[j-11], sd = Info$sigma1[j-11], lower.tail = TRUE) )/ (Info$P1[j-11]*pnorm(FDG_2[i,j], mean = Info$mu1[j-11], sd = Info$sigma1[j-11], lower.tail = TRUE) +  Info$P2[j-11]*pnorm(FDG_2[i,j], mean = Info$mu2[j-11], sd = Info$sigma2[j-11], lower.tail = TRUE)) 
    }
  }
 }

```


```{r}

FDG_2$DX<-ptInfo_321$Var3
Matt01<-data.frame(matrix(0, nrow(FDG_2), 148))

for (j in 1:148){
  
df<-FDG_2[, c(4, 11+j)] 
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

 cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
 Matt01[,j]<- as.numeric(FDG_2[,c(11+j)]>cutpoint)
}
 
 Matt01<-cbind(ptInfo_321[, c(1,2)], Matt01)


 write.csv(Matt01,  file = "Matrix_0118.csv")
```

```{r}
j=1
df<-FDG_2[, c(4, 11+j)] 
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = oc_youden_normal, metric = youden)
summary(cp)

 cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
as.numeric(FDG_2[,c(11+j)]<cutpoint)
summary(as.factor(df$DX))
```



```{r}
j=148
df<-FDG_2[, c(4, 11+j)] 
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

summary(cp)
```



```{r}
non_index<-which(Info$mu1==0)
summary(FDG_2$DX)
```


```{r}
pCN<-242/321
pAD<-79/321

for (j in non_index){
  for (i in 1:nrow(FDG_2)){
    if (FDG_2[i,4]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
   #  PP[i,j+11]<-(pAD *sum(as.numeric( FDG_2[which(FDG_2$Var3=="AD") ,j] <= FDG_2[i,j] ))/79     )/ (sum(as.numeric( FDG_2[ ,j] <= FDG_2[i,j] ))/299)
     PPP[i,j+11]<-(pAD *sum(as.numeric( FDG_2[which(FDG_2$DX=="AD") ,j+11] <= FDG_2[i,j+11] ))/79     )/( pAD *sum(as.numeric( FDG_2[which(FDG_2$Var3=="AD") ,j+11] <= FDG_2[i,j+11] ))/79  + pCN *sum(as.numeric( FDG_2[which(FDG_2$DX=="CN") ,j+11] <= FDG_2[i,j+11] ))/242 )
     
    }
    else {
#    PP[i,j-2]<- 1 - (pCN *sum(as.numeric( FDG_2[which(FDG_2$Var3=="CN") ,j] <= FDG_2[i,j] ))/232 )/(sum(as.numeric( FDG_2[ ,j] <= FDG_2[i,j] ))/299) 
    
    PPP[i,j+11]<- 1 - (pCN *sum(as.numeric( FDG_2[which(FDG_2$DX=="CN") ,j+11] <= FDG_2[i,j+11] ))/242 )/( pAD *sum(as.numeric( FDG_2[which(FDG_2$DX=="AD") ,j+11] <= FDG_2[i,j+11] ))/79  + pCN *sum(as.numeric( FDG_2[which(FDG_2$DX=="CN") ,j+11] <= FDG_2[i,j+11] ))/242 )
    }
  }
}
```

```{r}
colnames(PPP)<-colnames(FDG_2)
write.csv(PPP,  file = "Pos_Prob_Matrix_0118.csv")
```


```{r}
max(apply(FDG_1[, c(12:159)], 2, max))
 
FDG_1[, c(12:159)]  <-max(apply(FDG_1[, c(12:159)], 2, max)) - FDG_1[, c(12:159)]
```
 



```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info1<-as.data.frame(matrix(0,148, 6))
colnames(Info1)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-FDG_1[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info1[i,c(1,2) ]<-  EST$mu
 Info1[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info1[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```



```{r}
plot(x=Info1$P2, y=Info$P2, xlab="Tau positive Prob (firstscan)", ylab="Tau positive Prob (lastscan)")
```

```{r}
# Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
Amy<-semi_join(Amyloid_SUVR, ptInfo_321, by="PTID")


TABLE<-data.frame(table(Amy$PTID))
# TABLE<- TABLE[which(TABLE$Freq>1),]
 
 
Amy_first<- as.data.frame(matrix(0,nrow(TABLE), ncol(Amyloid_SUVR)))
Amy_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(Amyloid_SUVR)))
for (i in 1:nrow(TABLE)){
Amy_first[i,] <- Amyloid_SUVR[min(which(Amyloid_SUVR$PTID == TABLE$Var1[i])), ]

Amy_last[i,] <- Amyloid_SUVR[max(which(Amyloid_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(Amy_first) <- colnames(Amyloid_SUVR)
colnames(Amy_last) <- colnames(Amyloid_SUVR)
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info1<-as.data.frame(matrix(0,148, 6))
colnames(Info1)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-Amy_first[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info1[i,c(1,2) ]<-  EST$mu
 Info1[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info1[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-Amy_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
plot(x=Info1$P2, y=Info2$P2, xlab="Amy positive Prob (firstscan)", ylab="Amy positive Prob (lastscan)")
```





```{r}
PPP<-data.frame(matrix(0, nrow(Amy_first), 148))
P_A_first<-cbind(Amy_first[,c(1:11)],PPP )
 for (j in 12:159){
  for (i in 1:nrow(Amy_first)){
    if (Amy_first$DX[i]=="AD" && Info$mu1[j-11]>0 ){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_A_first[i,j]<-  (Info$P2[j-11] *pnorm(Amy_first[i,j], mean = Info$mu2[j-11], sd = Info$sigma2[j-11], lower.tail = TRUE)    )/ (Info$P2[j-11]*pnorm(Amy_first[i,j], mean = Info$mu2[j-11], sd = Info$sigma2[j-11], lower.tail = TRUE) +  Info$P1[j-11]*pnorm(Amy_first[i,j], mean = Info$mu1[j-11], sd = Info$sigma1[j-11], lower.tail = TRUE))  
    }
    else {
    P_A_first[i,j]<- 1- (Info$P1[j-11]*pnorm(Amy_first[i,j], mean = Info$mu1[j-11], sd = Info$sigma1[j-11], lower.tail = TRUE) )/ (Info$P1[j-11]*pnorm(Amy_first[i,j], mean = Info$mu1[j-11], sd = Info$sigma1[j-11], lower.tail = TRUE) +  Info$P2[j-11]*pnorm(Amy_first[i,j], mean = Info$mu2[j-11], sd = Info$sigma2[j-11], lower.tail = TRUE)) 
    }
  }
 }

```

 

```{r}
AIC1<-data.frame(matrix(0,148,2))
for (i in 1:148){
X=Amy_first[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC1[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC1[i,2]<-summary(fit2)$bic
}
 
length(which(AIC1[,1] > AIC1[,2]))
 
 
AIC2<-data.frame(matrix(0,148,2))
for (i in 1:148){
X=Amy_last[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC2[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC2[i,2]<-summary(fit2)$bic
}
 
length(which(AIC2[,1] > AIC2[,2]))
```

```{r}
index_amy<-intersect(which(AIC1[,1] < AIC1[,2]), which(AIC2[,1] < AIC2[,2]))
```




```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info1<-as.data.frame(matrix(0,148, 6))
colnames(Info1)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1: 148){
  
   tryCatch({
  X<-Amy_first[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info1[i,c(1,2) ]<-  EST$mu
 Info1[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info1[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-Amy_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```

```{r}
 

Info1[which(Info1$mu1  > Info1$mu2), ]<- Info1[which(Info1$mu1  > Info1$mu2), c(2,1,4,3,6,5)]

Info2[which(Info2$mu1  > Info2$mu2), ]<- Info2[which(Info2$mu1  > Info2$mu2), c(2,1,4,3,6,5)]
  

```



```{r}
plot(x=Info1[ ,6], y=Info2[ , 6], xlab="Amy positive Prob (firstscan)", ylab="Amy positive Prob (lastscan)")
```

```{r}
PPP<-data.frame(matrix(0, nrow(Amy_last), 148))
P_A_last<-cbind(Amy_last[,c(1:11)],PPP )
 for (j in 12:159){
  for (i in 1:nrow(Amy_last)){
    if (Amy_last$DX[i]=="AD" ){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_A_last[i,j]<-  (Info2$P2[j-11] *pnorm(Amy_last[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE) )/ (Info2$P2[j-11]*pnorm(Amy_last[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE) +  Info2$P1[j-11]*pnorm(Amy_last[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE))  
    }
    else {
    P_A_last[i,j]<- 1- (Info2$P1[j-11]*pnorm(Amy_last[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE) )/ (Info2$P1[j-11]*pnorm(Amy_last[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE) +  Info2$P2[j-11]*pnorm(Amy_last[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE)) 
    }
  }
 }

```

```{r}

for (i in 1:nrow(Amy_last)){
  if (Amy_last[i,4]=="LMCI"  )  {
    Amy_last[i,4]="AD"
  }
  else if (Amy_last[i,4]=="EMCI") {
    Amy_last[i,4]="CN"
  }
   else if (Amy_last[i,4]=="SMC") {
    Amy_last[i,4]="CN"
   }
  
}
summary(as.factor(Amy_last[,4]))

```

```{r}
# change fill and outline color manually 
ggplot(P_A_last, aes(x = X11)) +
  geom_histogram(aes(color = DX, fill = DX), 
                position = "identity", bins = 30, alpha = 0.4) +
  labs(x="Amyloid: node 11")+
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

```{r}
write.csv(P_A_last,  file = "Positive_P_Mat_Amy.csv")
```








```{r}
Info1<-cbind(Info1, Info1$P2)
colnames(Info1)[7]<-"P_pos"

Info2<-cbind(Info2, Info2$P2)
colnames(Info2)[7]<-"P_pos"

```


```{r}
for (i in index_tau){
  if ( Info1$mu1[i]< Info1$mu2[i]  ){
    Info1$P_pos[i]<-Info1$P2[i]
  }
  else {
     Info1$P_pos[i]<-Info1$P1[i]
  }
  
}

for (i in index_tau){
  if ( Info2$mu1[i]< Info2$mu2[i]  ){
    Info2$P_pos[i]<-Info2$P2[i]
  }
  else {
     Info2$P_pos[i]<-Info2$P1[i]
  }
  
}

```



```{r}
i=1
X<-cbind(Amy_first[,i+11],Amy_last[, i+11])


df<-t(X)
set.seed(100)
out <- repnormmixmodel.sel(df, k = 2, epsilon = 5e-01)

```

```{r}
View(P_A_first)
```



```{r}

i=1
X<-Amy_first[, c(11+i)]
  hist(X)
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 MU[i, ]<-  EST$mu
 SIGMA[i, ]<-EST$sigma
   EST$mu
  EST$sigma
  EST$loglik
  Info[i,]
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Prob[i,]<-ee[[1]] 
ee[[1]] 
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="Amy_NODE1")
 
```

## FDG

```{r}
TABLE<-data.frame(table(FDG_SUVR$PTID))
TABLE<- TABLE[which(TABLE$Freq>1),]
FDG_1<-as.data.frame(matrix(0, nrow(TABLE), ncol(FDG_SUVR)) )
FDG_2<-as.data.frame(matrix(0, nrow(TABLE), ncol(FDG_SUVR)) )
for (i in 1:nrow(TABLE)){
  FDG_1[i, ]<-FDG_SUVR[min(which(FDG_SUVR$PTID == TABLE$Var1[i] ) ),]
  FDG_2[i, ]<-FDG_SUVR[max(which(FDG_SUVR$PTID == TABLE$Var1[i] ) ),]
}
colnames(FDG_1)<-colnames(FDG_SUVR)
colnames(FDG_2)<-colnames(FDG_SUVR)
```

```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info1<-as.data.frame(matrix(0,148, 6))
colnames(Info1)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-FDG_1[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info1[i,c(1,2) ]<-  EST$mu
 Info1[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info1[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-FDG_2[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
plot(x=Info1$P2, y=Info2$P2, xlab="FDG positive Prob (firstscan)", ylab="FDG positive Prob (lastscan)")
```

```{r}
AIC<-data.frame(matrix(0,148,2))
for (i in 1:148){
 tryCatch({
  X=FDG_1[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC[i,2]<-summary(fit2)$bic
 }
   , error=function(e) NULL)

}
 
length(which(AIC[,1] < AIC[,2]))
```



```{r}
AIC2<-data.frame(matrix(0,148,2))
for (i in 1:148){
 tryCatch({
  X=FDG_2[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC2[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC2[i,2]<-summary(fit2)$bic
 }
   , error=function(e) NULL)

}
 
length(which(AIC2[,1] < AIC2[,2]))
```

```{r}
index_fdg<-intersect(which(AIC[,1] < AIC[,2]), which(AIC2[,1] < AIC2[,2]))
```




```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info1<-as.data.frame(matrix(0,148, 6))
colnames(Info1)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in index_fdg){
  
   tryCatch({
  X<-FDG_1[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info1[i,c(1,2) ]<-  EST$mu
 Info1[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info1[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in index_fdg){
  
   tryCatch({
  X<-FDG_2[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
 

Info1[which(Info1$mu1  > Info1$mu2), ]<- Info1[which(Info1$mu1  > Info1$mu2), c(2,1,4,3,6,5)]

Info2[which(Info2$mu1  > Info2$mu2), ]<- Info2[which(Info2$mu1  > Info2$mu2), c(2,1,4,3,6,5)]
  

``` 


```{r}
index_fdg<-intersect(which(Info1[,1] >0  ), which(Info2[,1] > 0 ))
```

```{r}
plot(x=Info1[index_fdg,6], y=Info2[index_fdg, 6], xlab="Tau positive Prob (firstscan)", ylab="Tau positive Prob (lastscan)")
```

```{r}

for (i in 1:nrow(FDG_2)){
  if (FDG_2[i,4]=="LMCI"  )  {
    FDG_2[i,4]="AD"
  }
  else if (FDG_2[i,4]=="EMCI") {
    FDG_2[i,4]="CN"
  }
   else if (FDG_2[i,4]=="SMC") {
    FDG_2[i,4]="CN"
   }
  else if (FDG_2[i,4]=="MCI") {
    FDG_2[i,4]="CN"
  }
}
summary(as.factor(FDG_2[,4]))

```

```{r}
PPP<-data.frame(matrix(0, nrow(FDG_2), 148))
P_N_last<-cbind(FDG_2[,c(1:11)],PPP )
 for (j in 12:159){
  for (i in 1:nrow(FDG_2)){
    if (FDG_2$DX[i]=="AD" ){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_N_last[i,j]<-  (Info2$P2[j-11] *pnorm(FDG_2[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE) )/ (Info2$P2[j-11]*pnorm(FDG_2[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE) +  Info2$P1[j-11]*pnorm(FDG_2[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE))  
    }
    else {
    P_N_last[i,j]<- 1- (Info2$P1[j-11]*pnorm(FDG_2[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE) )/ (Info2$P1[j-11]*pnorm(FDG_2[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE) +  Info2$P2[j-11]*pnorm(FDG_2[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE)) 
    }
  }
 }

```



```{r}
# change fill and outline color manually 
ggplot(P_N_last, aes(x = X34)) +
  geom_histogram(aes(color = DX, fill = DX), 
                position = "identity", bins = 30, alpha = 0.4) +
  labs(x="N: node 34")+
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```
 
 

## Tau 

```{r}
Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
Tau<-semi_join(Tau_SUVR, ptInfo_321, by="PTID")


TABLE<-data.frame(table(Tau$PTID))
#TABLE<- TABLE[which(TABLE$Freq>1),]

Tau_1<-as.data.frame(matrix(0, nrow(TABLE), ncol(Tau_SUVR)) )
Tau_2<-as.data.frame(matrix(0, nrow(TABLE), ncol(Tau_SUVR)) )
for (i in 1:nrow(TABLE)){
  Tau_1[i, ]<-Tau_SUVR[min(which(Tau_SUVR$PTID == TABLE$Var1[i] ) ),]
  Tau_2[i, ]<-Tau_SUVR[max(which(Tau_SUVR$PTID == TABLE$Var1[i] ) ),]
}
colnames(Tau_1)<-colnames(Tau_SUVR)
colnames(Tau_2)<-colnames(Tau_SUVR)


summary(as.factor(Tau_1$DX) )
#Tau_1<- na.omit(Tau_1, cols=c("DX"))
#Tau_2<- na.omit(Tau_2, cols=c("DX"))
#Tau_1<-Tau_1[-c(89,90),]
#Tau_2<-Tau_2[-c(89,90),]
```

```{r}
AIC1<-data.frame(matrix(0,148,2))
for (i in 1:148){
 tryCatch({
  X=Tau_1[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC1[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC1[i,2]<-summary(fit2)$bic
 }
   , error=function(e) NULL)

}
 
length(which(AIC1[,1] > AIC1[,2]))
```



```{r}
AIC2<-data.frame(matrix(0,148,2))
for (i in 1:148){
 tryCatch({
  X=Tau_2[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC2[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC2[i,2]<-summary(fit2)$bic
 }
   , error=function(e) NULL)

}
 
length(which(AIC2[,1] > AIC2[,2]))
```

```{r}
index_tau<-intersect(which(AIC[,1] > AIC[,2]), which(AIC2[,1] > AIC2[,2]))
```




```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info1<-as.data.frame(matrix(0,148, 6))
colnames(Info1)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-Tau_1[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info1[i,c(1,2) ]<-  EST$mu
 Info1[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info1[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-Tau_2[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```

```{r}
 

Info1[which(Info1$mu1  > Info1$mu2), ]<- Info1[which(Info1$mu1  > Info1$mu2), c(2,1,4,3,6,5)]

Info2[which(Info2$mu1  > Info2$mu2), ]<- Info2[which(Info2$mu1  > Info2$mu2), c(2,1,4,3,6,5)]
  

``` 


```{r}
index_tau<-intersect(which(Info1[,1] >0  ), which(Info2[,1] > 0 ))
```

```{r}
plot(x=Info1[index_tau,6], y=Info2[index_tau, 6], xlab="Tau positive Prob (firstscan)", ylab="Tau positive Prob (lastscan)")
```

```{r}

for (i in 1:nrow(Tau_2)){
  if (Tau_2[i,4]=="LMCI"  )  {
    Tau_2[i,4]="AD"
  }
  else if (Tau_2[i,4]=="EMCI") {
    Tau_2[i,4]="CN"
  }
   else if (Tau_2[i,4]=="SMC") {
    Tau_2[i,4]="CN"
   }
}
summary(as.factor(Tau_2[,4]))

```

```{r}
PPP<-data.frame(matrix(0, nrow(Tau_2), 148))
P_T_last<-cbind(Tau_2[,c(1:11)],PPP )
 for (j in 12:159){
  for (i in 1:nrow(Tau_2)){
    if (Tau_2$DX[i]=="AD" ){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_T_last[i,j]<-  (Info2$P2[j-11] *pnorm(Tau_2[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE) )/ (Info2$P2[j-11]*pnorm(Tau_2[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE) +  Info2$P1[j-11]*pnorm(Tau_2[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE))  
    }
    else {
    P_T_last[i,j]<- 1- (Info2$P1[j-11]*pnorm(Tau_2[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE) )/ (Info2$P1[j-11]*pnorm(Tau_2[i,j], mean = Info2$mu1[j-11], sd = Info2$sigma1[j-11], lower.tail = TRUE) +  Info2$P2[j-11]*pnorm(Tau_2[i,j], mean = Info2$mu2[j-11], sd = Info2$sigma2[j-11], lower.tail = TRUE)) 
    }
  }
 }

```



```{r}
# change fill and outline color manually 
ggplot(P_T_last, aes(x = X101)) +
  geom_histogram(aes(color = DX, fill = DX), 
                position = "identity", bins = 30, alpha = 0.4) +
  labs(x="Tau: node 101")+
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

```{r}
write.csv(P_T_last,  file = "Positive_P_Mat_Tau.csv")
``` 

## 01/24

```{r}
simulation_0124 <- read.csv("~/Documents/2020 research/AD_MODEL/simulation_0124.csv")
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

## simulation_0124 --> Info3
Info3<-as.data.frame(matrix(0,148, 6))
colnames(Info3)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-simulation_0124[, c(3+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info3[i,c(1,2) ]<-  EST$mu
 Info3[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info3[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)

}

Info3[which(Info3$mu1  > Info3$mu2), ]<- Info3[which(Info3$mu1  > Info3$mu2), c(2,1,4,3,6,5)]


```


```{r}
plot(y=Info3[ ,6], x=Info2[ , 6], xlab="Amy positive Prob (lastscan)", ylab="Amy positive Prob (simulated)")
```


```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info3<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-simulation_0124[, c(151+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info3[i,c(1,2) ]<-  EST$mu
 Info3[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info3[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
```

```{r}
Info3[which(Info3$mu1  > Info3$mu2), ]<- Info3[which(Info3$mu1  > Info3$mu2), c(2,1,4,3,6,5)]

```


```{r}
plot(y=Info3[ ,6], x=Info2[ , 6], xlab="Tau positive Prob (lastscan)", ylab="Tau positive Prob (simulated)")
```

### amyloid roc 0/1

```{r}
# Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
Amy<-semi_join(Amyloid_SUVR, ptInfo_321, by="PTID")


summary(as.factor(Amy$DX))

```

```{r}

for (i in 1:nrow(Amy)){
  if (Amy[i,4]=="LMCI"  )  {
    Amy[i,4]="AD"
  }
  else if (Amy[i,4]=="EMCI") {
    Amy[i,4]="CN"
  }
   else if (Amy[i,4]=="SMC") {
    Amy[i,4]="CN"
   }
  
}
summary(as.factor(Amy$DX))

```

```{r}

TABLE<-data.frame(table(Amy$PTID))
# TABLE<- TABLE[which(TABLE$Freq>1),]
 
 
Amy_first<- as.data.frame(matrix(0,nrow(TABLE), ncol(Amy)))
Amy_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(Amy)))
for (i in 1:nrow(TABLE)){
Amy_first[i,] <- Amy[min(which(Amy$PTID == TABLE$Var1[i])), ]

Amy_last[i,] <- Amy[max(which(Amy$PTID == TABLE$Var1[i])), ]

}
colnames(Amy_first) <- colnames(Amy)
colnames(Amy_last) <- colnames(Amy)
```

```{r}

summary(as.factor(Amy_first$DX))
summary(as.factor(Amy_last$DX))

```

```{r}
Matt01_amyloid_first<-data.frame(matrix(0, nrow(Amy_first), 148))

for (j in 1:148){
df<-Amy_first[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01_amyloid_first[,j]<- as.numeric(Amy_first[,c(11+j)]>cutpoint)
}
```

 
```{r}
Matt01_amyloid_last<-data.frame(matrix(0, nrow(Amy_last), 148))

for (j in 1:148){
df<-Amy_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01_amyloid_last[,j]<- as.numeric(Amy_last[,c(11+j)]>cutpoint)
}
```
 



### Tau roc 0/1

```{r}
 Tau<-semi_join(Tau_SUVR, ptInfo_321, by="PTID")


summary(as.factor(Tau$DX))

```

```{r}
for (i in 1:nrow(Tau)){
  if (Tau[i,4]=="LMCI"  )  {
    Tau[i,4]="AD"
  }
  else if (Tau[i,4]=="EMCI") {
    Tau[i,4]="CN"
  }
   else if (Tau[i,4]=="SMC") {
    Tau[i,4]="CN"
   }
  
}
summary(as.factor(Tau$DX))

```

```{r}

TABLE<-data.frame(table(Tau$PTID))
# TABLE<- TABLE[which(TABLE$Freq>1),]
 
 
Tau_first<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau)))
Tau_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau)))
for (i in 1:nrow(TABLE)){
Tau_first[i,] <- Tau[min(which(Tau$PTID == TABLE$Var1[i])), ]

Tau_last[i,] <- Tau[max(which(Tau$PTID == TABLE$Var1[i])), ]

}
colnames(Tau_first) <- colnames(Tau)
colnames(Tau_last) <- colnames(Tau)
```

```{r}

summary(as.factor(Tau_first$DX))
summary(as.factor(Tau_last$DX))

``` 
 
```{r}
Matt01_tau_first<-data.frame(matrix(0, nrow(Tau_first), 148))

for (j in 1:148){
df<-Tau_first[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01_tau_first[,j]<- as.numeric(Tau_first[,c(11+j)]>cutpoint)
}
```

 
```{r}
Matt01_tau_last<-data.frame(matrix(0, nrow(Tau_last), 148))

for (j in 1:148){
df<-Tau_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)

cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01_tau_last[,j]<- as.numeric(Tau_last[,c(11+j)]>cutpoint)
}
```



### N (fdg) roc 0/1

```{r}
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")
ptInfo_321 <- read.csv("~/Documents/2020 research/AD_MODEL/ptInfo_321.csv")

 
FDG<-semi_join(FDG_SUVR, ptInfo_321, by= "PTID")
TABLE<-data.frame(table(FDG$PTID))


summary(as.factor(FDG$DX))
```

```{r}
for (i in 1:nrow(FDG)){
  if (FDG[i,4]=="LMCI"  )  {
    FDG[i,4]="AD"
  }
  else if (FDG[i,4]=="EMCI") {
    FDG[i,4]="CN"
  }
   else if (FDG[i,4]=="SMC") {
    FDG[i,4]="CN"
   }
  
}
summary(as.factor(FDG$DX))

```


```{r}
FDG_first<-as.data.frame(matrix(0, nrow(TABLE), ncol(FDG)) )
FDG_last<-as.data.frame(matrix(0, nrow(TABLE), ncol(FDG)) )
for (i in 1:nrow(TABLE)){
  FDG_first[i, ]<-FDG[min(which(FDG$PTID == TABLE$Var1[i] ) ),]
  FDG_last[i, ]<-FDG[max(which(FDG$PTID == TABLE$Var1[i] ) ),]
}
colnames(FDG_first)<-colnames(FDG)
colnames(FDG_last)<-colnames(FDG)
```

```{r}
max(apply(FDG_first[, c(12:159)], 2, max))
max(apply(FDG_first[, c(12:159)], 1, max))

```

```{r}
N_last<-FDG_last 
#N_last[, c(1:11)]<- FDG_last[,c(1:11)]
N_last[, c(12:159)]  <-max(apply(FDG_first[, c(12:159)], 2, max)) - FDG_last[, c(12:159)]


summary(as.factor(N_last$DX))
```



```{r}
Matt01_N_last<-data.frame(matrix(0, nrow(N_last), 148))
acc <- data.frame(matrix(0, 148, 2))
for (j in 1:148){
df<-N_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)
ss<-summary(cp)
acc[j,1]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01_N_last[,j]<- as.numeric(N_last[,c(11+j)]>=cutpoint)
}

 

```

```{r}
summary(N_last$`Node 1`)
```


 
```{r}
Matt01_N_last2<-data.frame(matrix(0, nrow(N_last), 148))

for (j in 1:148){
df<-N_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = youden)
ss<-summary(cp)
acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt01_N_last2[,j]<- as.numeric(N_last[,c(11+j)]>=cutpoint)
}

 summary(cp)
 
```




```{r}
Matt01_N_last<- cbind(N_last[, c(1,4)],Matt01_N_last)
Matt01_N_last2<-cbind(N_last[, c(1,4)],Matt01_N_last2)
```




```{r}
AIC2<-data.frame(matrix(0,148,2))
for (i in 1:148){
 tryCatch({
  X=N_last[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC2[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC2[i,2]<-summary(fit2)$bic
 }
   , error=function(e) NULL)

}
 
INDEX_FDG_AIC <- which(AIC2[,1] > AIC2[,2] & AIC2[,2] >0)
```

```{r}
INDX<-which(Info2[, 1]>0)
```




```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in INDEX_FDG_AIC){
  
   tryCatch({
  X<-N_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
  
  

}
``` 

```{r}
INDEX_FDG_AIC
which(Info2$mu1==0)
intersect(which(Info2$mu1>0), INDEX_FDG_AIC)  
```

```{r}
Info2[which(Info2$mu1  > Info2$mu2), ]<- Info2[which(Info2$mu1  > Info2$mu2), c(2,1,4,3,6,5)]

```


## 02/02
```{r}
INDEX_FDG_AIC
```


```{r}
i=12
#i=76
#X<-Tau_first[, c(11+i)]
X<-N_last[, c(11+i)]
#

hist(X )

EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
plot(EST, density=TRUE, cex.axis=1.4, cex.lab=1.4, cex.main=1.8, main2=" ", xlab2="N at node 101 ")
EST
```

```{r}
PPP<-data.frame(matrix(0, nrow(N_last), 148))
P_N_last<-cbind(N_last[,c(1:11)],PPP )
 for (j in INDEX_FDG_AIC){
  for (i in 1:nrow(N_last)){
 
     P_N_last[i,j+11]<-  (Info2$P2[j] *pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE) )/ (Info2$P2[j]*pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE) +  Info2$P1[j]*pnorm(N_last[i,j+11], mean = Info2$mu1[j], sd = Info2$sigma1[j], lower.tail = TRUE))  
#  P_N_last[i,j+11]<-(pAD *sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79     )/( pAD *sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79  + pCN *sum(as.numeric( N_last[which(N_last$DX=="CN") ,j+11] <= N_last[i,j+11] ))/242 )
 #   P_N_last[i,j+11]<- sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79 
    
     
  }
 }

```

```{r}
INDEX_FDG_AIC
```



```{r}
## 02/02 
PPP<-data.frame(matrix(0, nrow(N_last), 148))
P_N_last<-cbind(N_last[,c(1:11)],PPP )
 for (j in INDX){
  for (i in 1:nrow(N_last)){
    P_N_last[i,j+11]<-pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE)
  }
 }

```

```{r}
hist(apply(P_N_last[, 11+INDX], 2, mean ))
```

```{r}
p_Matt01_N_last<- apply(Matt01_N_last[, c(3:150)],2, sum )/321
```

 

```{r}
#plot(y=apply(P_N_last[, 11+INDX], 2, mean),x= p_V1_3k_roc_N[INDX])
df<-as.data.frame(cbind(y=apply(P_N_last[, 11+INDEX_FDG_AIC], 2, mean),x= p_V1_3k_roc_N[INDEX_FDG_AIC]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability")+ annotate("text", x = .8, y = 0.34, parse = TRUE,
           label = " r^2 ==  0.005104")

lm<-lm(y~x, data=df); summary(lm)
```

```{r}
Matt_AMY<-data.frame(matrix(0,nrow(Amy_last),1))

for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-Amy_last[,c(4,11+j)]
node<-apply(Amy_last[, c(12:159)],2,mean)
df<-as.data.frame(cbind(DX=Amy_last$DX, NODE=node) )
df$NODE<-as.numeric(df$NODE)
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD",   method = oc_youden_normal, metric = youden)
ss<-summary(cp)
acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
Matt_AMY[,1]<- unlist(as.numeric(df$NODE>=cutpoint))
 
colnames(Matt_AMY)<-"Amy positive"
}
```

```{r}
length(which(Matt_AMY==0))
```

```{r}
p_V1_3k_roc_N<- apply(V1_3k_roc_N[ , c(4:151)],2, sum )/321

df<-as.data.frame(cbind(y=apply(P_N_last[ , 11+INDX], 2, mean),x= p_V1_3k_roc_N[INDX]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="All", size=7)+ annotate("text", x = .8, y = 0.34, parse = TRUE,
           label = " r^2 ==  0.1293", size=7)


lm<-lm(y~x, data=df); summary(lm)
```

```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(Matt_AMY>0), c(4:151)],2, sum )/length(which(Matt_AMY>0))

df<-as.data.frame(cbind(y=apply(P_N_last[which(Matt_AMY>0), 11+INDX], 2, mean),x= p_V1_3k_roc_N_amyPOS[INDX]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title=expression(A*beta~"+"), size=7)+ annotate("text", x = .8, y = 0.34, parse = TRUE,
           label = " r^2 ==  0.08909", size=7)


lm<-lm(y~x, data=df); summary(lm)
```


```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(Matt_AMY==0), c(4:151)],2, sum )/length(which(Matt_AMY==0))

df<-as.data.frame(cbind(y=apply(P_N_last[which(Matt_AMY==0), 11+INDX], 2, mean),x= p_V1_3k_roc_N_amyPOS[INDX]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title=expression(A*beta~"-"), size=7)+ annotate("text", x = .8, y = 0.34, parse = TRUE,
           label = " r^2 ==  0.1835", size=7)


lm<-lm(y~x, data=df); summary(lm)
```

```{r}
summary(as.factor(V1_3k_roc_N$DX0) )
```

```{r}
which(V1_3k_roc_N$DX0=="AD")
```
```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(V1_3k_roc_N$DX0=="CN"), c(4:151)],2, sum )/length(which(V1_3k_roc_N$DX0=="CN"))

df<-as.data.frame(cbind(y=apply(P_N_last[which(V1_3k_roc_N$DX0=="CN"), 11+INDX], 2, mean),x= p_V1_3k_roc_N_amyPOS[INDX]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="CN", size=7)+ annotate("text", x = .88, y = 0.43, parse = TRUE,
           label = " r^2 ==  0.0769", size=7)


lm<-lm(y~x, data=df); summary(lm)
```

```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(V1_3k_roc_N$DX0=="LMCI"), c(4:151)],2, sum )/length(which(V1_3k_roc_N$DX0=="LMCI"))

df<-as.data.frame(cbind(y=apply(P_N_last[which(V1_3k_roc_N$DX0=="LMCI"), 11+INDX], 2, mean),x= p_V1_3k_roc_N_amyPOS[INDX]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="LMCI", size=7)+ annotate("text", x = .88, y = 0.43, parse = TRUE,
           label = " r^2 ==  0.02586", size=7)


lm<-lm(y~x, data=df); summary(lm)
```
















```{r}
hist(Info2$P2, breaks= 40, xlab="Tau-positive probability (106 nodes with two-components)", main="", ylim = c(0, 55) )
```

_## 02/02 


```{r}
PPP<-data.frame(matrix(0, nrow(N_last), 148))
P_N_last<-cbind(N_last[,c(1:11)],PPP )
 for (j in INDX){
  for (i in 1:nrow(N_last)){
    if (N_last$DX[i]=="AD" ){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_N_last[i,j+11]<-  (Info2$P2[j] *pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE) )/ (Info2$P2[j]*pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE) +  Info2$P1[j]*pnorm(N_last[i,j+11], mean = Info2$mu1[j], sd = Info2$sigma1[j], lower.tail = TRUE))  
    }
    else {
    P_N_last[i,j+11]<- 1- (Info2$P1[j]*pnorm(N_last[i,j+11], mean = Info2$mu1[j], sd = Info2$sigma1[j], lower.tail = TRUE) )/ (Info2$P1[j]*pnorm(N_last[i,j+11], mean = Info2$mu1[j], sd = Info2$sigma1[j], lower.tail = TRUE) +  Info2$P2[j]*pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE)) 
    }
  }
 }

```

```{r}
pCN<-242/321
pAD<-79/321

for (j in which(Info2$mu1==0)){
  for (i in 1:nrow(N_last)){
    if (N_last[i,4]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
   #  PP[i,j+11]<-(pAD *sum(as.numeric( FDG_2[which(FDG_2$Var3=="AD") ,j] <= FDG_2[i,j] ))/79     )/ (sum(as.numeric( FDG_2[ ,j] <= FDG_2[i,j] ))/299)
     P_N_last[i,j+11]<-(pAD *sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79     )/( pAD *sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79  + pCN *sum(as.numeric( N_last[which(N_last$DX=="CN") ,j+11] <= N_last[i,j+11] ))/242 )
     
    }
    else {
#    PP[i,j-2]<- 1 - (pCN *sum(as.numeric( FDG_2[which(FDG_2$Var3=="CN") ,j] <= FDG_2[i,j] ))/232 )/(sum(as.numeric( FDG_2[ ,j] <= FDG_2[i,j] ))/299) 
    
    P_N_last[i,j+11]<- 1 - (pCN *sum(as.numeric( N_last[which(N_last$DX=="CN") ,j+11] <= N_last[i,j+11] ))/242 )/( pAD *sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79  + pCN *sum(as.numeric( N_last[which(N_last$DX=="CN") ,j+11] <= N_last[i,j+11] ))/242 )
    }
  }
}
```


```{r}
i=154
j=110

 (pAD *sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79     )/( pAD *sum(as.numeric( N_last[which(N_last$Var3=="AD") ,j+11] <= N_last[i,j+11] ))/79  + pCN *sum(as.numeric( N_last[which(N_last$DX=="CN") ,j+11] <= N_last[i,j+11] ))/242 )
```



```{r}
write.csv(N_last,  file = "N_lastscanReversed0124.csv")
write.csv(P_N_last,  file = "Positive_prob_matrix0125.csv")
write.csv(Matt01_N_last,  file = "MatROC01_N_lastRev0124.csv")
write.csv(Matt01_N_last2,  file = "Matt01_N_2lastRev0125.csv") 
```


```{r}
length(which(acc$X1 <acc$X2))
```
 
```{r}
mean(acc$X1)
mean(acc$X2)
```


```{r}
np=0
for (i in 1:nrow(P_N_last)){
n<-length(which(P_N_last[i, c(12:159)]>0.5))
np<-n+np  
}
np/321/148
```

```{r}
hist(Info2[which( Info2$P2>0),6], breaks=20)
```



```{r}
# change fill and outline color manually 
ggplot(P_N_last, aes(x = X3)) +
  geom_histogram(aes(color = DX, fill = DX), 
                position = "identity", bins = 30, alpha = 0.4) +
  labs(x="N: node 1")+
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```


```{r}
i=89

df<-data.frame(v1=Matt01_N_last2[,c(2+i)], p2=P_N_last[, c(11+i)])
df$v1<-as.factor(as.character(df$v1))
 
# change fill and outline color manually 
ggplot(df, aes(x = p2)) +
  geom_histogram(aes(color = v1, fill = v1), 
                position = "identity", bins = 30, alpha = .5) +
  labs(x="probability (N positive), node 89")+
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```


```{r}
mean_AD_NODE9<-mean(N_last[which(N_last$DX=="AD"), c(20)])
mean_CN_NODE9<-mean(N_last[which(N_last$DX=="CN"), c(20)])
```
 
 
```{r}
summary(as.factor(N_last$DX) )
```
```{r}
k=11 # node index
cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur<- data.frame(matrix(0,length(cc), 3))
for (i in 1:length(cc)){
  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (v[j]==0 && N_last[j,4]=="CN"){
          Accur[i,1] = Accur[i,1] + 1
  }
  else if (v[j]==1 && N_last[j,4]=="AD"){
    Accur[i,2] = Accur[i,2] + 1
  }  
  }
}
```


```{r}
Accur$X3<-Accur$X1+Accur$X2
Accur$X1<-Accur$X1/242
Accur$X2<-Accur$X2/79
Accur$X3<-Accur$X3/321
colnames(Accur)<- c("CN", "AD","TOTAL")
```


```{r}
j=11
df<-N_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = accuracy)
summary(cp)
```

```{r}
(50+137)/321 # from roc 
```

```{r}
j=11
df<-N_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = accuracy)
summary(cp)
```


```{r}
max( apply(FDG_SUVR[, c(12:159)], 1, max))
NN<-FDG_SUVR

NN[, c(12:159)]<-max( apply(FDG_SUVR[, c(12:159)], 1, max))-FDG_SUVR[, c(12:159)]
```

```{r}
NN<-na.omit(NN, by="DX")
for (i in 1:nrow(NN)){
  if (NN[i,4]=="LMCI"  )  {
    NN[i,4]="AD"
  }
  else if (NN[i,4]=="EMCI") {
    NN[i,4]="CN"
  }
   else if (NN[i,4]=="SMC") {
    NN[i,4]="CN"
   }
  else if (NN[i,4]=="MCI") {
    NN[i,4]="CN"
   }
}
summary(as.factor(NN$DX))

```

```{r}
j=11
df<-NN[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec) # sum_sens_spec accuracy
#ss<-
  summary(cp)
# ac<-as.numeric(ss[[1]][[1]] )
```


```{r}
MattV1<-data.frame(matrix(0, nrow(N_last), 148))

for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-N_last[,c(4,11+j)]
colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = accuracy)
ss<-summary(cp)
acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV1[,j]<- as.numeric(N_last[,c(11+j)]>=cutpoint)
}
```
 
```{r}
MattV2<-data.frame(matrix(0, nrow(N_last), 148))

for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-N_last[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV2[,j]<- as.numeric(N_last[,c(11+j)]>=cutpoint)
}
``` 

```{r}
MattV3<-data.frame(matrix(0, nrow(N_last), 148))

for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-N_last[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = oc_youden_normal, metric = youden)
ss<-summary(cp)
acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV3[,j]<- as.numeric(N_last[,c(11+j)]>=cutpoint)
}
``` 




```{r}
write.csv(MattV1,  file = "MattV1_321.csv")
write.csv(MattV2,  file = "MattV2_321.csv")
write.csv(MattV3,  file = "MattV3.csv")
```

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur1<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (MattV1[j,i]==0 && N_last[j,4]=="CN"){
          Accur1[i,1] = Accur1[i,1] + 1
  }
  else if (MattV1[j,i]==1 && N_last[j,4]=="AD"){
    Accur1[i,2] = Accur1[i,2] + 1
  }  
  }
}
 
Accur1$X3<-Accur1$X1+Accur1$X2
Accur1$X1<-Accur1$X1/242
Accur1$X2<-Accur1$X2/79
Accur1$X3<-Accur1$X3/321
colnames(Accur1)<- c("CN", "AD","TOTAL")
```


```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur2<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (MattV2[j,i]==0 && N_last[j,4]=="CN"){
          Accur2[i,1] = Accur2[i,1] + 1
  }
  else if (MattV2[j,i]==1 && N_last[j,4]=="AD"){
    Accur2[i,2] = Accur2[i,2] + 1
  }  
  }
}
 
Accur2$X3<-Accur2$X1+Accur2$X2
Accur2$X1<-Accur2$X1/242
Accur2$X2<-Accur2$X2/79
Accur2$X3<-Accur2$X3/321
colnames(Accur2)<- c("CN", "AD","TOTAL")
```

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur3<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (MattV3[j,i]==0 && N_last[j,4]=="CN"){
          Accur3[i,1] = Accur3[i,1] + 1
  }
  else if (MattV3[j,i]==1 && N_last[j,4]=="AD"){
    Accur3[i,2] = Accur3[i,2] + 1
  }  
  }
}
 
Accur3$X3<-Accur3$X1+Accur3$X2
Accur3$X1<-Accur3$X1/242
Accur3$X2<-Accur3$X2/79
Accur3$X3<-Accur3$X3/321
colnames(Accur3)<- c("CN", "AD","TOTAL")
```



```{r}
Accur1$V1<-rep("v1", 148)
Accur2$V1<-rep("v2", 148)
Accur3$V1<-rep("v3", 148)
Accur1$id<-c(1:148)
Accur2$id<-c(1:148)
Accur3$id<-c(1:148)
```

```{r}
TESTV12<-data.frame(rbind(Accur1[, c(3,4,5)], Accur2[, c(3,4,5)],Accur3[, c(3,4,5)]))
```

```{r}
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) +
    geom_line() +labs(x="Node id", y="Accuracy of prediction", title = "v1: accuracy, v2: sen+spec, v3: normal_youden")+
    geom_point()
```
 
 
```{r}
PPP<-data.frame(matrix(0, nrow(N_last), 148))
P_N_last<-cbind(N_last[,c(1:11)],PPP )
 for (j in INDX){
  for (i in 1:nrow(N_last)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_N_last[i,j+11]<- pnorm(N_last[i,j+11], mean = Info2$mu2[j], sd = Info2$sigma2[j], lower.tail = TRUE) 
   
     
  }
 }

``` 
 
```{r}
MattV1<-cbind(N_last$DX , MattV1)
colnames(MattV1)[1]<-"DX"
MattV1 <- MattV1[order(MattV1$DX) , ]
#heatmap(MattV1, Colv = NA, Rowv = NA, scale="column")
 
P_N_last <- P_N_last[order(P_N_last$DX) , ] 
#library(pheatmap)
#pheatmap(MattV1, display_numbers = T)
pheatmap(P_N_last[, c(12:159)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)
```


 
```{r}
r<-c(1:148)

 
 for (j in setdiff(r, INDX)){
  for (i in 1:nrow(N_last)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
   P_N_last[i,j+11]<- sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79 
   
     
  }
 }

``` 

```{r}
pheatmap(P_N_last[, c(12:159)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)
```

```{r}
setdiff(r, INDX)
```



```{r}
write.csv(P_N_last,  file = "P_N_last_0202.csv")
```

 
```{r}
AIC_NN<-data.frame(matrix(0,148,2))
for (i in 1:148){
 tryCatch({
  X=NN[, c(11+i)]
fit1 = Mclust(X, G=1, model="V")
AIC_NN[i,1]<-summary(fit1)$bic 
fit2 = Mclust(X, G=2, model="V")
AIC_NN[i,2]<-summary(fit2)$bic
 }
   , error=function(e) NULL)

}
 
INDEX_N_AIC <- which(AIC_NN[,1] > AIC_NN[,2] & AIC_NN[,2] >0)
```


```{r}
summary(as.factor(NN$DX) )
1862+ 1547
```
 

```{r}
pCN<-1547/3409
pAD<-1862/3409

for (j in which(Info2$mu1==0)){
  for (i in 1:nrow(N_last)){
    if (N_last[i,4]=="AD"){
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
   #  PP[i,j+11]<-(pAD *sum(as.numeric( FDG_2[which(FDG_2$Var3=="AD") ,j] <= FDG_2[i,j] ))/79     )/ (sum(as.numeric( FDG_2[ ,j] <= FDG_2[i,j] ))/299)
     P_N_last[i,j+11]<-(pAD *sum(as.numeric( NN[which(NN$DX=="AD") ,j+11] <= N_last[i,j+11] ))/1862     )/( pAD *sum(as.numeric( NN[which(NN$DX=="AD") ,j+11] <= N_last[i,j+11] ))/1862  + pCN *sum(as.numeric( NN[which(NN$DX=="CN") ,j+11] <= N_last[i,j+11] ))/1547 )
     
    }
    else {
#    PP[i,j-2]<- 1 - (pCN *sum(as.numeric( FDG_2[which(FDG_2$Var3=="CN") ,j] <= FDG_2[i,j] ))/232 )/(sum(as.numeric( FDG_2[ ,j] <= FDG_2[i,j] ))/299) 
    
    P_N_last[i,j+11]<- 1 - (pCN *sum(as.numeric( NN[which(NN$DX=="CN") ,j+11] <= N_last[i,j+11] ))/1547 )/( pAD *sum(as.numeric( NN[which(NN$DX=="AD") ,j+11] <= N_last[i,j+11] ))/1862  + pCN *sum(as.numeric( NN[which(NN$DX=="CN") ,j+11] <= N_last[i,j+11] ))/1547 )
    }
  }
}
```


```{r}
P_N_last <- P_N_last[order(P_N_last$DX) , ] 
#library(pheatmap)
#pheatmap(MattV1, display_numbers = T)
pheatmap(P_N_last[, c(12:159)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)

```

```{r}
MattV1<-cbind(N_last$DX , MattV1)
colnames(MattV1)[1]<-"DX"
MattV1 <- MattV1[order(MattV1$DX) , ]
pheatmap(MattV1[, c(2:149)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)

```

```{r}
sum(apply(MattV1[, c(2:149)], 1, sum))/148
sum(apply(MattV1[, c(2:149)], 1, sum))/321/148

148*130
```



```{r}
MattV2<-cbind(N_last$DX , MattV2)
 
colnames(MattV2)[1]<-"DX"
MattV2 <- MattV2[order(MattV2$DX) , ]
pheatmap(MattV2[, c(2:149)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)

```


```{r}
MattV3<-cbind(N_last$DX , MattV3)
 
colnames(MattV3)[1]<-"DX"
MattV3 <- MattV3[order(MattV2$DX) , ]
pheatmap(MattV3[, c(2:149)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)

```



```{r}
simulation_01<-simulation_0124[, c(300:447)]

for (i in 1:148){
  simulation_01[, i]<-as.numeric(simulation_01[, i] > 0.5)
}
```

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur_sim<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (simulation_01[j,i]==0 && N_last[j,4]=="CN"){
          Accur_sim[i,1] = Accur_sim[i,1] + 1
  }
  else if (simulation_01[j,i]==1 && N_last[j,4]=="AD"){
    Accur_sim[i,2] = Accur_sim[i,2] + 1
  }  
  }
}
 
Accur_sim$X3<-Accur_sim$X1+Accur_sim$X2
Accur_sim$X1<-Accur_sim$X1/242
Accur_sim$X2<-Accur_sim$X2/79
Accur_sim$X3<-Accur_sim$X3/321
colnames(Accur_sim)<- c("CN", "AD","TOTAL")
```



```{r}
NN_SUBSET = subset(NN, !(PTID %in%  N_last$PTID ))
```


```{r}
MattV3<-data.frame(matrix(0, nrow(N_last), 148))

for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-NN_SUBSET[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr(df, NODE, DX,  direction = ">=", pos_class = "AD", method =maximize_metric, metric = accuracy)
ss<-summary(cp)
acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV3[,j]<- as.numeric(N_last[,c(11+j)]>=cutpoint)
}
``` 

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur_3<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (MattV3[j,i]==0 && N_last[j,4]=="CN"){
          Accur_3[i,1] = Accur_3[i,1] + 1
  }
  else if (MattV3[j,i]==1 && N_last[j,4]=="AD"){
    Accur_3[i,2] = Accur_3[i,2] + 1
  }  
  }
}

Accur_3$X3<-Accur_3$X1+Accur_3$X2
Accur_3$X1<-Accur_3$X1/242
Accur_3$X2<-Accur_3$X2/79
Accur_3$X3<-Accur_3$X3/321
colnames(Accur_3)<- c("CN", "AD","TOTAL")
```

```{r}
#Accur1$V1<-rep("v1", 148)
#Accur2$V1<-rep("v2", 148)
Accur_3$V1<-rep("v_accuracy", 148)
Accur_sim$V1<-rep("v_sim", 148)
#Accur1$id<-c(1:148)
#Accur2$id<-c(1:148)
Accur_3$id<-c(1:148)
Accur_sim$id<-c(1:148)

TESTV12<-data.frame(rbind(Accur_sim[, c(3,4,5)], Accur_3[, c(3,4,5)]))
 
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) +
    geom_line() +labs(x="Node id", y="Accuracy of prediction")+
    geom_point()
```

```{r}
#Accur1$V1<-rep("v1", 148)
#Accur2$V1<-rep("v2", 148)
Accur_3$V1<-rep("v_sen_spec", 148)
Accur_sim$V1<-rep("v_sim", 148)
#Accur1$id<-c(1:148)
#Accur2$id<-c(1:148)
Accur_3$id<-c(1:148)
Accur_sim$id<-c(1:148)

TESTV12<-data.frame(rbind(Accur_sim[, c(3,4,5)], Accur_3[, c(3,4,5)]))
 
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) +
    geom_line() +labs(x="Node id", y="Accuracy of prediction")+
    geom_point()
```

```{r}
#Accur1$V1<-rep("v1", 148)
#Accur2$V1<-rep("v2", 148)
Accur_3$V1<-rep("v_normal", 148)
Accur_sim$V1<-rep("v_sim", 148)
#Accur1$id<-c(1:148)
#Accur2$id<-c(1:148)
Accur_3$id<-c(1:148)
Accur_sim$id<-c(1:148)

TESTV12<-data.frame(rbind(Accur_sim[, c(3,4,5)], Accur_3[, c(3,4,5)]))
 
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) +
    geom_line() +labs(x="Node id", y="Accuracy of prediction")+
    geom_point()
```

```{r}
plot(x=Accur_3$TOTAL , y=Accur_sim$TOTAL, xlab="Accuracy (method: normal)", ylab="Accuracy (simulated)")
```

```{r}
plot(x=Accur_3$AD , y=Accur_sim$AD, xlab=" AD Accuracy (method: normal)", ylab="Accuracy (simulated)")
```

##  1/31

```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info_fdgfirst<-as.data.frame(matrix(0,148, 6))
colnames(Info_fdgfirst)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-FDG_first[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info_fdgfirst[i,c(1,2) ]<-  EST$mu
 Info_fdgfirst[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info_fdgfirst[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
}
```


 
```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info_fdglast<-as.data.frame(matrix(0,148, 6))
colnames(Info_fdglast)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-FDG_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info_fdglast[i,c(1,2) ]<-  EST$mu
 Info_fdglast[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info_fdglast[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
}
```
 

N_last
```{r}
i=2
X<-N_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
ee[[1]] 
```

 
```{r}
library(MASS)
data(galaxies)
i=2
 X<-FDG_last[, c(11+i)]
library(mclust, quietly=TRUE)
fit = Mclust(X, G=2, model="V")
summary(fit)
```


```{r}
colnames(V1_3k_pred)[1:3]<-c("PTID", "DX0","DX")
# colnames(V1_3k_pred)[1:3]<-c("PTID", "DX0","DX")
V1_3k_pred_N<-V1_3k_pred[,c(1:3,300:447 )]
colnames(V1_3k_pred_N)[4:151]<-colnames(Tau_SUVR)[12:159]
```

```{r}
colnames(V2_321_roc)[1:3]<-c("PTID", "DX0","DX")
# colnames(V1_3k_pred)[1:3]<-c("PTID", "DX0","DX")
V2_321_roc_N<-V2_321_roc[,c(1:3,300:447 )]
colnames(V2_321_roc_N)[4:151]<-colnames(Tau_SUVR)[12:159]
```


```{r}
ggplot(V1_3k_pred_N, aes(x=`Node 1`, fill = DX)) + geom_histogram(bins = 20, color = "black")
```

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur2_sim<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (V2_321_roc_N[j,i+3]==0 && V2_321_roc_N[j,3]=="CN"){
          Accur2_sim[i,1] = Accur2_sim[i,1] + 1
  }
  else if (V2_321_roc_N[j,i+3]==1 && V2_321_roc_N[j,3]=="AD"){
    Accur2_sim[i,2] = Accur2_sim[i,2] + 1
  }  
  }
}
 
Accur2_sim$X3<-Accur2_sim$X1+Accur2_sim$X2
Accur2_sim$X1<-Accur2_sim$X1/242
Accur2_sim$X2<-Accur2_sim$X2/79
Accur2_sim$X3<-Accur2_sim$X3/321
colnames(Accur2_sim)<- c("CN", "AD","TOTAL")
``` 
 
```{r}
#Accur1$V1<-rep("v1", 148)
Accur2$V1<-rep("v2", 148)
#Accur_3$V1<-rep("v_normal", 148)
Accur2_sim$V1<-rep("v2_sim", 148)
#Accur1$id<-c(1:148)
Accur2$id<-c(1:148)
#Accur_3$id<-c(1:148)
Accur2_sim$id<-c(1:148)

TESTV12<-data.frame(rbind(Accur2_sim[, c(3,4,5)], Accur2[, c(3,4,5)]))
 
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) + geom_line() +labs(x="Node id", y="Accuracy of prediction")+geom_point()+labs(title="data:N, v2:sens+spec (321 patients)")
```

```{r}
df=as.data.frame(cbind(v2_sim=Accur2_sim$TOTAL, v2=Accur2$TOTAL))
ggplot(df, aes(x=v2_sim, y=v2))+geom_point()
```

 

```{r}
colnames(V1_3k_roc)[1:3]<-c("PTID", "DX0","DX")
# colnames(V1_3k_pred)[1:3]<-c("PTID", "DX0","DX")
V1_3k_roc_N<-V1_3k_roc[,c(1:3,300:447 )]
colnames(V1_3k_roc_N)[4:151]<-colnames(Tau_SUVR)[12:159]
```

```{r}
colnames(V2_3k_roc)[1:3]<-c("PTID", "DX0","DX")
# colnames(V1_3k_pred)[1:3]<-c("PTID", "DX0","DX")
V2_3k_roc_N<-V2_3k_roc[,c(1:3,300:447 )]
colnames(V2_3k_roc_N)[4:151]<-colnames(Tau_SUVR)[12:159]
```

```{r}
MattV1_3k <-read.csv("~/Documents/2020 research/AD_MODEL/MattV1_3k.csv")
#MattV1_3k<-MattV1_3k[,c(2:149)]
MattV2_3k <-read.csv("~/Documents/2020 research/AD_MODEL/MattV2_3k.csv")
#MattV2_3k<-MattV2_3k[,c(2:149)]
```

```{r}
ratioV13k<-as.data.frame(apply(MattV1_3k[,c(2:149)],2, mean))
colnames(ratioV13k)<-"ratio"
ratioV13k$id<-c(1:148)
ggplot(ratioV13k, aes(x=id,y=ratio)) + geom_line() +labs(x="Node id", y="1 percent")+geom_point()+labs(title="data:N, v1:accuracy (3k patients)")
```



```{r}
V1_3k_roc <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/V1_3k_roc.csv")
V2_3k_roc <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/V2_3k_roc.csv")
```

```{r}
sum(MattV1_3k[, 2])/ nrow(MattV1_3k)
```

```{r}
V1_3k_roc
```



```{r}
ratioV13k<-  as.numeric(apply(MattV1_3k[,c(2:149)],2, mean) )
ratioV13k_sim<- as.numeric(  apply(V1_3k_roc[,c(4:151)],2, mean)  )
data<-as.data.frame(cbind(ratioV13k, ratioV13k_sim ))
#plot(x=ratioV13k, y=ratioV13k_sim, col="blue", xlab="Observed 1 percent", ylab="Predicted 1 percent", main="v1:3k patients")
 lm<-lm(ratioV13k_sim ~ ratioV13k, data=data)
summary(lm)
ggplot(data, aes( x=ratioV13k, y=ratioV13k_sim )) + geom_point() + geom_smooth(  method = "lm", se =F  ) + geom_text(aes(.8,.25, label=(paste(expression("R "^2*"=0.03643")))),parse = TRUE)+labs(x="Observed", y="Predicted", title="v1: 3k patients")

```

```{r}
ratioV13k<- apply(MattV2_3k[,c(2:149)],2, mean)
ratioV13k_sim<- apply(V2_3k_roc[,c(4:151)],2, mean)
data<-as.data.frame(cbind(ratioV13k, ratioV13k_sim ))
#plot(x=ratioV13k, y=ratioV13k_sim, col="blue", xlab="Observed 1 percent", ylab="Predicted 1 percent", main="v2:3k patients")
 lm<-lm(ratioV13k_sim ~ ratioV13k, data=data)
summary(lm)
ggplot(data, aes( x=ratioV13k, y=ratioV13k_sim )) + geom_point() + geom_smooth(  method = "lm", se =F  ) + geom_text(aes(.6,.05, label=(paste(expression("R "^2*"=0.006385")))),parse = TRUE)+labs(x="Observed", y="Predicted", title="v2: 3k patients")

```

```{r}
ratioV13k<- apply(MattV2_321[,c(2:149)],2, mean)
ratioV13k_sim<- apply(V2_321_roc[,c(4:151)],2, mean)
#plot(x=ratioV13k, y=ratioV13k_sim, col="blue", xlab="Observed 1 percent", ylab="Predicted 1 percent", main="v2:321 patients")
data<-as.data.frame(cbind(ratioV13k, ratioV13k_sim ))
#plot(x=ratioV13k, y=ratioV13k_sim, col="blue", xlab="Observed 1 percent", ylab="Predicted 1 percent", main="v2:3k patients")
 lm<-lm(ratioV13k_sim ~ ratioV13k, data=data)
summary(lm)
ggplot(data, aes( x=ratioV13k, y=ratioV13k_sim )) + geom_point() + geom_smooth(  method = "lm", se =F  ) + geom_text(aes(.7,.23, label=(paste(expression("R "^2*"=0.02003")))),parse = TRUE) +labs(x="Observed", y="Predicted", title="v2: 321 patients")

```

```{r}
MattV1_3k<- V1_3k_roc[ ,c(1:151)] 
MattV2 <- MattV1_3k[order(MattV1_3k$Var3) , ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_jing, V1_3k, sorted AD on Top")
```



```{r}
MattV1_3k<- V2_3k_roc[ ,c(1:151)] 
MattV2 <- MattV1_3k[order(MattV1_3k$Var3) , ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_jing, V2_3k, sorted AD on Top")
```



```{r}
MattV1_3k<- V2_321_roc[ ,c(1:151)] 
MattV2 <- MattV1_3k[order(MattV1_3k$Var3), ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_jing, V2_321, sorted AD on Top")
```

```{r}
MattV2_321 <- read.csv("~/Documents/2020 research/AD_MODEL/MattV2_321.csv")
MattV1_3k<- cbind(V2_321_roc[ ,c(1:3)],MattV2_321[2:149]  )
MattV2 <- MattV1_3k[order(MattV1_3k$Var3), ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_liu, V2_321, sorted AD on Top")
```

```{r}
MattV2_3k <- read.csv("~/Documents/2020 research/AD_MODEL/MattV2_3k.csv")

MattV1_3k<- cbind(V2_321_roc[ ,c(1:3)],MattV2_3k[2:149]  )
MattV2 <- MattV1_3k[order(MattV1_3k$Var3), ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_liu, V2_3k, sorted AD on Top")
```




```{r}
ratioV13k<-as.data.frame(apply(MattV2_3k[,c(2:149)],2, mean))
colnames(ratioV13k)<-"ratio"
ratioV13k$id<-c(1:148)
ggplot(ratioV13k, aes(x=id,y=ratio)) + geom_line() +labs(x="Node id", y="1 percent")+geom_point()+labs(title="data:N, v2:sen+spec (3k patients)")
```

```{r}
MattV1_321 <- read.csv("~/Documents/2020 research/AD_MODEL/MattV1_321.csv")
MattV2_321 <- read.csv("~/Documents/2020 research/AD_MODEL/MattV2_321.csv")
```


```{r}
ratioV13k<-as.data.frame(apply(MattV1_321[,c(2:149)],2, mean))
colnames(ratioV13k)<-"ratio"
ratioV13k$id<-c(1:148)
ggplot(ratioV13k, aes(x=id,y=ratio)) + geom_line() +labs(x="Node id", y="1 percent")+geom_point()+labs(title="data:N, v1 (321 patients)")
```

```{r}
ratioV13k<-as.data.frame(apply(MattV2_321[,c(2:149)],2, mean))
colnames(ratioV13k)<-"ratio"
ratioV13k$id<-c(1:148)
ggplot(ratioV13k, aes(x=id,y=ratio)) + geom_line() +labs(x="Node id", y="1 percent")+geom_point()+labs(title="data:N, v2 (321 patients)")
```


```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur2_sim_3k<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (V2_3k_roc_N[j,i+3]==0 && V2_3k_roc_N[j,3]=="CN"){
          Accur2_sim_3k[i,1] = Accur2_sim_3k[i,1] + 1
  }
  else if (V2_3k_roc_N[j,i+3]==1 && V2_3k_roc_N[j,3]=="AD"){
    Accur2_sim_3k[i,2] = Accur2_sim_3k[i,2] + 1
  }  
  }
}
 
Accur2_sim_3k$X3<-Accur2_sim_3k$X1+Accur2_sim_3k$X2
Accur2_sim_3k$X1<-Accur2_sim_3k$X1/242
Accur2_sim_3k$X2<-Accur2_sim_3k$X2/79
Accur2_sim_3k$X3<-Accur2_sim_3k$X3/321
colnames(Accur2_sim_3k)<- c("CN", "AD","TOTAL")
```

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur2_3k<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (MattV2_3k[j,i]==0 && V2_3k_roc_N[j,3]=="CN"){
          Accur2_3k[i,1] = Accur2_3k[i,1] + 1
  }
  else if (MattV2_3k[j,i]==1 && V2_3k_roc_N[j,3]=="AD"){
    Accur2_3k[i,2] = Accur2_3k[i,2] + 1
  }  
  }
}
 
Accur2_3k$X3<-Accur2_3k$X1+Accur2_3k$X2
Accur2_3k$X1<-Accur2_3k$X1/242
Accur2_3k$X2<-Accur2_3k$X2/79
Accur2_3k$X3<-Accur2_3k$X3/321
colnames(Accur2_3k)<- c("CN", "AD","TOTAL")
```
 
```{r}
#Accur1$V1<-rep("v1", 148)
Accur2_3k$V1<-rep("v2", 148)
#Accur_3$V1<-rep("v_normal", 148)
Accur2_sim_3k$V1<-rep("v2_sim", 148)
#Accur1$id<-c(1:148)
Accur2_3k$id<-c(1:148)
#Accur_3$id<-c(1:148)
Accur2_sim_3k$id<-c(1:148)

TESTV12<-data.frame(rbind(Accur2_sim_3k[, c(3,4,5)], Accur2_3k[, c(3,4,5)]))
 
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) + geom_line() +labs(x="Node id", y="Accuracy of prediction")+geom_point()+labs(title="data:N, v2:sens+spec (3k-321 patients)")
``` 

```{r}
df=as.data.frame(cbind(v2_sim=Accur2_sim_3k$TOTAL, v2=Accur2_3k$TOTAL))
ggplot(df, aes(x=v2_sim, y=v2))+geom_point()
```





```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur1_sim_3k<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (V1_3k_roc_N[j,i+3]==0 && V1_3k_roc_N[j,3]=="CN"){
          Accur1_sim_3k[i,1] = Accur1_sim_3k[i,1] + 1
  }
  else if (V1_3k_roc_N[j,i+3]==1 && V1_3k_roc_N[j,3]=="AD"){
    Accur1_sim_3k[i,2] = Accur1_sim_3k[i,2] + 1
  }  
  }
}
 
Accur1_sim_3k$X3<-Accur1_sim_3k$X1+Accur1_sim_3k$X2
Accur1_sim_3k$X1<-Accur1_sim_3k$X1/242
Accur1_sim_3k$X2<-Accur1_sim_3k$X2/79
Accur1_sim_3k$X3<-Accur1_sim_3k$X3/321
colnames(Accur1_sim_3k)<- c("CN", "AD","TOTAL")
```

```{r}
#k=11 # node index
#cc<-seq(min(N_last[, c(11+k)]), max(N_last[,c(11+k)]), by=0.05)
 
Accur1_3k<- data.frame(matrix(0,148, 3))
for (i in 1:148){
#  v<-as.numeric(  N_last[, c(11+k)] > cc[i] )
  for (j in 1:321){
  if (MattV1_3k[j,i]==0 && V1_3k_roc_N[j,3]=="CN"){
          Accur1_3k[i,1] = Accur1_3k[i,1] + 1
  }
  else if (MattV1_3k[j,i]==1 && V1_3k_roc_N[j,3]=="AD"){
    Accur1_3k[i,2] = Accur1_3k[i,2] + 1
  }  
  }
}
 
Accur1_3k$X3<-Accur1_3k$X1+Accur1_3k$X2
Accur1_3k$X1<-Accur1_3k$X1/242
Accur1_3k$X2<-Accur1_3k$X2/79
Accur1_3k$X3<-Accur1_3k$X3/321
colnames(Accur1_3k)<- c("CN", "AD","TOTAL")
```

```{r}
#Accur1$V1<-rep("v1", 148)
Accur1_3k$V1<-rep("v1", 148)
#Accur_3$V1<-rep("v_normal", 148)
Accur1_sim_3k$V1<-rep("v1_sim", 148)
#Accur1$id<-c(1:148)
Accur1_3k$id<-c(1:148)
#Accur_3$id<-c(1:148)
Accur1_sim_3k$id<-c(1:148)

TESTV12<-data.frame(rbind(Accur1_sim_3k[, c(3,4,5)], Accur1_3k[, c(3,4,5)]))
 
ggplot(TESTV12, aes(x=id, y=TOTAL, colour=V1)) + geom_line() +labs(x="Node id", y="Accuracy of prediction")+geom_point()+labs(title="data:N, v1:accuracy (3k-321 patients)")
```

 
```{r}
df=as.data.frame(cbind(v1_sim=Accur1_sim_3k$TOTAL, v1=Accur1_3k$TOTAL))
ggplot(df, aes(x=v1_sim, y=v1))+geom_point()+  annotate("text", x = .6, y = 0.3, parse = TRUE,
           label = " r^2 ==  0.4537", size=7)

lm1<-lm(Accur1_3k$TOTAL~Accur1_sim_3k$TOTAL)
summary(lm1)
```
 

```{r}
p_V1_3k_roc_N<- apply(V1_3k_roc_N[, c(4:151)],2, sum )/321
```

```{r}
Prob<-as.data.frame(matrix(0,148, 2))

MU<-as.data.frame(matrix(0,148, 2))
SIGMA<-as.data.frame(matrix(0,148, 2))

Info2<-as.data.frame(matrix(0,148, 6))
colnames(Info2)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
  
   tryCatch({
  X<-N_last[, c(11+i)]
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
  
 Info2[i,c(1,2) ]<-  EST$mu
 Info2[i, c(3,4)]<-EST$sigma
 
  mu.true<- EST$mu
sigma.true<- EST$sigma
  
  
  L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])

#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Info2[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
}


Info2[which(Info2$mu1  > Info2$mu2), ]<- Info2[which(Info2$mu1  > Info2$mu2), c(2,1,4,3,6,5)]

``` 

```{r}
View(p_V1_3k_roc_N)
plot(x=p_V1_3k_roc_N, y=Info2$P2, xlab="predicted", ylab="observed p")
```

```{r}
hist(V1_3k_pred$`Node 1`, breaks=20, xlab="simulation predicted", main="")
```

```{r}
lastscan_liu_aic <- read.csv("~/Documents/2020 research/AD_MODEL/lastscan_liu_aic.csv")
lastscan_liu_aic<-t(lastscan_liu_aic)
colnames(lastscan_liu_aic)<-lastscan_liu_aic[1,]
lastscan_liu_aic<-as.data.frame(lastscan_liu_aic[ c(2:149),])
rownames(lastscan_liu_aic) <- 1:nrow(lastscan_liu_aic)
i<-c(1:10)
lastscan_liu_aic[,i]<- apply(lastscan_liu_aic[,i], 2,function(x) as.numeric(as.character(x))) 
```

```{r}
 indx
```

```{r}
indx<- which(lastscan_liu_aic$std2>0)
PPP<-data.frame(matrix(0, nrow(N_last), 148))
P_N_last<-cbind(N_last[,c(1:11)],PPP )
 for (j in indx){
  for (i in 1:nrow(N_last)){
    P_N_last[i,j+11]<-pnorm(N_last[i,j+11], mean = lastscan_liu_aic$mu2[j], sd = lastscan_liu_aic$std2[j], lower.tail = TRUE)
  }
 }

```
 
 
```{r}
r<-c(1:148)

 
 for (j in setdiff(r, indx)){
  for (i in 1:nrow(N_last)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
   P_N_last[i,j+11]<- sum(as.numeric( N_last[which(N_last$DX=="AD") ,j+11] <= N_last[i,j+11] ))/79 
   
     
  }
 }

``` 

```{r}
pheatmap(P_N_last[, c(12:159)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)
```


```{r}
#plot(y=apply(P_N_last[, 11+INDX], 2, mean),x= p_V1_3k_roc_N[INDX])


df<-as.data.frame(cbind(y=apply(P_N_last[ , 11+indx], 2, mean),x= p_V1_3k_roc_N[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="All", size=7)+ annotate("text", x = .85, y = 0.13, parse = TRUE,
           label = " r^2 ==  0.04771", size=7)


lm<-lm(y~x, data=df); summary(lm)

```


```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(Matt_AMY>0), c(4:151)],2, sum )/length(which(Matt_AMY>0))

df<-as.data.frame(cbind(y=apply(P_N_last[which(Matt_AMY>0), 11+indx], 2, mean),x= p_V1_3k_roc_N_amyPOS[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title=expression(A*beta~"+"), size=7)+ annotate("text", x = .85, y = 0.14, parse = TRUE,
           label = " r^2 ==  0.03811", size=7)


lm<-lm(y~x, data=df); summary(lm)
```


```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(Matt_AMY==0), c(4:151)],2, sum )/length(which(Matt_AMY==0))

df<-as.data.frame(cbind(y=apply(P_N_last[which(Matt_AMY==0), 11+indx], 2, mean),x= p_V1_3k_roc_N_amyPOS[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title=expression(A*beta~"-"), size=7)+ annotate("text", x = .8, y = 0.34, parse = TRUE,
           label = " r^2 ==  0.05835", size=7)


lm<-lm(y~x, data=df); summary(lm)
```

```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(V1_3k_roc_N$DX0=="CN"), c(4:151)],2, sum )/length(which(V1_3k_roc_N$DX0=="CN"))

df<-as.data.frame(cbind(y=apply(P_N_last[which(V1_3k_roc_N$DX0=="CN"), 11+indx], 2, mean),x= p_V1_3k_roc_N_amyPOS[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="CN", size=7)+ annotate("text", x = .788, y = 0.13, parse = TRUE,
           label = " r^2 ==  0.04331", size=7)


lm<-lm(y~x, data=df); summary(lm)
```

```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(V1_3k_roc_N$DX0=="LMCI"), c(4:151)],2, sum )/length(which(V1_3k_roc_N$DX0=="LMCI"))

df<-as.data.frame(cbind(y=apply(P_N_last[which(V1_3k_roc_N$DX0=="LMCI"), 11+indx], 2, mean),x= p_V1_3k_roc_N_amyPOS[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="LMCI", size=7)+ annotate("text", x = .88, y = 0.13, parse = TRUE,
           label = " r^2 ==  0.004633", size=7)


lm<-lm(y~x, data=df); summary(lm)
``` 
 
```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(V1_3k_roc_N$DX0=="EMCI"), c(4:151)],2, sum )/length(which(V1_3k_roc_N$DX0=="EMCI"))

df<-as.data.frame(cbind(y=apply(P_N_last[which(V1_3k_roc_N$DX0=="EMCI"), 11+indx], 2, mean),x= p_V1_3k_roc_N_amyPOS[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="EMCI", size=7)+ annotate("text", x = .88, y = 0.13, parse = TRUE,
           label = " r^2 ==  0.0827", size=7)


lm<-lm(y~x, data=df); summary(lm)
```

```{r}
p_V1_3k_roc_N_amyPOS<- apply(V1_3k_roc_N[which(V1_3k_roc_N$DX0=="AD"), c(4:151)],2, sum )/length(which(V1_3k_roc_N$DX0=="AD"))

df<-as.data.frame(cbind(y=apply(P_N_last[which(V1_3k_roc_N$DX0=="AD"), 11+indx], 2, mean),x= p_V1_3k_roc_N_amyPOS[indx]))
ggplot(df, aes(x=x, y=y))+geom_point(color="skyblue")+geom_smooth(method = "lm", se = FALSE)+labs(x="predicted N probability", y="observed N probability", title="AD", size=7)+ annotate("text", x = .88, y = 0.13, parse = TRUE,
           label = " r^2 ==  0.02954", size=7)


lm<-lm(y~x, data=df); summary(lm)
``` 


```{r}
summary(V1_3k_roc_N$DX0)
```

```{r}
write.csv(P_N_last,  file = "P_N_last_0204.csv")
```


```{r}
pheatmap(P_N_last[, c(12:159)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)
```

```{r}
 MattV1_3k <-read.csv("~/Documents/2020 research/AD_MODEL/MattV1_3k.csv")
V2_321_roc <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/V2_321_roc.csv")
MattV1_3k<-cbind(V2_321_roc[ ,c(1,2,3)],MattV1_3k)
MattV2 <- MattV1_3k[order(MattV1_3k$Var3) , ]
pheatmap(MattV2[, c(5:152)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_liu, MattV1_3k")

``` 

```{r}
ratioV13k<-as.data.frame(apply(MattV2[,c(5:152)],2, mean))
colnames(ratioV13k)<-"ratio"
ratioV13k$id<-c(1:148)
ggplot(ratioV13k, aes(x=id,y=ratio)) + geom_line() +labs(x="Node id", y="1 percent")+geom_point()+labs(title="data:N, v1:accuracy (3k patients)")
```



 
```{r}
 
MattV2 <- V1_3k_roc_N[order(V1_3k_roc_N$DX) , ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="roc_jingwen")

``` 

 

```{r}
l1<-apply(V1_3k_roc_N[, c(4:151)],2, sum )/321
l2<-apply(MattV1_3k,2, sum )/321

c1<-rep("roc_jingwen", 148)
c2<-rep("roc_liu", 148)
 
id1<-c(1:148)
id2<-c(1:148)

df1<-cbind(l1,c1,id1)
df2<-cbind(l2,c2,id2)
```

```{r}
TESTV12<-data.frame(rbind(df1,df2 ))
i<-c(1,3)
TESTV12[,i]<- apply(TESTV12[,i], 2,function(x) as.numeric(as.character(x))) 
 
ggplot(TESTV12, aes(x=id1, y=l1, colour=c1)) +
    geom_line() +labs(x="Node id", y="percentage of '1'" )+
    geom_point()
```



```{r}
FDG_N_firstscan <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/FDG_N_firstscan.csv")
FDG_N_firstscan<-FDG_N_firstscan[-c(354, 374, 719),]
colnames(FDG_N_firstscan)[4:151]<-colnames(Amyloid_SUVR)[12:159]
```

```{r}
library(extRemes)


fit = fevd(FDG_N_firstscan[, 42],type="GEV")
hist(FDG_N_firstscan[, 42])
summary(fit)
```


```{r}

fit = fevd(max_N,type="GEV")
hist(max_N)
summary(fit)

```

```{r}
library(ForestFit)
starts<-c(2,1,0) # alpha =shape, beta=scale, mu= location
fitWeibull(max_N, location=TRUE, method="ml", starts)
```

```{r}
library(FAdist)
pweibull3(median(FDG_N_firstscan[, 8]),shape= 4.026687,scale=0.7134407,thres=0.1475713,lower.tail=TRUE,log.p=FALSE)

pweibull3(median(FDG_N_firstscan[, 8]),shape= 4.817543,scale=0.8539586,thres=0.01092208,lower.tail=TRUE,log.p=FALSE)

```

 
 
```{r}
# library(weibullness)

# Three-parameter Weibull

S<-weibull.mle(max_N)
S
S$shape 
S$scale 
S$threshold
```
 
 
 
 
```{r}
library(boot)
N=10000
max_N<-c(1:N)
for (i in 1:N){
max_N[i]<-max(sample(FDG_N_firstscan[, 3+60], size=100, replace = FALSE, prob = NULL))}
hist(max_N)
```
 
```{r}
fit = fevd(max_N,type="GEV")
summary(fit)$par
```
 

```{r}
#pevd(q, loc = 0, scale = 1, shape = 0, threshold = 0, lambda = 1, npy, type = c("GEV", "GP", "PP", "Gumbel", "Frechet", "Weibull","Exponential", "Beta", "Pareto"), lower.tail = TRUE, log.p = FALSE)
pevd(c(.9,1,1.1,1.2), PARA2$location[1], PARA2$scale[1], PARA2$shape[1], type="GEV")
```

```{r}

PARA2<-as.data.frame(matrix(0,148,3))

for (j in 1:148){
  
 
fit = fevd(FDG_N_firstscan[, j+3],type="GEV")
PARA2[j,]<-summary(fit)$par
  
}
colnames(PARA2)<-c("location"  ,   "scale" ,"shape" )


#PPP<-data.frame(matrix(0, nrow(FDG_N_firstscan), 148))
#P_N_last<-cbind(FDG_N_firstscan[,c(1:3)],PPP )
# for (j in 1:148){
#  for (i in 1:nrow(FDG_N_firstscan)){
#P_N_last[i,j+3]<-pevd(FDG_N_firstscan[i, j+3], PARA2$location[j], PARA2$scale[j], PARA2$shape[j], type="GEV")
#  }
# }



 



```



```{r}
 simulation_0124 <- read.csv("~/Documents/2020 research/AD_MODEL/simulation_0124.csv" )
simulation_0124<-simulation_0124[, c(1:3,300:447)]

simulation_0124[4:151]<-as.numeric(simulation_0124[4:151]>0.5)
```

```{r}
cc<-apply(FDG_N_firstscan[4:151],2, mean)
problist<-c(1:148)*0

 for (j in 1:148){
problist[j]<-pevd(cc[j], PARA2$location[j], PARA2$scale[j], PARA2$shape[j], type="GEV")
  }

```


```{r}
plot(x=apply(P_N_last[, c(4:151)],2,mean) , y= apply(simulation_0124[4:151],2, mean) , xlab="observed prob" , ylab="predicted prob" )
```



```{r}

```








 
```{r}
PARA<-as.data.frame(matrix(0,148,3))

for (j in 1:148){
  
 
N=10000
max_N<-c(1:N)*0
for (i in 1:N){
max_N[i]<-max(sample(FDG_N_firstscan[, j+3], size=100, replace = FALSE, prob = NULL))}
 
 
PARA[j,]<-weibull.mle(max_N)
}
colnames(PARA)<-c("shape"  ,   "scale" ,"threshold" )
```

```{r}

PPP<-data.frame(matrix(0, nrow(FDG_N_firstscan), 148))
P_N_last<-cbind(FDG_N_firstscan[,c(1:3)],PPP )
 for (j in 1:148){
  for (i in 1:nrow(FDG_N_firstscan)){
P_N_last[i,j+3]<-pweibull3(FDG_N_firstscan[i, j+3],shape=PARA[j,1] ,scale=PARA[j,2],thres=PARA[j,3],lower.tail=TRUE,log.p=FALSE)
  }
 }
```


```{r}
j=119 # node 1
hist(FDG_N_firstscan[, j+3] )
```

```{r}
apply(P_N_last[, 4:151], 2, mean)
```


```{r}
j=1
c<- unlist(FDG_N_firstscan[, j+3])
hist(c)
y=dweibull3(c,shape=PARA2[j,1] ,scale=PARA2[j,2],thres=PARA2[j,3], log=FALSE)
 
df<-as.data.frame(cbind(c, y))
plot(y~c, df) 
```

```{r}
j=1
library(logspline)
z = revd(100,loc=PARA2[j,3],scale=PARA2[j,2],shape=PARA2[j,1])
hist(z,prob=T,ylim=c(0,0.5),xlab="R.V. from Weibull (location = 0, scale = 1, shape = -0.6)",main="Weibull Distribution",ylab="f(x)",font=2,family="serif",font.lab=2,cex.lab=1.5)
plot(logspline(z),add=T,col="red")
```

```{r}
library("dplyr")
library("ggpubr")
```
 

 
```{r}
FDG_N_firstscan <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/FDG_N_firstscan.csv")
colnames(FDG_N_firstscan)[4:151]<-colnames(Amyloid_SUVR)[12:159]
FDG_N_firstscan<-FDG_N_firstscan[-c(354, 374, 719),]
ggdensity(FDG_N_firstscan$`Node 6`, main = "Density plot of N, outliers excluded", xlab = "Node  6")
data<- melt(FDG_N_firstscan[, c(4:151)])

ggplot(data,aes(x=value,fill=variable)) + geom_density(alpha=0.25)+labs(x="Node 1 to 148", y="Density plot",title="Data= N_firstscan, 1438 rows")+theme(legend.position = "none")
```

```{r}
ggdensity(FDG_N_firstscan$`Node 89`, main = "Density plot of N", xlab = "Node 89")
PvalueNtest<-as.data.frame(rep(0, 148) )
colnames(PvalueNtest)<-"pvalue"
for (j in 1:148){
su<-shapiro.test(FDG_N_firstscan[, j+3])
PvalueNtest$pvalue[j] <-   su$p.value
}
```
```{r}
which(PvalueNtest$pvalue>0.05)
```



```{r}
data<- melt(FDG_SUVR[, c(12:159)])

ggplot(data,aes(x=value,fill=variable)) + geom_density(alpha=0.25)+labs(x="Node 1 to 148", y="Density plot", title="Data= FDG_SUVR, 3478 rows")+theme(legend.position = "none")
```



```{r}
PvalueNtest<-as.data.frame(rep(0, 148) )
colnames(PvalueNtest)<-"pvalue"
for (j in 1:148){
su<-shapiro.test(unlist(FDG_SUVR[, j+11]))
PvalueNtest$pvalue[j] <-   su$p.value
}
which(PvalueNtest$pvalue>0.05)
```
```{r}
summary(as.factor(FDG_SUVR$DX) )
```


```{r}

FDG_SUVR_group<-FDG_SUVR[which(FDG_SUVR$DX=="SMC"),]
PvalueNtest<-as.data.frame(rep(0, 148) )
colnames(PvalueNtest)<-"pvalue"
for (j in 1:148){
su<-shapiro.test(unlist(FDG_SUVR_group[, j+11]))
PvalueNtest$pvalue[j] <-   su$p.value
}
which(PvalueNtest$pvalue>0.05)
```

```{r}
FDG_N_firstscan <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/FDG_N_firstscan.csv")

colnames(FDG_N_firstscan)[4:151]<-colnames(Amyloid_SUVR)[12:159]
#ggdensity(FDG_N_firstscan$`Node 25`, main = "Density plot of N", xlab = "Node 25")
v1<-FDG_N_firstscan[, c(1, 28)]
v1$Var1<-rep("Firstscan", nrow(v1))
FDG_N_firstscan<-FDG_N_firstscan[-c(354, 374, 719),]
#ggdensity(FDG_N_firstscan$`Node 25`, main = "Density plot of N, outliers excluded", xlab = "Node 25")


j=142

v2<-FDG_N_firstscan[, c(1, 3+j)]
v2$Var1<-rep("FirstscanO", nrow(v2))
 
v3<-v2
v3[,2]<-rnorm(nrow(v2), mean= mean(v2[,2]), sd=sd(v2[,2]) )
v3$Var1<-rep("NormalDist", nrow(v2))
 



data<-rbind(v2,v3)  

 
colnames(data)[2]<-"value"

ggplot(data,aes(x=value,fill=Var1)) + geom_density(alpha=0.5)+labs(x=" ", y="Density plot", title="Firstscan vs. fitted Normal Distribution at node 142") 
```

```{r}
NormalStat<-as.data.frame(matrix(0, 148, 2))
colnames(NormalStat)<-c("mean","std")
for (j in 1:148){
NormalStat$mean[j]= mean(FDG_N_firstscan[,3+j])
NormalStat$std[j]=sd(FDG_N_firstscan[,3+j])
}
```

```{r}
PPP<-data.frame(matrix(0, nrow(FDG_N_firstscan), 148))
P_Nor<-cbind(FDG_N_firstscan[,c(1:3)],PPP )
 for (j in 1:148){
  for (i in 1:nrow(FDG_N_firstscan)){
P_Nor[i,j+3]<-pnorm(FDG_N_firstscan[i, j+3],mean=NormalStat$mean[j] ,sd=NormalStat$std[j] )
  }
 }
```

```{r}
plot(x=apply(P_Nor[, c(4:151)],2,mean) , y= apply(simulation_0124[4:151],2, mean) , xlab="observed probability (Empirical Normal)" , ylab="predicted probability" )
```


```{r}
scaledN_firstscan_data_321 <- read.csv("~/Documents/2020 research/AD_MODEL/scaledN_firstscan_data_321.csv")
scaledN_firstscan_AIC_J <- read.csv("~/Documents/2020 research/AD_MODEL/scaledN_firstscan_AIC_J.csv")

scaledN_firstscan_data_321_J<-scaledN_firstscan_data_321[,c(1:3, 300:447)]
```


```{r}
 

scaledN_firstscan_AIC_J[which(scaledN_firstscan_AIC_J$mu1  > scaledN_firstscan_AIC_J$mu2), c(6,7,8,9) ] <- scaledN_firstscan_AIC_J[which(scaledN_firstscan_AIC_J$mu1  > scaledN_firstscan_AIC_J$mu2), c(7,6,9, 8) ]

```


 

```{r}
INDX_J<-which(scaledN_firstscan_AIC_J$mu1>0)
```

```{r}
PPP<-data.frame(matrix(0, nrow(scaledN_firstscan_data_321_J), 148))
P_N_last_0224<-cbind(scaledN_firstscan_data_321_J[,c(1:3)],PPP )
 for (j in 1:148){
  for (i in 1:nrow(scaledN_firstscan_data_321_J)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_N_last_0224[i,j+3]<- pnorm(scaledN_firstscan_data_321_J[i,j+3], mean = scaledN_firstscan_AIC_J$mu2[j], sd = scaledN_firstscan_AIC_J$std2[j], lower.tail = TRUE) 
   
     
  }
 }

``` 

 

```{r}
r<-c(1:148)

 
 for (j in setdiff(r, INDX_J)){
  for (i in 1:nrow(scaledN_firstscan_data_321_J)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
 #  P_N_last[i,j+11]<- sum(as.numeric( scaledN_firstscan_data_321_J[which(scaledN_firstscan_data_321_J$DX=="AD") ,j+11] <= scaledN_firstscan_data_321_J[i,j+11] ))/79 
   
      P_N_last_0224[i,j+3]<- pnorm(scaledN_firstscan_data_321_J[i,j+3], mean = scaledN_firstscan_AIC_J$mu2[j], sd = scaledN_firstscan_AIC_J$std2[j], lower.tail = TRUE) 
  }
 }

``` 

```{r}
write.csv(P_N_last_0224,  file = "Probability_N_last_0224.csv")
```

```{r}
MattV1_3k<- P_N_last_0224 
MattV2 <- MattV1_3k[order(MattV1_3k$Var3), ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="aic_jing, lastscan, sorted AD on Top")
```

```{r}
FDG_N_lastscan_AIC_J <- read.csv("~/Documents/2020 research/AD_MODEL/FDG_N_lastscan_AIC_J.csv")
FDG_N_lastscan <- read.csv("~/Documents/2020 research/AD_MODEL/02_01/FDG_N_lastscan.csv")
FDG_N_lastscan_AIC_J<-FDG_N_lastscan_AIC_J[,-1]
```

```{r}
FDG_N_lastscan_AIC_J[which(FDG_N_lastscan_AIC_J$mu1  > FDG_N_lastscan_AIC_J$mu2), c(6,7,8,9) ] <- FDG_N_lastscan_AIC_J[which(FDG_N_lastscan_AIC_J$mu1  > FDG_N_lastscan_AIC_J$mu2), c(7,6,9, 8) ]
```

```{r}
PPP<-data.frame(matrix(0, nrow(FDG_N_lastscan), 148))
P_N_last_0224<-cbind(FDG_N_lastscan[,c(1:3)],PPP )
 for (j in 1:148){
  for (i in 1:nrow(FDG_N_lastscan)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_N_last_0224[i,j+3]<- pnorm(FDG_N_lastscan[i,j+3], mean = FDG_N_lastscan_AIC_J$mu2[j], sd = FDG_N_lastscan_AIC_J$std2[j], lower.tail = TRUE) 
   
     
  }
 }

``` 
 
```{r}
P_N_last_321_0224<-P_N_last_0224[which(P_N_last_0224$Var1 %in% scaledN_firstscan_data_321_J$Var1 ) ,]

  max(P_N_last_321_0224[, c(4:151)])
```

```{r}
MattV1_3k<- P_N_last_321_0224 
MattV2 <- MattV1_3k[order(MattV1_3k$Var3), ]
pheatmap(MattV2[, c(4:151)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F, main="aic_jing, FDG_lastscan, sorted AD on Top, 321 from 1438")
```

```{r}
P_N_last_0202 <- read.csv("~/Documents/2020 research/AD_MODEL/P_N_last_0202.csv")
P_N_last_0202<-P_N_last_0202[, -1]
```


```{r}
pheatmap(P_N_last_0202[, c(12:159)], cluster_rows = FALSE, cluster_cols = FALSE, show_rownames=F)
```
 

```{r}
 library(readxl)
ADNI_DataSet <- read_excel("~/Downloads/ADNI_DataSet.xlsx")
 
```

```{r}
ID321<-MattV1_3k$Var1
```

```{r}
ADNI_DataSet321<-ADNI_DataSet[ which(ADNI_DataSet$PTID %in% ID321  & ADNI_DataSet$MMSE >-1 )  , ]

#ADNI_DataSet321<-na.omit(ADNI_DataSet321, cols=c("ADAS13") )
ADNItable<-as.data.frame(table(ADNI_DataSet321$PTID))


```

```{r}
ADNI_last<-as.data.frame(matrix(0, 321,148))

for (i in 1:nrow(ADNI_last)){
  ADNI_last[i, ]<- ADNI_DataSet321[ max(which( ADNI_DataSet321$PTID == ADNItable$Var1[i]   ) ) , ]
}

colnames(ADNI_last)<-colnames(ADNI_DataSet321)
```

 


```{r}
ratioV13k_sim<- apply(V2_321_roc[,c(4:151)],1, mean)
ADAS13<- ADNI_last$MMSE
 
df<-as.data.frame(cbind(ADAS13, ratioV13k_sim))

lm<-lm(ratioV13k_sim~ADAS13, data=df )
summary(lm)

ggplot(df, aes(x=ADAS13, y=ratioV13k_sim))+geom_point()+labs(x="MMSE", y="V2_321_roc")+geom_smooth(method="lm")+
  geom_text(aes(28,1.25, label=(paste(expression("R "^2*"=0.1921")))),parse = TRUE)
```



```{r}
ratioV13k_sim<- apply(V2_3k_roc[,c(4:151)],1, mean)
#ADAS13<- ADNI_last$ADAS13
 
df<-as.data.frame(cbind(ADAS13, ratioV13k_sim))

lm<-lm(ratioV13k_sim~ADAS13, data=df )
summary(lm)

ggplot(df, aes(x=ADAS13, y=ratioV13k_sim))+geom_point()+labs(x="MMSE", y="V2_3k_roc")+geom_smooth(method="lm")+
  geom_text(aes(28,1.15, label=(paste(expression("R "^2*"=0.125")))),parse = TRUE)
```





```{r}
ratioV13k_sim<- apply(V2_321_roc[,c(4:151)],1, mean)
ADAS13<- ADNI_last$ADAS13
 
df<-as.data.frame(cbind(ADAS13, ratioV13k_sim))

lm<-lm(ratioV13k_sim~ADAS13, data=df )
summary(lm)

ggplot(df, aes(x=ADAS13, y=ratioV13k_sim))+geom_point()+labs(y="V2_321_roc")+geom_smooth(method="lm")+
  geom_text(aes(43,.25, label=(paste(expression("R "^2*"=0.2347")))),parse = TRUE)
```







```{r}
FDG_SUVR$DX<- as.factor(FDG_SUVR$DX)
table(FDG_SUVR$DX)
summary(FDG_SUVR[, 4])
```


```{r}
for (i in 1:nrow(FDG_SUVR)){
  if (FDG_SUVR[i,4]=="LMCI")  {
    FDG_SUVR[i,4]="AD"
  }
  else if (FDG_SUVR[i,4]=="EMCI") {
    FDG_SUVR[i,4]="CN"
  }
  else if (FDG_SUVR[i,4]=="SMC") {
    FDG_SUVR[i,4]="CN"
  }
  else if (FDG_SUVR[i,4]=="MCI") {
    FDG_SUVR[i,4]="CN"
  }
  
}

```


```{r}
SampleDF<-FDG_SUVR[sample(nrow(FDG_SUVR), 1000), ]
MattV1k<-data.frame(matrix(0, nrow(SampleDF), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-SampleDF[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV1k[,j]<- as.numeric(SampleDF[,c(11+j)]<=cutpoint)
}

#View(MattV1k)
``` 

```{r}
#SampleDF<-FDG_SUVR[sample(nrow(FDG_SUVR), 2000), ]
MattV1_500<-data.frame(matrix(0, nrow(SampleDF), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-SampleDF[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = accuracy)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV1_500[,j]<- as.numeric(SampleDF[,c(11+j)]<=cutpoint)
}

View(MattV1_500)
``` 


```{r}
y= apply(MattV1k,2, mean ) ; x=apply(MattV1_500,2, mean)
df<-as.data.frame(cbind(x,y))
lm<-lm(y~x, df)
summary(lm)
sqrt(0.0008131)

ggplot(df, aes(x=x,y=y))+geom_point()+geom_smooth(method = "lm") +labs(x="method: max(accuracy)", y="method: max(sen+spec)" ,title="data size: 2000, R=0.02851491")+
    geom_text(aes(.76,.2, label=(paste(expression("R "^2*"=0.0008131")))),parse = TRUE)

# plot( , xlab="method: max(sen+spec) under Normal", ylab="method: max(sen+spec)")
```

```{r}
 
MattV2k<-data.frame(matrix(0, nrow(SampleDF), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-SampleDF[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = accuracy)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV2k[,j]<- as.numeric(SampleDF[,c(11+j)]<=cutpoint)
}

View(MattV2k)
``` 



```{r}
 
MattV3k<-data.frame(matrix(0, nrow(SampleDF), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-SampleDF[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD",method = oc_youden_normal, metric = youden)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV3k[,j]<- as.numeric(SampleDF[,c(11+j)]<=cutpoint)
}

#View(MattV3k)
``` 

```{r}
plot(x= apply(MattV1k,2, mean ) , y=apply(MattV3k,2, mean) , xlab="method: max(accuracy)", ylab="method: max(sen+spec)")
```


```{r}
y= apply(MattV1k,2, mean ) ; x=apply(MattV3k,2, mean)
df<-as.data.frame(cbind(x,y))
lm<-lm(y~x, df)
summary(lm)
sqrt(0.03072)
ggplot(df, aes(x=x,y=y))+geom_point()+geom_smooth(method = "lm") +labs(x="method: max(sen+spec) under Normal", y="method: max(sen+spec)" ,title="data size:1000, R=-0.1752712") +
  geom_text(aes(.6,.2, label=(paste(expression("R "^2*"=0.03072")))),parse = TRUE)

# plot( , xlab="method: max(sen+spec) under Normal", ylab="method: max(sen+spec)")
```



```{r}
summary(FDG_SUVR$DX)
```

```{r}
1862/1547
```


```{r}
FDG_SUVR_AD<-FDG_SUVR[which(FDG_SUVR$DX=="AD"),]
FDG_SUVR_CN<-FDG_SUVR[which(FDG_SUVR$DX=="CN"),]
```


```{r}
sAD<-FDG_SUVR_AD[sample(nrow(FDG_SUVR_AD), 600), ]
sCN<-FDG_SUVR_CN[sample(nrow(FDG_SUVR_CN), 500), ]
#SampleDF<-FDG_SUVR[sample(nrow(FDG_SUVR), 1000), ]
SampleDF<-rbind(sAD, sCN)

MattV1k<-data.frame(matrix(0, nrow(SampleDF), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-SampleDF[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV1k[,j]<- as.numeric(SampleDF[,c(11+j)]<=cutpoint)
}

#View(MattV1k)
``` 

```{r}
summary(SampleDF$DX)
 
```


```{r}
 
MattV3k<-data.frame(matrix(0, nrow(SampleDF), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-SampleDF[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD",method = maximize_metric, metric = accuracy)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
MattV3k[,j]<- as.numeric(SampleDF[,c(11+j)]<=cutpoint)
}

#View(MattV3k)
``` 


```{r}
y= apply(MattV1k,2, mean ) ; x=apply(MattV3k,2, mean)
df<-as.data.frame(cbind(x,y))
lm<-lm(y~x, df)
summary(lm)
sqrt(0.00244)
ggplot(df, aes(x=x,y=y))+geom_point()+geom_smooth(method = "lm") +labs(x="method: max(sen+spec) under Normal", y="method: max(sen+spec)" ,title="data size:AD600,CN500, R=0.04939636") +
  geom_text(aes(.6,.2, label=(paste(expression("R "^2*"=0.00244")))),parse = TRUE)

# plot( , xlab="method: max(sen+spec) under Normal", ylab="method: max(sen+spec)")
```

## March 01

```{r}
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")

table(FDG_SUVR$DX)
FDG_SUVR<-na.omit(FDG_SUVR, cols=c("DX"))

for (i in 1:nrow(FDG_SUVR)){
  if (FDG_SUVR[i,4]=="LMCI")  {
    FDG_SUVR[i,4]="AD"
  }
  else if (FDG_SUVR[i,4]=="SMC")  {
    FDG_SUVR[i,4]="CN"
  }
  else if (FDG_SUVR[i,4]=="EMCI")  {
    FDG_SUVR[i,4]="CN"
  }
  else if (FDG_SUVR[i,4]=="MCI")  {
    FDG_SUVR[i,4]="AD"
  }
  
}

FDG_SUVR$DX<-as.factor(FDG_SUVR$DX)
```

```{r}
ACC3K<- data.frame(matrix(0, 148, 3))
colnames(ACC3K)<-c("accuracy", "sensitivity","specificity")
rocV2_3K<-data.frame(matrix(0, nrow(FDG321_last), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG_SUVR[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC3K$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC3K$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC3K$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
rocV2_3K[,j]<- as.numeric(FDG321_last[,c(11+j)]<=cutpoint)
}
rocV2_3K<-cbind(FDG321_last[, c(1,4)], rocV2_3K)

ACC3K$SS<-ACC3K$sensitivity+ACC3K$specificity

ACC3K$Data<-rep("3K data", 148)
 
ACC3K$id<-c(1:148)

```

```{r}
write.csv(rocV2_3K,  file = "N_rocV2_3K.csv")
```



```{r}
FDG_SUVR$DX<- as.factor(FDG_SUVR$DX)
summary(FDG_SUVR$DX)
```

```{r}
#FDG0301<-FDG_SUVR[which(FDG_SUVR$DX %in%  c("AD", "LMCI", "CN","SMC") )   ,]
 
for (i in 1:nrow(FDG_SUVR)){
  if (FDG_SUVR[i,4]=="LMCI")  {
    FDG_SUVR[i,4]="AD"
  }
  else if (FDG_SUVR[i,4]=="SMC")  {
    FDG_SUVR[i,4]="CN"
  }
  else if (FDG_SUVR[i,4]=="EMCI")  {
    FDG_SUVR[i,4]="CN"
  }
  else if (FDG_SUVR[i,4]=="MCI")  {
    FDG_SUVR[i,4]="AD"
  }
  
}

```




```{r}
FDG0301<-FDG_SUVR[which(FDG_SUVR$DX %in%  c("AD", "LMCI", "CN","SMC") )   ,]
 
for (i in 1:nrow(FDG0301)){
  if (FDG0301[i,4]=="LMCI")  {
    FDG0301[i,4]="AD"
  }
  else if (FDG0301[i,4]=="SMC")  {
    FDG0301[i,4]="CN"
  }
}

```

```{r}
FDG0301$DX<-as.factor(FDG0301$DX)
summary((FDG0301$DX))
```

 
```{r}
ACC<- data.frame(matrix(0, 148, 3))
colnames(ACC)<-c("accuracy", "sensitivity","specificity")
rocV2_2K<-data.frame(matrix(0, nrow(FDG0301), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG0301[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
rocV2_2K[,j]<- as.numeric(FDG0301[,c(11+j)]<=cutpoint)
}
```

```{r}
ACCv1Youden<- data.frame(matrix(0, 148, 3))
colnames(ACCv1Youden)<-c("accuracy", "sensitivity","specificity")
#rocV2_2K<-data.frame(matrix(0, nrow(FDG0301), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG0301[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = oc_youden_normal, metric = youden)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACCv1Youden$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACCv1Youden$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACCv1Youden$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
#rocV2_2K[,j]<- as.numeric(FDG0301[,c(11+j)]<=cutpoint)
}
```



 
```{r}
ACC0<- data.frame(matrix(0, 148, 3))
colnames(ACC0)<-c("accuracy", "sensitivity","specificity")
#rocV2_2K<-data.frame(matrix(0, nrow(FDG_SUVR), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG_SUVR[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC0$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC0$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC0$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
#rocV2_2K[,j]<- as.numeric(FDG0301[,c(11+j)]<=cutpoint)
}
```


```{r}
#Accur1$V1<-rep("v1", 148)
ACC0$v1<-rep("Original", 148)
ACCv1Youden$V1<-rep("Under normal", 148)
#Accur_3$V1<-rep("v_normal", 148)
ACC$V1<-rep("Sen+Spec", 148)
#Accur1$id<-c(1:148)
ACC0$id<-c(1:148)
#Accur_3$id<-c(1:148)
ACC$id<-c(1:148)
ACCv1Youden$id<-c(1:148)

TESTV12<-data.frame(rbind(ACC[, c(3,4,5)], ACCv1Youden[, c(3,4,5)]))
colnames(TESTV12)[2]<-"Method"

ggplot(TESTV12, aes(x=id, y=specificity, colour=Method)) + geom_line() +labs(x="Node id", y="Specificity")+geom_point() 
```

```{r}
plot(x=ACC0$accuracy, y=ACC$accuracy, xlab="Orginal accuracy", ylab="Accuracy without EMCI" )
abline(a=0,b=1)
```



```{r}
rocV2_2K<-cbind(FDG0301[, c(1,4)] , rocV2_2K)
```



```{r}
TABLE<-data.frame(table(rocV2_2K$PTID))

rocV2_2K_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(rocV2_2K)))
for (i in 1:nrow(TABLE)){
 

rocV2_2K_last[i,] <- rocV2_2K[max(which(rocV2_2K$PTID == TABLE$Var1[i])), ]

}
 
colnames(rocV2_2K_last) <- colnames(rocV2_2K)


```


```{r}
final_ptInfo_223 <- read.csv("~/Documents/2020 research/AD_MODEL/final_ptInfo_223.csv")
```
 
```{r}
roc_v2_223<-rocV2_2K_last[which(rocV2_2K_last$PTID %in% final_ptInfo_223$PTID),]

roc_v2_223<-cbind(final_ptInfo_223[,c(1,2,3)] ,roc_v2_223[, c(3:150)])


write.csv(roc_v2_223,  file = "roc_v2_223.csv")
```


```{r}
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")

final_ptInfo_223 <- read.csv("~/Documents/2020 research/AD_MODEL/final_ptInfo_223.csv")
```

```{r}
FDG_SUVR<-FDG_SUVR[which(FDG_SUVR$PTID %in% final_ptInfo_223$PTID  ),]
```

```{r}
TABLE<-data.frame(table(FDG_SUVR$PTID))

FDG223_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(FDG_SUVR)))
for (i in 1:nrow(TABLE)){
 

FDG223_last[i,] <- FDG_SUVR[max(which(FDG_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(FDG223_last) <- colnames(FDG_SUVR)
```

```{r}
table(FDG223_last$DX)
```


```{r}
for (i in 1:nrow(FDG223_last)){
  if (FDG223_last[i,4]=="LMCI")  {
    FDG223_last[i,4]="AD"
  }
  else if (FDG223_last[i,4]=="SMC")  {
    FDG223_last[i,4]="CN"
  }
}

FDG223_last$DX<-as.factor(FDG223_last$DX)
 
ACC223<- data.frame(matrix(0, 148, 3))
colnames(ACC223)<-c("accuracy", "sensitivity","specificity")
rocV2_223<-data.frame(matrix(0, nrow(FDG223_last), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG223_last[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC223$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC223$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC223$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
rocV2_223[,j]<- as.numeric(FDG223_last[,c(11+j)]<=cutpoint)
}
```

```{r}

FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")

FDG_SUVR<-FDG_SUVR[which(FDG_SUVR$PTID %in% scaledN_firstscan_data_321$Var1  ),]
TABLE<-data.frame(table(FDG_SUVR$PTID))

FDG321_first<- as.data.frame(matrix(0,nrow(TABLE), ncol(FDG_SUVR)))

FDG321_last<- as.data.frame(matrix(0,nrow(TABLE), ncol(FDG_SUVR)))
for (i in 1:nrow(TABLE)){
 
FDG321_first[i,] <- FDG_SUVR[min(which(FDG_SUVR$PTID == TABLE$Var1[i])), ]
FDG321_last[i,] <- FDG_SUVR[max(which(FDG_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(FDG321_last) <- colnames(FDG_SUVR)

 
for (i in 1:nrow(FDG321_last)){
  if (FDG321_last[i,4]=="LMCI")  {
    FDG321_last[i,4]="AD"
  }
  else if (FDG321_last[i,4]=="SMC")  {
    FDG321_last[i,4]="CN"
  }
  else if (FDG321_last[i,4]=="EMCI")  {
    FDG321_last[i,4]="CN"
  }
}


FDG321_last$DX<-as.factor(FDG321_last$DX)

ACC321<- data.frame(matrix(0, 148, 3))
colnames(ACC321)<-c("accuracy", "sensitivity","specificity")
rocV2_321<-data.frame(matrix(0, nrow(FDG321_last), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG321_last[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC321$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC321$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC321$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
rocV2_321[,j]<- as.numeric(FDG321_last[,c(11+j)]<=cutpoint)
}
```


```{r}
ACC321$SS<-ACC321$sensitivity+ACC321$specificity
ACC223$SS<-ACC223$sensitivity+ACC223$specificity
```


```{r}
 
ACC321$Data<-rep("321", 148)
ACC223$Data<-rep("223", 148)
 
 
ACC321$id<-c(1:148)
 
ACC223$id<-c(1:148)
 

TESTV12<-data.frame(rbind(ACC321[, c(4:6)], ACC223[, c(4:6)]))
 

ggplot(TESTV12, aes(x=id, y=SS, colour=Data)) + geom_line() +labs(x="Node id", y="Sen + Spec")+geom_point() 
```
 
```{r}
plot(x=ACC321$SS,y=ACC223$SS, xlab="Sen + Spec: data 321 ", ylab="Sen + Spec: data 223" )
abline(a=0,b=1)
```


```{r}
final_ptInfo_223 <- read.csv("~/Documents/2020 research/AD_MODEL/final_ptInfo_223.csv")
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")

FDG_SUVR<-FDG_SUVR[ which(FDG_SUVR$PTID %in% final_ptInfo_223$PTID) ,]
TABLE<-data.frame(table(FDG_SUVR$PTID))


FDG2K_last223<- as.data.frame(matrix(0,nrow(TABLE), ncol(FDG_SUVR)))
for (i in 1:nrow(TABLE)){
 

FDG2K_last223[i,] <- FDG_SUVR[max(which(FDG_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(FDG2K_last223) <- colnames(FDG_SUVR)
```



```{r}
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")
FDG_SUVR<-FDG_SUVR[ which(FDG_SUVR$PTID %in% setdiff(FDG_SUVR$PTID, final_ptInfo_223$PTID)) ,]
 
FDG_SUVR<-FDG_SUVR[ which(FDG_SUVR$DX %in% c("AD","CN","LMCI")),]

for (i in 1:nrow(FDG_SUVR)){
  if (FDG_SUVR[i,4]=="LMCI")  {
    FDG_SUVR[i,4]="AD"
  }
  
}

FDG_SUVR$DX<-as.factor(FDG_SUVR$DX)

```
 



 
```{r}

 
ACC2k<- data.frame(matrix(0, 148, 3))
colnames(ACC2k)<-c("accuracy", "sensitivity","specificity")
rocV2_2k<-data.frame(matrix(0, nrow(FDG2K_last223), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG_SUVR[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC2k$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC2k$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC2k$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
rocV2_2k[,j]<- as.numeric(FDG2K_last223[,c(11+j)]<=cutpoint)
}

rocV2_2k<-cbind(final_ptInfo_223,rocV2_2k )
```
 
```{r}
ACC2k$SS<-ACC2k$sensitivity+ACC2k$specificity
ACC2k$Data<-rep("2K", 148)
 
 
ACC2k$id<-c(1:148)
#colnames(ACC2k)<-colnames(ACC321)
```
 
```{r}
ACC223ordered <-ACC223[order(-ACC223$SS), ]
ACC321ordered <-ACC321[order(-ACC223$SS), ]
ACC2kordered  <-ACC2k[order(-ACC223$SS), ]
ACC3Kordered  <-ACC3K[order(-ACC223$SS), ]

ACC223ordered$Data<-rep("223", 148)
ACC321ordered$Data<-rep("321", 148)
 ACC2kordered$Data<-rep("2K", 148)
 ACC3Kordered$Data<-rep("3K original", 148)
 ACC223ordered$id<-c(1:148)
ACC321ordered$id<-c(1:148)
 ACC2kordered$id<-c(1:148)
ACC3Kordered$id<-c(1:148)


TESTV12<-data.frame(rbind(ACC321ordered[, c(4:6)], ACC2kordered[, c(4:6)], ACC223ordered[, c(4:6)],ACC3Kordered[, c(4:6)]  ))
ggplot(TESTV12, aes(x=id, y=SS, colour=Data)) + geom_line() +labs(x="N: Node id", y="Sen + Spec")+geom_point() 

```
 
 
```{r}
plot(x=ACC2k$SS,y=ACC223$SS, xlab="Sen + Spec: data 2k ", ylab="Sen + Spec: data 223" )
abline(a=0,b=1)
```
 
```{r}
PTID321<-scaledN_firstscan_data_321$Var1
```
 
```{r}
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
 
# Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
 
Amyloid_SUVR<-Amyloid_SUVR[ which(Amyloid_SUVR$PTID %in% setdiff(Amyloid_SUVR$PTID, scaledN_firstscan_data_321$Var1)) ,]

table(Amyloid_SUVR$DX)

Amyloid_SUVR<-Amyloid_SUVR[which(Amyloid_SUVR$DX %in% c("AD","CN","LMCI", "EMCI","SMC")),]

for (i in 1:nrow(Amyloid_SUVR)){
  if (Amyloid_SUVR[i,4]=="LMCI")  {
    Amyloid_SUVR[i,4]="AD"
  }
  else if (Amyloid_SUVR[i,4]=="EMCI")  {
    Amyloid_SUVR[i,4]="CN"
  }
  else if (Amyloid_SUVR[i,4]=="SMC")  {
    Amyloid_SUVR[i,4]="CN"
  }
  
}

Amyloid_SUVR$DX<-as.factor(Amyloid_SUVR$DX)
```
 
```{r}
amyACC1k<- data.frame(matrix(0, 148, 3))
colnames(amyACC1k)<-c("accuracy", "sensitivity","specificity")
amyrocV2_1k<-data.frame(matrix(0, nrow(Amyloid_SUVR), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-Amyloid_SUVR[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
amyACC1k$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
amyACC1k$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
amyACC1k$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
amyrocV2_1k[,j]<- as.numeric(Amyloid_SUVR[,c(11+j)]>=cutpoint)
}

amyrocV2_1k<-cbind(Amyloid_SUVR[, c(1,4)],amyrocV2_1k )
 
amyACC1k$SS<-amyACC1k$sensitivity + amyACC1k$specificity
```

```{r}
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
 
# Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
 
# Amyloid_SUVR<-Amyloid_SUVR[ which(Amyloid_SUVR$PTID %in% setdiff(Amyloid_SUVR$PTID, scaledN_firstscan_data_321$Var1)) ,]

table(Amyloid_SUVR$DX)

Amyloid_SUVR<-Amyloid_SUVR[which(Amyloid_SUVR$DX %in% c("AD","CN","LMCI", "EMCI","SMC")),]

for (i in 1:nrow(Amyloid_SUVR)){
  if (Amyloid_SUVR[i,4]=="LMCI")  {
    Amyloid_SUVR[i,4]="AD"
  }
  else if (Amyloid_SUVR[i,4]=="EMCI")  {
    Amyloid_SUVR[i,4]="CN"
  }
  else if (Amyloid_SUVR[i,4]=="SMC")  {
    Amyloid_SUVR[i,4]="CN"
  }
  
}

Amyloid_SUVR$DX<-as.factor(Amyloid_SUVR$DX)


###
amyACC3k<- data.frame(matrix(0, 148, 3))
colnames(amyACC3k)<-c("accuracy", "sensitivity","specificity")
AmyloidrocV2_all<-data.frame(matrix(0, nrow(amy_last321), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-Amyloid_SUVR[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
amyACC3k$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
amyACC3k$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
amyACC3k$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
AmyloidrocV2_all[,j]<- as.numeric(amy_last321[,c(11+j)]>=cutpoint)
}

AmyloidrocV2_all<-cbind(amy_last321[, c(1,4)], AmyloidrocV2_all )
 
amyACC3k$SS<-amyACC3k$sensitivity + amyACC3k$specificity

write.csv(AmyloidrocV2_all,  file = "AmyloidrocV2_all.csv")



```


```{r}
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
 
# Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
 
Amyloid_SUVR<-Amyloid_SUVR[ which(Amyloid_SUVR$PTID %in%   scaledN_firstscan_data_321$Var1) ,]

table(Amyloid_SUVR$DX)
TABLE<-data.frame(table(Amyloid_SUVR$PTID))

amy_first321<- as.data.frame(matrix(0,nrow(TABLE), ncol(Amyloid_SUVR)))
amy_last321<- as.data.frame(matrix(0,nrow(TABLE), ncol(Amyloid_SUVR)))
for (i in 1:nrow(TABLE)){
 
amy_first321[i,] <- Amyloid_SUVR[min(which(Amyloid_SUVR$PTID == TABLE$Var1[i])), ]
amy_last321[i,] <- Amyloid_SUVR[max(which(Amyloid_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(amy_last321) <- colnames(Amyloid_SUVR)

colnames(amy_first321) <- colnames(Amyloid_SUVR)
 

amy_last321$DX<-as.factor(amy_last321$DX)

table(amy_last321$DX)

```






```{r}
amyACC321<- data.frame(matrix(0, 148, 3))
colnames(amyACC321)<-c("accuracy", "sensitivity","specificity")
amyrocV2_321<-data.frame(matrix(0, nrow(amy_last321), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-amy_last321[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
amyACC321$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
amyACC321$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
amyACC321$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
amyrocV2_321[,j]<- as.numeric(amy_last321[,c(11+j)]>=cutpoint)
}

amyrocV2_321<-cbind(amy_last321[, c(1,4)],amyrocV2_321 )
 
amyACC321$SS<-amyACC321$sensitivity + amyACC321$specificity

write.csv(amyrocV2_321,  file = "amyrocV2_321.csv")
```

```{r}
amyACC321ORDERED<-amyACC321[order(-amyACC321$SS), ]
amyACC1kORDERED<-amyACC1k[order(-amyACC321$SS), ]
 
amyACC321ORDERED$Data<-rep("321", 148)
 amyACC1kORDERED$Data<-rep("1K", 148)
 amyACC321ORDERED$id<-c(1:148)
amyACC1kORDERED$id<-c(1:148)
TESTV12<-data.frame(rbind(amyACC1kORDERED[, c(4:6)], amyACC321ORDERED[, c(4:6)]))
ggplot(TESTV12, aes(x=id, y=SS, colour=Data)) + geom_line() +labs(x="Amyloid: Node id", y="Sen + Spec")+geom_point() 

```

### tau

```{r}
#Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
 
Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
#Tau_SUVR<- na.omit(Tau_SUVR, cols=c("DX"))
#Tau_SUVR<-Tau_SUVR[ which(Tau_SUVR$PTID %in% setdiff(Tau_SUVR$PTID, scaledN_firstscan_data_321$Var1)) ,]

table(Tau_SUVR$DX)

Tau_SUVR<-Tau_SUVR[which(Tau_SUVR$DX %in% c("AD","CN","LMCI", "EMCI","SMC")),]

for (i in 1:nrow(Tau_SUVR)){
  if (Tau_SUVR[i,4]=="LMCI")  {
    Tau_SUVR[i,4]="AD"
  }
  else if (Tau_SUVR[i,4]=="EMCI")  {
    Tau_SUVR[i,4]="CN"
  }
  else if (Tau_SUVR[i,4]=="SMC")  {
    Tau_SUVR[i,4]="CN"
  }
  
}

Tau_SUVR$DX<-as.factor(Tau_SUVR$DX)
table(Tau_SUVR$DX)
```

```{r}
tauACC823<- data.frame(matrix(0, 148, 3))
colnames(tauACC823)<-c("accuracy", "sensitivity","specificity")
taurocV2_823<-data.frame(matrix(0, nrow(tau_last321), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-Tau_SUVR[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
tauACC823$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
tauACC823$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
tauACC823$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
taurocV2_823[,j]<- as.numeric(tau_last321[,c(11+j)]>=cutpoint)
}

taurocV2_823<-cbind(tau_last321[, c(1,4)],taurocV2_823 )
 
tauACC823$SS<-tauACC823$sensitivity + tauACC823$specificity

write.csv(taurocV2_823,  file = "TAUrocV2_all.csv")
```




```{r}
  
Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
 
Tau_SUVR<-Tau_SUVR[ which(Tau_SUVR$PTID %in%   scaledN_firstscan_data_321$Var1) ,]

table(Tau_SUVR$DX)
TABLE<-data.frame(table(Tau_SUVR$PTID))

tau_first321<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau_SUVR)))

tau_last321<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau_SUVR)))
for (i in 1:nrow(TABLE)){
 
tau_first321[i,] <- Tau_SUVR[min(which(Tau_SUVR$PTID == TABLE$Var1[i])), ]

tau_last321[i,] <- Tau_SUVR[max(which(Tau_SUVR$PTID == TABLE$Var1[i])), ]

}
colnames(tau_last321) <- colnames(Tau_SUVR)

 

tau_last321$DX<-as.factor(tau_last321$DX)

summary(tau_last321$DX)
```

```{r}
tauACC321<- data.frame(matrix(0, 148, 3))
colnames(tauACC321)<-c("accuracy", "sensitivity","specificity")
taurocV2_321<-data.frame(matrix(0, nrow(tau_last321), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-tau_last321[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = ">=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
tauACC321$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
tauACC321$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
tauACC321$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
taurocV2_321[,j]<- as.numeric(tau_last321[,c(11+j)]>=cutpoint)
}

taurocV2_321<-cbind(tau_last321[, c(1,4)],taurocV2_321 )
 
tauACC321$SS<-tauACC321$sensitivity + tauACC321$specificity
```


```{r}
tauACC321ORDERED<-tauACC321[order(-tauACC321$SS), ]
tauACC823ORDERED<-tauACC823[order(-tauACC321$SS), ]
 
tauACC321ORDERED$Data<-rep("321", 148)
 tauACC823ORDERED$Data<-rep("823", 148)
 tauACC321ORDERED$id<-c(1:148)
tauACC823ORDERED$id<-c(1:148)
TESTV12<-data.frame(rbind(tauACC823ORDERED[, c(4:6)], tauACC321ORDERED[, c(4:6)]))
ggplot(TESTV12, aes(x=id, y=SS, colour=Data)) + geom_line() +labs(x="Tau: Node id", y="Sen + Spec")+geom_point() 

```


```{r}
FDG321_last$DX<-scaledN_firstscan_data_321$Var2
```

```{r}
summary(FDG321_last$DX)
32   +97  + 98  + 47  + 47
```


```{r}
# ACC321
ACC321
```

```{r}
FDG321_SMC<-FDG321_last[which(FDG321_last$DX %in% c("AD",   "CN", "EMCI", "LMCI"))  ,]

for (i in 1:nrow(FDG321_SMC)){
  if (FDG321_SMC[i,4]=="LMCI")  {
    FDG321_SMC[i,4]="AD"
  }
  else if (FDG321_SMC[i,4]=="EMCI")  {
    FDG321_SMC[i,4]="CN"
  }
  
}

FDG321_SMC$DX<-as.factor(FDG321_SMC$DX)

```


```{r}
ACC321_SMC<- data.frame(matrix(0, 148, 3))
colnames(ACC321_SMC)<-c("accuracy", "sensitivity","specificity")
rocV2_321_SMC<-data.frame(matrix(0, nrow(FDG321_SMC), 148))
for (j in 1:148){
#df<-NN[,c(4,11+j)]
df<-FDG321_SMC[,c(4,11+j)]

colnames(df)<-c("DX", "NODE")
cp  <- cutpointr( df, NODE, DX,  direction = "<=", pos_class = "AD", method = maximize_metric, metric = sum_sens_spec)
ss<-summary(cp)
#acc[j,2]<-as.numeric(ss$cutpointr[[1]][5])
cutpoint <-summary(cp)$cutpointr[[1]]$optimal_cutpoint
ACC321_SMC$accuracy[j]<-summary(cp)$cutpointr[[1]]$acc
ACC321_SMC$sensitivity[j]<-summary(cp)$cutpointr[[1]]$sensitivity
ACC321_SMC$specificity[j]<-summary(cp)$cutpointr[[1]]$specificity
rocV2_321_SMC[,j]<- as.numeric(FDG321_SMC[,c(11+j)]<=cutpoint)
}
 
ACC321_SMC$SS<-ACC321_SMC$sensitivity+ACC321_SMC$specificity

ACC321_SMC$Data<-rep("321-SMC", 148)
 
 
 
ACC321_SMC$id<-c(1:148)
 

```


```{r}
TESTV12<-data.frame(rbind(ACC321[, c(4:6)], ACC223[, c(4:6)],ACC321_SMC[, c(4:6)] ))
ggplot(TESTV12, aes(x=id, y=SS, colour=Data)) + geom_line() +labs(x="Tau: Node id", y="Sen + Spec")+geom_point() 

```

```{r}
# amy_last321
# FDG321_last
# tau_last321
```

```{r}
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")
 
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
 
Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
```

```{r}
N_last321<-FDG321_last
N_last321[, c(12:159)] <-max(FDG321_last[, c(12:159)] ) -FDG321_last[, c(12:159)]

Mean_amy_last321<- apply(amy_last321[, c(12:159)], 2,mean)
Mean_fdg_last321<- apply(N_last321[, c(12:159)], 2,mean)
Mean_tau_last321<- apply(tau_last321[, c(12:159)], 2,mean)
```

```{r}
#library(heatmaply)

Mean_amy_normalized<-normalize(Mean_amy_last321)
Mean_fdg_normalized<-normalize(Mean_fdg_last321)
Mean_tau_normalized<-normalize(Mean_tau_last321)
 
ATNnormalized<-as.data.frame(cbind(Mean_amy_normalized, Mean_tau_normalized,Mean_fdg_normalized))
colnames(ATNnormalized)<-c("AMY","TAU","N")
```


```{r}
write.csv(ATNnormalized, file="ATNnormalized.csv")
```

```{r}
which(ATNnormalized$AMY > ATNnormalized$TAU & ATNnormalized$TAU >ATNnormalized$N)   # A>T>N

barplot(unlist(ATNnormalized[c(40), c(1,2,3)] ) ,xlab="node 40: A>T>N")
```

```{r}
which(ATNnormalized$AMY > ATNnormalized$N & ATNnormalized$N >ATNnormalized$TAU)   # A>N>T
barplot(unlist(ATNnormalized[c(7),] ) ,xlab="node 7: A>N>T")
```


```{r}
which(ATNnormalized$TAU > ATNnormalized$AMY & ATNnormalized$AMY >ATNnormalized$N)   # T>A>N
barplot(unlist(ATNnormalized[c(72),] ) ,xlab="node 72: T>A>N")
```

```{r}
which(ATNnormalized$TAU > ATNnormalized$N & ATNnormalized$N >ATNnormalized$AMY)   # T>N>A
barplot(unlist(ATNnormalized[c(112),] ) ,xlab="node 112: T>N>A")
```



```{r}
which(ATNnormalized$N > ATNnormalized$TAU & ATNnormalized$TAU >ATNnormalized$AMY)   # N>T>A
barplot(unlist(ATNnormalized[c(109),] ) ,xlab="node 109: N>T>A")
```

```{r}
which(ATNnormalized$N > ATNnormalized$AMY & ATNnormalized$AMY >ATNnormalized$TAU)   # N>A>T
barplot(unlist(ATNnormalized[c(33),] ) ,xlab="node 109: N>A>T")
```


```{r}
#AMY<- as.data.frame(cbind(ATNnormalized$AMY, rep("AMY", 148) ) )
#AMY$V1<-as.numeric(as.character(AMY$V1) )
#AMY<-AMY[order(-AMY$V1), ]
#AMY$id<-c(1:148)

TAU<-as.data.frame(cbind(ATNnormalized$TAU, rep("TAU", 148)   ) )
TAU$V1<-as.numeric(as.character(TAU$V1) )
#TAU<-TAU[order(-AMY$V1), ]
TAU$id<-c(1:148)
NNN<-as.data.frame(cbind(ATNnormalized$N, rep("N", 148)   ) )
NNN$V1<-as.numeric(as.character(NNN$V1) )
#NNN<-NNN[order(-AMY$V1), ]
NNN$id<-c(1:148)
DATA<-rbind(  TAU, NNN)
ggplot(DATA, aes(x=id, y=V1, colour=V2)) + geom_line()+geom_point() 

 
```



```{r}


TAU<-as.data.frame(cbind(ATNnormalized$TAU, rep("TAU", 148)   ) )
TAU$V1<-as.numeric(as.character(TAU$V1) )
TAU<-TAU[order(-TAU$V1), ]
TAU$id<-c(1:148)

AMY<- as.data.frame(cbind(ATNnormalized$AMY, rep("AMY", 148) ) )
AMY$V1<-as.numeric(as.character(AMY$V1) )
#AMY<-AMY[order(-TAU$V1), ]
AMY$id<-c(1:148)

NNN<-as.data.frame(cbind(ATNnormalized$N, rep("N", 148)   ) )
NNN$V1<-as.numeric(as.character(NNN$V1) )
#NNN<-NNN[order(-TAU$V1), ]
NNN$id<-c(1:148)
DATA<-rbind(AMY, TAU, NNN)
ggplot(DATA, aes(x=id, y=V1, colour=V2)) + geom_line()+geom_point() 

```




```{r}
#library(heatmaply)

Mean_amy_normalized<-normalize(Mean_amy_last321)
Mean_fdg_normalized<-normalize(Mean_fdg_last321)
Mean_tau_normalized<-normalize(Mean_tau_last321)
 
ATNnormalized<-as.data.frame(cbind(Mean_amy_normalized, Mean_tau_normalized,Mean_fdg_normalized))
colnames(ATNnormalized)<-c("AMY","TAU","N")
 
which(ATNnormalized$AMY > ATNnormalized$TAU & ATNnormalized$TAU >ATNnormalized$N)   # A>T>N

barplot(unlist(ATNnormalized[c(40),] ) ,xlab="node 40: A>T>N")
```


```{r}
#library(heatmaply)

Mean_amy_normalized<-percentize(Mean_amy_last321)
Mean_fdg_normalized<-percentize(Mean_fdg_last321)
Mean_tau_normalized<-percentize(Mean_tau_last321)
 
ATNnormalized<-as.data.frame(cbind(Mean_amy_normalized, Mean_tau_normalized,Mean_fdg_normalized))
colnames(ATNnormalized)<-c("AMY","TAU","N")
 
which(ATNnormalized$AMY > ATNnormalized$TAU & ATNnormalized$TAU >ATNnormalized$N)   # A>T>N

barplot(unlist(ATNnormalized[c(40),] ) ,xlab="node 40: A>T>N")
```







```{r}
hist(ATNnormalized$AMY, main="Histogram",xlab="amyloid", breaks= 20)
```




```{r}
which(ATNnormalized$AMY >=.6 & ATNnormalized$TAU >=0.6 & ATNnormalized$N >=0.6)
```

```{r}
ATNnormalized[23,]
```


```{r}
ATNnormalized<-as.data.frame(cbind(Mean_amy_normalized, Mean_tau_normalized,Mean_fdg_normalized))
colnames(ATNnormalized)<-c("AMY","TAU","N")
ATNnormalized<-ATNnormalized[order(-ATNnormalized$AMY),]
ATNnormalized<-ATNnormalized[,c(3,2,1)]

ATNnormalized$id<-c(1:148)

dataATN <-melt(ATNnormalized, id.vars = c("id"))

ggplot(data=dataATN, aes(x=id, y=value, fill=variable )) +
  geom_bar(stat="identity" ) + 
  scale_fill_manual("legend", values = c("AMY" = "#F8766D", "TAU" = "#00BFC4", "N" ="#7CAE00"))+
  labs(x="Nodes ordered by Amyloid")+ guides(size = "none"  ) +  
  theme_bw()    +
  theme( aspect.ratio=4/5,
    axis.title.y=element_blank(),
    
    text = element_text(size=30),
     
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.03,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    )
```

## 03/22

```{r}
which(ATNnormalized$AMY > ATNnormalized$TAU & ATNnormalized$TAU >ATNnormalized$N)   # A>T>N
```

```{r}
dataATN <-melt(ATNnormalized[which(ATNnormalized$AMY > ATNnormalized$TAU & ATNnormalized$TAU >ATNnormalized$N) , ], id.vars = c("id"))
ggplot(data=dataATN, aes(x=id, y=value, fill=variable )) +
  geom_bar(stat="identity" ) +  scale_fill_manual( values = c("#7CAE00",  "#00BFC4", "#F8766D")) +labs(x="Nodes ordered by Amyloid")+ guides(size = "none"  ) +  
  theme_bw()    +
  theme( aspect.ratio=4/5,
    axis.title.y=element_blank(),
    
    text = element_text(size=30),
     
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.03,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    )
```



```{r}
N_last320<-FDG_N_lastscan[which(FDG_N_lastscan$Var1 %in% amy_last320$PTID), ]


Mean_amy_last321<- apply(amy_last320[, c(12:159)], 2,mean)
Mean_fdg_last321<- apply(N_last320[, c(4:151)], 2,mean)
Mean_tau_last321<- apply(tau_last320[, c(12:159)], 2,mean)


Mean_amy_normalized<-normalize(Mean_amy_last321)
Mean_fdg_normalized<-normalize(Mean_fdg_last321)
Mean_tau_normalized<-normalize(Mean_tau_last321)
 
ATNnormalized<-as.data.frame(cbind(Mean_amy_normalized, Mean_tau_normalized,Mean_fdg_normalized))
colnames(ATNnormalized)<-c("Amyloid","Tau","N")

ATNnormalized$sum<-ATNnormalized$Amyloid+ATNnormalized$Tau+ATNnormalized$N


 ATNnormalized$pred<-apply(pred22[, c(3:150)],2, mean)
#  ATNnormalized<-ATNnormalized[order(-ATNnormalized$pred),]
```

```{r}
first20<- rownames(ATNnormalized)[1:20]
first10<- rownames(ATNnormalized)[1:10]
```



```{r}

ATNnormalized<-ATNnormalized[order(-ATNnormalized$sum),]
ATNnormalized<-ATNnormalized[, ]

ATNnormalized$id<-c(1:148)
```


```{r}
#ATNnormalized<-ATNnormalized[which(rownames(ATNnormalized) %in% first10), c(3,2,1,6)]

#dataATN <-melt(ATNnormalized, id.vars = c("id"))
 
ATNhistogram <- ggplot(data=dataATN, aes(x=id, y=value, fill=variable )) +
  geom_bar(stat="identity" ) + 
   scale_fill_manual("legend", values = c("Amyloid" = "#F8766D", "Tau" = "#00BFC4", "N" ="#7CAE00"),breaks=c('Amyloid','Tau','N'),  labels=c('Amyloid','Tau','N')) +
  labs(x="Nodes ordered by sum ATN")+ guides(size = "none"  ) +  
  theme_bw()    +
  theme( aspect.ratio=3/4,
    axis.title.y=element_blank(),
    
    text = element_text(size=30),
     
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.13,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    ) + scale_x_discrete(labels=id, breaks=id)

ATNhistogram
ggsave(
  file="ATNhistogram.png",
  plot = ATNhistogram,
  device = "png",
 # path = NULL,
  #scale = 1,
  width = 4*1.8,
  height = 3*1.8,
  units = "in"
  #dpi = 300,
  #limitsize = TRUE,
)

```


```{r}

```



```{r}
length(which(ATNnormalized$Amyloid > ATNnormalized$Tau & ATNnormalized$Tau >ATNnormalized$N))  # A>T>N
  
length(which(ATNnormalized$Amyloid > ATNnormalized$N & ATNnormalized$N >ATNnormalized$Tau))   # A>N>T
  
length(which(ATNnormalized$Tau > ATNnormalized$Amyloid & ATNnormalized$Amyloid >ATNnormalized$N))   # T>A>N
  
length(which(ATNnormalized$Tau > ATNnormalized$N & ATNnormalized$N >ATNnormalized$Amyloid))   # T>N>A
  
length(which(ATNnormalized$N > ATNnormalized$Tau & ATNnormalized$Tau >ATNnormalized$Amyloid))   # N>T>A

length(which(ATNnormalized$N > ATNnormalized$Amyloid & ATNnormalized$Amyloid >ATNnormalized$Tau))   # N>A>T
```


```{r}
# pie chart


library(dplyr)

data <- data.frame(
  group=c("A>T>N", "A>N>T", "T>A>N","T>N>A", "N>T>A","N>A>T"),
  value=c(35,46,26,7,4,30)
)

ggplot(data, aes(x="", y=value, fill=group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  
  theme_void() # remove background, grid, numeric labels



# Compute the position of labels
data <- data %>% 
  arrange(desc(group)) %>%
  mutate(prop = value / sum(data$value) *100) %>%
  mutate(ypos =  cumsum(prop)- 0.5*prop -1)

# Basic piechart
ggplot(data, aes(x="", y=prop, fill=group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() + 
  theme(legend.position="none") +
  geom_text(aes(y = ypos, label = group), color = "black", size=6) +
  scale_fill_brewer(palette="Paired") 
```




```{r}


dataATN <-melt(ATNnormalized[which(ATNnormalized$Amyloid > ATNnormalized$Tau & ATNnormalized$Tau >ATNnormalized$N),], id.vars = c("id"))

ggplot(data=dataATN, aes(x=id, y=value, fill=variable )) +
  geom_bar(stat="identity" ) + 
  scale_fill_manual("legend", values = c("Amyloid" = "#F8766D", "Tau" = "#00BFC4", "N" ="#7CAE00"),breaks=c('Amyloid','Tau','N'),  labels=c('Amyloid','Tau','N')) +
  labs(x="Nodes ordered by Amyloid")+ guides(size = "none"  ) +  
  theme_bw()    +
  theme( aspect.ratio=4/5,
    axis.title.y=element_blank(),
    
    text = element_text(size=30),
     
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.03,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    )
```


```{r}
Mean_amy_first321<- apply(amy_first321[, c(12:159)], 2,mean)
Mean_fdg_first321<- apply(FDG321_first[, c(12:159)], 2,mean)
Mean_tau_first321<- apply(tau_first321[, c(12:159)], 2,mean)


Mean_amy_last321<- apply(amy_last321[, c(12:159)], 2,mean)
Mean_fdg_last321<- apply(FDG321_last[, c(12:159)], 2,mean)
Mean_tau_last321<- apply(tau_last321[, c(12:159)], 2,mean)
```

```{r}
intersect(intersect(which(Mean_amy_first321 < Mean_amy_last321),which(Mean_tau_first321 < Mean_tau_last321) ), which(Mean_fdg_last321< Mean_fdg_first321 ))
```

A1<A2 AND T1<T2 AND F1>F2

```{r}
Mean_amy_first321<- apply(amy_first321[, c(12:159)], 2,mean)
Mean_fdg_first321<- apply(FDG321_first[, c(12:159)], 2,mean)
Mean_tau_first321<- apply(tau_first321[, c(12:159)], 2,mean)


Mean_amy_last321<- apply(amy_last321[, c(12:159)], 2,mean)
Mean_fdg_last321<- apply(FDG321_last[, c(12:159)], 2,mean)
Mean_tau_last321<- apply(tau_last321[, c(12:159)], 2,mean)

deltaAmy<- (Mean_amy_last321-Mean_amy_first321)/Mean_amy_first321
deltaTau<- (Mean_tau_last321-Mean_tau_first321)/Mean_tau_first321
deltaFDG<-(Mean_fdg_first321- Mean_fdg_last321)/Mean_fdg_first321

```

```{r}




deltaTau<-as.data.frame(cbind(deltaTau,  rep("T", 148)) )
colnames(deltaTau)<-c("delta","name")
deltaTau$delta<-as.numeric(as.character(deltaTau$delta))
deltaTauORDERED<-deltaTau[order(-deltaTau$delta), ]
deltaTauORDERED$id<-c(1:148)


deltaAmy<-as.data.frame(cbind(deltaAmy,  rep("A", 148)) )
colnames(deltaAmy)<-c("delta" ,"name")
deltaAmy$delta<-as.numeric(as.character(deltaAmy$delta))
deltaAmyORDERED<-deltaAmy[order(-deltaTau$delta), ]
deltaAmyORDERED$id<-c(1:148)


deltaFDG<-as.data.frame(cbind(deltaFDG,   rep("FDG", 148)) )
colnames(deltaFDG)<-c("delta", "name")
deltaFDG$delta<-as.numeric(as.character(deltaFDG$delta))
deltaFDGORDERED<-deltaFDG[order(-deltaTau$delta), ]
deltaFDGORDERED$id<-c(1:148)


TESTV12<-data.frame(rbind(deltaAmyORDERED, deltaTauORDERED, deltaFDGORDERED))
 
ggplot(TESTV12, aes(x=id, y=delta, colour=name)) + geom_line()  +geom_point()+labs(y="scaled difference")
```


```{r}
## delta amy
colnames(amy_first321) <-colnames(amy_last321)
delta_amy<-amy_last321

delta_amy[, c(12:159)]<- amy_last321[, c(12:159)] - amy_first321[, c(12:159)] 
delta_amy$DX<-V2_321_roc$Var2
```

```{r}
table(delta_amy$DX)
```

```{r}
for (i in 1:nrow(delta_amy)){
  if (delta_amy[i,4]=="LMCI")  {
    delta_amy[i,4]="AD"
  }
  else if (delta_amy[i,4]=="SMC")  {
    delta_amy[i,4]="CN"
  }
  else if (delta_amy[i,4]=="EMCI")  {
    delta_amy[i,4]="CN"
  }
}
```

```{r}
delta_amy<-delta_amy[ -80, ]
Amy_Pvalue<-as.data.frame(c(1:148))
colnames(Amy_Pvalue)<-"Amy_Pvalue"
for (j in 1:148){
res.aov <- aov(delta_amy[, c(11+j)] ~ DX, data = delta_amy)
suM<- summary(res.aov)
Amy_Pvalue[j,1] <- suM[[1]][1,5]
}
```

 

```{r}
## delta tau
colnames(tau_first321) <-colnames(tau_last321)
delta_tau<-tau_last321

delta_tau[, c(12:159)]<- tau_last321[, c(12:159)] - tau_first321[, c(12:159)] 
delta_tau$DX<-V2_321_roc$Var2
```
 

```{r}
table(delta_tau$DX)
```

```{r}
for (i in 1:nrow(delta_tau)){
  if (delta_tau[i,4]=="LMCI")  {
    delta_tau[i,4]="AD"
  }
  else if (delta_tau[i,4]=="SMC")  {
    delta_tau[i,4]="CN"
  }
  else if (delta_tau[i,4]=="EMCI")  {
    delta_tau[i,4]="CN"
  }
}
```

```{r}
delta_tau<-delta_tau[ -80, ]
Tau_Pvalue<-as.data.frame(c(1:148))
colnames(Tau_Pvalue)<-"Tau_Pvalue"
for (j in 1:148){
res.aov <- aov(delta_tau[, c(11+j)] ~ DX, data = delta_tau)
suM<- summary(res.aov)
Tau_Pvalue[j,1] <- suM[[1]][1,5]
}
 
```
 

```{r}
## delta fdg
colnames(FDG321_first) <-colnames(FDG321_last)
delta_fdg<-FDG321_last

delta_fdg[, c(12:159)]<- FDG321_last[, c(12:159)] - FDG321_first[, c(12:159)] 
delta_fdg$DX<-V2_321_roc$Var2
```

```{r}
table(delta_fdg$DX)
```

```{r}
for (i in 1:nrow(delta_fdg)){
  if (delta_fdg[i,4]=="LMCI")  {
    delta_fdg[i,4]="AD"
  }
  else if (delta_fdg[i,4]=="SMC")  {
    delta_fdg[i,4]="CN"
  }
   else if (delta_fdg[i,4]=="EMCI")  {
    delta_fdg[i,4]="CN"
  }
}
```

```{r}
delta_fdg<-delta_fdg[ -80,]
FDG_Pvalue<-as.data.frame(c(1:148))
colnames(FDG_Pvalue)<-"FDG_Pvalue"
for (j in 1:148){
res.aov <- aov(delta_fdg[, c(11+j)] ~ DX, data = delta_fdg)
suM<- summary(res.aov)
FDG_Pvalue[j,1] <- suM[[1]][1,5]
}
 
```
 



```{r}
which(Amy_Pvalue<0.01)
```

```{r}
which(Tau_Pvalue<0.01)
```

```{r}
which(FDG_Pvalue<0.01)
```
```{r}
intersect(which(Tau_Pvalue<0.01),which(FDG_Pvalue<0.01) )
```


```{r}
pred <- read.csv("~/Documents/2020 research/AD_MODEL/pred.csv", header=FALSE)
pred<-pred[, c(1:148)]
```

```{r}
 
AmyPredict_Pvalue<-as.data.frame(rep(1, 148))*99


colnames(AmyPredict_Pvalue)<-"AmyPredict_Pvalue"
for (j in 1:148){
  if (sum(pred[, j]) < 320 & sum(pred[, j]) >0  ){
res.aov<- aov(delta_amy[, c(11+j)] ~ as.factor(pred[,j]) )
suM<- summary(res.aov)
AmyPredict_Pvalue[j,1] <- suM[[1]][1,5]
  }
  
}
```

```{r}
 
TauPredict_Pvalue<-as.data.frame(rep(1, 148))*99


colnames(TauPredict_Pvalue)<-"TauPredict_Pvalue"
for (j in 1:148){
  if (sum(pred[, j]) < 320 & sum(pred[, j]) >0  ){
res.aov<- aov(delta_tau[, c(11+j)] ~ as.factor(pred[,j]) )
suM<- summary(res.aov)
TauPredict_Pvalue[j,1] <- suM[[1]][1,5]
  }
  
}
```
 

```{r}
 
FdgPredict_Pvalue<-as.data.frame(rep(1, 148))*99


colnames(FdgPredict_Pvalue)<-"FdgPredict_Pvalue"
for (j in 1:148){
  if (sum(pred[, j]) < 320 & sum(pred[, j]) >0  ){
res.aov<- aov(delta_fdg[, c(11+j)] ~ as.factor(pred[,j]) )
suM<- summary(res.aov)
FdgPredict_Pvalue[j,1] <- suM[[1]][1,5]
  }
  
}
```


```{r}
which(AmyPredict_Pvalue<0.01)
```

```{r}
which(TauPredict_Pvalue<0.01)
```

```{r}
which(FdgPredict_Pvalue<0.01)
```

```{r}
intersect(which(AmyPredict_Pvalue<0.05), which(TauPredict_Pvalue<0.05))
```


```{r}
intersect(which(FdgPredict_Pvalue<0.01), which(FDG_Pvalue<0.01))
```

```{r}
M_delta_fdg<-apply(delta_fdg[, c(12:159)], 2, mean) 
M_pred<-apply(pred, 2, mean)
M_fdg_last<-apply(FDG321_last[, c(12:159)], 2, mean)
data<-as.data.frame(cbind(M_delta_fdg,M_pred,M_fdg_last ) )
```


```{r}
M_fdg_last<-as.data.frame(M_fdg_last)
M_fdg_last<- as.data.frame( M_fdg_last[order(-data$fdg), ] )
colnames(M_fdg_last)<-"M_fdg_last"
M_fdg_last$id<-c(1:148)
M_fdg_last$name<-rep("lastscan", 148)
colnames(M_fdg_last)[1]<-"value"

data<-as.data.frame(apply(100*delta_fdg[, c(12:159)], 2, mean) )
colnames(data)<-"fdg"
M_delta_fdg<-as.data.frame(data[order(-data$fdg), ])
M_delta_fdg$id<-c(1:148)
M_delta_fdg$name<-rep("delta_fdg", 148)
colnames(M_delta_fdg)[1]<-"value"

M_pred<-as.data.frame(M_pred)
M_pred<- as.data.frame( M_pred[order(-data$fdg), ] )
colnames(M_pred)<-"M_pred"
M_pred$id<-c(1:148)
M_pred$name<-rep("predition", 148)
colnames(M_pred)[1]<-"value"



TESTV12<-data.frame(rbind(M_delta_fdg, M_pred, M_fdg_last))
 
ggplot(TESTV12, aes(x=id, y=value, colour=name)) + geom_line()  +geom_point()+labs(y="")
```

```{r}



```
 
```{r}
M_delta_fdg<-apply(delta_fdg[, c(12:159)], 2, mean) 
M_pred<-apply(pred, 2, mean)
M_fdg_last<-apply(FDG321_last[, c(12:159)], 2, mean)
data<-as.data.frame(cbind(M_delta_fdg,M_pred,M_fdg_last ) )

ggplot(data, aes(x=M_fdg_last   , y= M_delta_fdg )  )+geom_point()+  geom_smooth(method="lm",se=F)

```


```{r}
j=1
data<- as.data.frame(cbind(delta_fdg[, c(11+j)],  pred[,j])) 
data$V2<-as.factor(as.character(data$V2))

ggplot(data, aes(x=V1, fill=V2)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity')+labs(x="node 1", y="delta_fdg")
```



```{r}
j=17
data<-  delta_fdg[, c(4, 11+j)] 
colnames(data)[2]<-"V1" 

ggplot(data, aes(x=V1, fill=DX)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity')+labs(x="node 17", y="delta_fdg")
```

```{r}
#  17  32  35  66  91 109 122

j=146
data<- as.data.frame(cbind(delta_fdg[, c(11+j)],  pred[,j])) 
data$V2<-as.factor(as.character(data$V2))

ggplot(data, aes(x=V1, fill=V2)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity')+labs(x="node 146", y="delta_fdg")
```

## March 11
```{r}
FDG_SUVR <- read_excel("~/Downloads/FDG_SUVR.xlsx")
 
Amyloid_SUVR <- read_excel("~/Downloads/Amyloid_SUVR.xlsx")
 
Tau_SUVR <- read_excel("~/Downloads/Tau_SUVR.xlsx")
```


```{r}
## P_N_last_321_0224: observed probability
```

```{r}
Pobserved320<-apply( P_N_last_321_0224[-80, c(4:151)], 2, mean)
hist(Pobserved320)
```



```{r}
Ppredict320<-apply(pred, 2, mean)
hist(Ppredict320)
```

```{r}
Pdata<-as.data.frame(cbind(Pobserved320, Ppredict320) )
Pdata$Status<-rep("Overestimated", nrow(Pdata))

for (i in 1:nrow(Pdata)){
  if (Pdata$Pobserved320[i] > Pdata$Ppredict320[i] ){
    Pdata$Status[i]<-"Underestimated"
  }
}


ggplot(Pdata, aes(x=Ppredict320 , y=Pobserved320, col=Status))+
  geom_point( )+geom_abline(intercept = 0, slope = 1)+labs(x="Predicted N positive probability", y= "Observed N positive probability",  title="Data: N")
```

```{r}
Pdata$Residual<-Pdata$Pobserved320-Pdata$Ppredict320
 
lm<-lm( Residual~Amyloid320MEAN,Pdata )
summary(lm)
ggplot(Pdata, aes(y=Residual, x= Amyloid320MEAN))+
  geom_point()+
  labs(x="Regional amyloid", y="Model Reisudual")+geom_smooth(method="lm")+
  annotate("text", x =2, y = 1, parse = TRUE,
           label = " r^2 ==  0.04749")

```
```{r}
lm<-lm( Residual~ Tau320MEAN,Pdata )
summary(lm)
ggplot(Pdata, aes(y=Residual, x= Tau320MEAN))+
  geom_point()+
  labs(x="Regional tau", y="Model Reisudual")+geom_smooth(method="lm")+
  annotate("text", x =1.72, y = .71, parse = TRUE,
           label = " r^2 ==  0.1056")

```

```{r}
Amyloid320<-Amyloid_SUVR[which(Amyloid_SUVR$PTID %in% P_N_last_321_0224[-80,1]) ,]

TABLE<-data.frame(table(Amyloid320$PTID))

View(Amyloid320)
```

```{r}
Tau320<-Tau_SUVR[which(Tau_SUVR$PTID %in% P_N_last_321_0224[-80,1]) ,]

TABLE<-data.frame(table(Tau320$PTID))

 
```



```{r}
Pdata$Amyloid320MEAN<-apply(Amyloid320[, c(12:159) ],2, mean)
Pdata$Tau320MEAN<-apply(Tau320[, c(12:159) ],2, mean)
```

```{r}
ggplot(Pdata, aes(x = Status, y =Amyloid320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="Amyloid")
```


```{r}
ggplot(Pdata, aes(x = Status, y =Tau320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="Tau")
```

```{r}
## Two component for Tau
Tau_2component_Info<-as.data.frame(matrix(0,148, 6))
colnames(Tau_2component_Info)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
   tryCatch({
  X<-unlist(tau_last320[, c(11+i)])
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
 Tau_2component_Info[i,c(1,2) ]<-  EST$mu
 Tau_2component_Info[i, c(3,4)]<-EST$sigma
  mu.true<- EST$mu
sigma.true<- EST$sigma
L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])
#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Tau_2component_Info[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
}
```

```{r}

Tau_2component_Info[which(Tau_2component_Info$mu1  > Tau_2component_Info$mu2), ]<- Tau_2component_Info[which(Tau_2component_Info$mu1  > Tau_2component_Info$mu2), c(2,1,4,3,6,5)]
hist(Tau_2component_Info$P2)
```


```{r}


## Two component for Tau
Amy_2component_Info<-as.data.frame(matrix(0,148, 6))
colnames(Amy_2component_Info)<-c("mu1", "mu2", "sigma1","sigma2" ,"P1","P2")
for (i in 1:148){
   tryCatch({
  X<-unlist(Amyloid320[, c(11+i)])
  
  EST<-normalmixEM(X, lambda = NULL, mu = NULL, sigma = NULL, k = 2,
mean.constr = NULL, sd.constr = NULL,
epsilon = 1e-08, maxit = 1000, maxrestarts=20,
verb = FALSE, fast=FALSE, ECM = FALSE,
arbmean = TRUE, arbvar = TRUE)
 Amy_2component_Info[i,c(1,2) ]<-  EST$mu
 Amy_2component_Info[i, c(3,4)]<-EST$sigma
  mu.true<- EST$mu
sigma.true<- EST$sigma
L = matrix(NA, nrow=length(X), ncol= 2)
L[, 1] = dnorm(X, mean=mu.true[1], sd = sigma.true[1])
L[, 2] = dnorm(X, mean=mu.true[2], sd = sigma.true[2])
#perform EM
ee <- mixture.EM(w.init=c(0.5,0.5), L)
Amy_2component_Info[i,c(5,6)]<-ee[[1]] 
 }
   , error=function(e) NULL)
}


Amy_2component_Info[which(Amy_2component_Info$mu1  > Amy_2component_Info$mu2), ]<- Amy_2component_Info[which(Amy_2component_Info$mu1  > Amy_2component_Info$mu2), c(2,1,4,3,6,5)]
hist(Amy_2component_Info$P2)
```


```{r}
amy_last320<-amy_last321[-80,]
tau_last320<-tau_last321[-80,]
```


```{r}
PPP<-data.frame(matrix(0, nrow(amy_last320), 148))
P_Amy_320last<-cbind(amy_last320[,c(1,4)],PPP )
 for (j in 1:148){
  for (i in 1:nrow(amy_last320)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_Amy_320last[i,j+2]<- pnorm(amy_last320[i,j+11], mean = Amy_2component_Info$mu2[j], sd = Amy_2component_Info$sigma2[j], lower.tail = TRUE) 
   
     
  }
 }


View(P_Amy_320last)
P_Amy_320last$Label<-scaledN_firstscan_data_321_J[-80,2]
``` 


```{r}
PPP<-data.frame(matrix(0, nrow(tau_last320), 148))
P_T_320last<-cbind(tau_last320[,c(1,4)],PPP )
 for (j in 1:148){
  for (i in 1:nrow(tau_last320)){
     
#    PP[i,j-2]<-(pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67       )/( pAD *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="AD") ,j] <= lastscan_reversedN[i,j] ))/67 +pCN *sum(as.numeric( lastscan_reversedN[which(lastscan_reversedN$Var3=="CN") ,j] <= lastscan_reversedN[i,j] ))/232  )
     P_T_320last[i,j+2]<- pnorm(tau_last320[i,j+11], mean = Tau_2component_Info$mu2[j], sd = Tau_2component_Info$sigma2[j], lower.tail = TRUE) 
   
     
  }
 }


View(P_T_320last)
P_T_320last$Label<-scaledN_firstscan_data_321_J[-80,2]
``` 

```{r}
Pobserved320Tau<-apply( P_T_320last[, c(3:150)], 2, mean)
hist(Pobserved320Tau)
```



```{r}
PdataTau<-as.data.frame(cbind(Pobserved320Tau, Ppredict320) )
PdataTau$Status<-rep("Overestimated", nrow(PdataTau))

for (i in 1:nrow(PdataTau)){
  if (PdataTau$Pobserved320Tau[i] > PdataTau$Ppredict320[i] ){
    PdataTau$Status[i]<-"Underestimated"
  }
}


ggplot(PdataTau, aes(x=Ppredict320 , y=Pobserved320Tau, col=Status))+
  geom_point( )+geom_abline(intercept = 0, slope = 1)+labs(x="Predicted Tau positive probability", y= "Observed Tau positive probability" )
```


```{r}
PdataTau$Amyloid320MEAN<-apply(Amyloid320[, c(12:159) ],2, mean)
 
 
ggplot(PdataTau, aes(x = Status, y =Amyloid320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="Amyloid")
```


```{r}

FDG320<-FDG_SUVR[which(FDG_SUVR$PTID %in% Amyloid320$PTID ),]

PdataTau$FDG320MEAN<-apply(FDG320[, c(12:159) ],2, mean)
 
 
ggplot(PdataTau, aes(x = Status, y =FDG320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="FDG")
```


```{r}
PdataTau$Tau320MEAN<- Pdata$Tau320MEAN
ggplot(PdataTau, aes(x = Status, y =Tau320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="Tau")
```



```{r}

PdataTau$Residual<-PdataTau$Pobserved320Tau -PdataTau$Ppredict320

lm<-lm( Residual~Amyloid320MEAN ,PdataTau )
summary(lm)
ggplot(PdataTau, aes(y=Residual, x= Amyloid320MEAN))+
  geom_point()+
  labs(x="Regional Amyloid", y="Model Reisudual (Tau)")+geom_smooth(method="lm")+
  annotate("text", x =2, y = -.71, parse = TRUE,
           label = " r^2 ==  0.03335")

```

```{r}

PdataTau$Residual<-PdataTau$Pobserved320Tau -PdataTau$Ppredict320

lm<-lm( Ppredict320~FDG320MEAN ,PdataTau )
summary(lm)
ggplot(PdataTau, aes(y=Ppredict320, x= FDG320MEAN))+
  geom_point()+
  labs(x="Regional FDG", y="Predicted Tau positive probability")+geom_smooth(method="lm")+
  annotate("text", x =1, y = -.71, parse = TRUE,
           label = " r^2 ==  0.8719")

```



```{r}
Pobserved320Amy<-apply( P_Amy_320last[, c(3:150)], 2, mean)
 
PdataAmy<-as.data.frame(cbind(Pobserved320Amy, Ppredict320) )
PdataAmy$Status<-rep("Overestimated", nrow(PdataAmy))

for (i in 1:nrow(PdataAmy)){
  if (PdataAmy$Pobserved320Amy[i] > PdataAmy$Ppredict320[i] ){
    PdataAmy$Status[i]<-"Underestimated"
  }
}


ggplot(PdataAmy, aes(x=Ppredict320 , y=Pobserved320Amy, col=Status))+
  geom_point( )+geom_abline(intercept = 0, slope = 1)+labs(x="Predicted Amy positive probability", y= "Observed Amy positive probability" )
```


```{r}
PdataAmy$Tau320MEAN <-Pdata$Tau320MEAN
PdataAmy$FDG320MEAN<- PdataTau$FDG320MEAN
```



```{r}
  
ggplot(PdataAmy, aes(x = Status, y =Tau320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="Tau")
```


```{r}
PdataAmy$Residual<- PdataAmy$Pobserved320Amy-PdataAmy$Ppredict320

lm<-lm( Residual~FDG320MEAN ,PdataAmy )
summary(lm)
ggplot(PdataAmy, aes(y=Residual, x= FDG320MEAN))+
  geom_point()+
  labs(x="Regional FDG", y="Model Reisudual (Amy)")+geom_smooth(method="lm")+
  annotate("text", x =1, y = -.71, parse = TRUE,
           label = " r^2 ==  0.8472")

```





```{r}
lm<-lm( Residual~Tau320MEAN ,PdataAmy )
summary(lm)
ggplot(PdataAmy, aes(y=Residual, x= Tau320MEAN))+
  geom_point()+
  labs(x="Regional Tau", y="Model Reisudual (Amy)")+geom_smooth(method="lm")+
  annotate("text", x =1.7, y = -.71, parse = TRUE,
           label = " r^2 ==  0.1543")

```

```{r}
FDG_last320 <-  FDG_last[-80,]
```

```{r}
FDG_last320Mean<-apply(FDG_last320[ , c(12:159)], 2, mean   )

Pdatafdg320<-as.data.frame(cbind(FDG_last320Mean, Ppredict320) )

```


```{r}

lm<- lm(Ppredict320 ~FDG_last320Mean ,Pdatafdg320  )
summary(lm)

ggplot(Pdatafdg320, aes(x= FDG_last320Mean , y=Ppredict320 ) ) +geom_point()+
  geom_smooth(method="lm") +
  annotate("text", x =1.7, y = -.71, parse = TRUE,
           label = " r^2 ==  0.8739")

Pdatafdg320$Residual<-lm$residuals

```

```{r}
Pdatafdg320$Tau320MEAN <-Pdata$Tau320MEAN
Pdatafdg320$FDG320MEAN<- PdataTau$FDG320MEAN
Pdatafdg320$Amyloid320MEAN <-Pdata$Amyloid320MEAN

```
 
```{r}
Pdatafdg320$Status<-rep("Overestimated", nrow(Pdatafdg320))

for (i in 1:nrow(Pdatafdg320)){
  if (Pdatafdg320$Residual[i] > 0 ){
    Pdatafdg320$Status[i]<-"Underestimated"
  }
}
```
 
 
```{r}
  
ggplot(Pdatafdg320, aes(x = Status, y =Amyloid320MEAN, fill=Status )) +
  geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())+labs(y="Amyloid")
```


```{r}
Predict320ATN <- Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATN<-Predict320ATN[order(-Predict320ATN$Ppredict320), ]
Predict320ATN$id<-c(1:148)
```
 
```{r}
library(reshape2)
```
 
```{r}
dataMelt<-melt(Predict320ATN, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="")
```

```{r}
pred2 <- read.csv("~/Documents/2020 research/AD_MODEL/pred2.csv", header=FALSE)
pred2<-pred2[, c(1:148)]
```

```{r}


Predict320ATNv2<- Predict320ATN
Predict320ATNv2$Ppredict320<-apply(pred2, 2, mean)

Predict320ATNv2<-Predict320ATNv2[order(-Predict320ATNv2$Ppredict320), ]
Predict320ATNv2$id<-c(1:148)

dataMelt<-melt(Predict320ATNv2, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="", title="pred2")
```


```{r}
Predict320ATNv2<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv2$Amy320last<-apply(amy_last320[, c(12:159)], 2 , mean)
Predict320ATNv2$Tau320last<-apply(tau_last320[, c(12:159)], 2 , mean)
Predict320ATNv2$FDG320last<-apply(FDG_last320[, c(12:159)], 2 , mean)
Predict320ATNv2$Ppredict320<-apply(pred2, 2, mean)

Predict320ATNv2<-Predict320ATNv2[order(-Predict320ATNv2$Ppredict320), ]
Predict320ATNv2$id<-c(1:148)
 
Predict320ATNv2<-Predict320ATNv2[,-c(2,3,4)]
dataMelt<-melt(Predict320ATNv2, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="", title="pred2")

```


```{r}

Predict320ATNv1<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv1$Amy320last<-apply(amy_last320[, c(12:159)], 2 , mean)
Predict320ATNv1$Tau320last<-apply(tau_last320[, c(12:159)], 2 , mean)
Predict320ATNv1$FDG320last<-apply(FDG_last320[, c(12:159)], 2 , mean)
Predict320ATNv1$Ppredict320 <- apply(pred, 2, mean)

Predict320ATNv1<-Predict320ATNv1[order(-Predict320ATNv1$Ppredict320), ]
Predict320ATNv1$id<-c(1:148)
 
Predict320ATNv1<-Predict320ATNv1[,-c(2,3,4)]
dataMelt<-melt(Predict320ATNv1, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="", title="pred1")

```





```{r}
plot(x=Predict320ATNv1$Ppredict320, y=Predict320ATNv1$FDG320last)
  
plot(x=Predict320ATNv2$Ppredict320, y=Predict320ATNv2$FDG320last)
```



```{r}
Predict320ATNv1<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv1$Ppredict320 <- apply(pred, 2, mean)
Predict320ATNv1$deltaAmy <- apply(delta_amy[ , c(12:159)], 2, mean  )*5
Predict320ATNv1$deltaTau <- apply(delta_tau[ , c(12:159)], 2, mean  )*5
Predict320ATNv1$deltaFDG <- apply(delta_fdg[ , c(12:159)], 2, mean  )*5
Predict320ATNv1 <- Predict320ATNv1[, -c(2,3,4)]

Predict320ATNv1<-Predict320ATNv1[order(-Predict320ATNv1$Ppredict320), ]
Predict320ATNv1$id<-c(1:148)
dataMelt<-melt(Predict320ATNv1, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="", title="pred1, delta (multipled by 5 )")

```

```{r}
Predict320ATNv2<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv2$Ppredict320 <- apply(pred2, 2, mean)
Predict320ATNv2$deltaAmy <- apply(delta_amy[ , c(12:159)], 2, mean  )*5
Predict320ATNv2$deltaTau <- apply(delta_tau[ , c(12:159)], 2, mean  )*5
Predict320ATNv2$deltaFDG <- apply(delta_fdg[ , c(12:159)], 2, mean  )*5
Predict320ATNv2 <- Predict320ATNv2[, -c(2,3,4)]

Predict320ATNv2<-Predict320ATNv2[order(-Predict320ATNv2$Ppredict320), ]
Predict320ATNv2$id<-c(1:148)
dataMelt<-melt(Predict320ATNv2, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="", title="pred2, delta (multipled by 5 )")

```


```{r}
divisionAmy<- delta_amy[,c(12:159)]/amy_first321[-80, c(12:159)]
divisionTau<- delta_tau[,c(12:159)]/tau_first321[-80, c(12:159)]
divisionFDG<- delta_fdg[,c(12:159)]/FDG_first[-80, c(12:159)]

```

```{r}
Predict320ATNv1<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv1$Ppredict320 <- apply(pred, 2, mean)
Predict320ATNv1$Relative_deltaAmy <- apply(divisionAmy, 2, mean  )*5
Predict320ATNv1$Relative_deltaTau <- apply(divisionTau, 2, mean  )*5
Predict320ATNv1$Relative_deltaFDG <- apply(divisionFDG, 2, mean  )*5
Predict320ATNv1 <- Predict320ATNv1[, -c(2,3,4)]

Predict320ATNv1<-Predict320ATNv1[order(-Predict320ATNv1$Ppredict320), ]
Predict320ATNv1$id<-c(1:148)
dataMelt<-melt(Predict320ATNv1, id.vars = c("id"))

ggplot(dataMelt, aes(x=id, y=value, colour=variable)) + geom_line()  + geom_point()+labs(y="", title="pred1, Relative delta ATN (multipled by 5 )")

```
```{r}
View(Predict320ATNv2)
```

```{r}
Predict320ATNv2<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv2$Ppredict320 <- apply(pred22[, c(2:149)]  , 2, mean)
Predict320ATNv2$Relative_deltaAmy <- apply(amy_last320[, c(12:159)], 2, mean  )
Predict320ATNv2$Relative_deltaTau <- apply(tau_last320[, c(12:159)], 2, mean  )
Predict320ATNv2$Relative_deltaFDG <- apply(FDG_last320[, c(12:159)], 2, mean  )
Predict320ATNv2 <- Predict320ATNv2[, -c(2,3,4)]

Predict320ATNv2<-Predict320ATNv2[order(Predict320ATNv2$Ppredict320), ]
 
Predict320ATNv2$id<-c(1:148)
Predict320ATNv2$riskline<-(Predict320ATNv2$Ppredict320+(0.42/2.1))*2.1

riskline<-rbind(Predict320ATNv2[, c(6,5)],Predict320ATNv2[, c(6,5)],Predict320ATNv2[, c(6,5)] )
colnames(riskline)[1]<-"Ppredict320"

dataMelt<-melt(Predict320ATNv2[, c(2:5)], id.vars = c("id"))
 

sortedPredATNlastscan <- ggplot(dataMelt, aes(x=id, y=value, colour=variable))    + geom_point(size=2)+labs(y="") +stat_smooth(se=T, size=2)+ guides(size = "none"  ) +labs(x="Ordered by predicted risk", y="Last scan") +
  theme_bw()    +
  theme( aspect.ratio=4/5,
    
    axis.text.x=element_blank(),
    text = element_text(size=30),
     axis.ticks.x=element_blank(),
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.03,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    ) + scale_color_manual(labels = c(expression(Delta*Amyloid), expression(Delta*T*a*u),expression(Delta*FDG) ), values = c(  "#F8766D", "#00BFC4", "#7CAE00"))   
sortedPredATNlastscan <- sortedPredATNlastscan + geom_line(data=riskline, aes(x=id,y= Ppredict320),size=2, color = "black") +  scale_y_continuous(limits=c(.42, 2.52),sec.axis = sec_axis(~./2.1- (0.42/2.1), name = "Predicted risk"))
sortedPredATNlastscan
ggsave(
  file="sortedPredATNlastscan.png",
  plot = sortedPredATNlastscan,
  device = "png",
 # path = NULL,
  #scale = 1,
  width = 5*1.8,
  height = 4*1.8,
  units = "in"
  #dpi = 300,
  #limitsize = TRUE,
)

```


```{r}
length(which(amyfirst160$PTID ==amylast160$PTID ) )
```


```{r}
# 03/22

#Tau_SUVR <- read_excel("~/Downloads/amarnaclass/Tau_SUVR.xlsx")

Tau_SUVR320<- Tau_SUVR[which(Tau_SUVR$PTID %in% tau_last320$PTID),]
TABLE<-data.frame(table(Tau_SUVR320$PTID))
TABLE<- TABLE[which(TABLE$Freq>1),]
#amy_last320

amyfirst160<-amy_first321[-80,]
amyfirst160<-amyfirst160[which(amyfirst160$PTID %in% TABLE$Var1),]

taufirst160<-tau_first321[-80,]
taufirst160<-taufirst160[which(taufirst160$PTID %in% TABLE$Var1),]

FDGfirst160<-FDG321_first[-80,] 
FDGfirst160<-FDGfirst160[which(FDGfirst160$PTID %in% TABLE$Var1),]

taulast160<-tau_last320[which(tau_last320$PTID %in% TABLE$Var1),]
amylast160<-amy_last320[which(amy_last320$PTID %in% TABLE$Var1),]
FDGlast160<-FDG_last320[which(FDG_last320$PTID %in% TABLE$Var1),]

 
 
 
Ppredict160<-apply(pred22[, c(3:150)], 2, mean)
Predict160ATN<-as.data.frame(cbind( Ppredict160) )
rownames(Predict160ATN)<-c(1:148)


#Predict160ATN$amylast <- apply(amylast160[, c(12:159)], 2, mean  )
#Predict160ATN$taulast <- apply(taulast160[, c(12:159)], 2, mean  )
#Predict160ATN$FDGlast <- apply(FDGlast160[, c(12:159)], 2, mean  )

#delta_amy<-amylast160
#delta_amy[, c(12:159)]<- amylast160[, c(12:159)] - amyfirst160[, c(12:159)] 
delta_tau<-taulast160
delta_tau[, c(12:159)]<- taulast160[, c(12:159)] - taufirst160[, c(12:159)] 
#delta_fdg<-FDGlast160
#delta_fdg[, c(12:159)]<- FDGlast160[, c(12:159)] - FDGfirst160[, c(12:159)] 





```

```{r}
delta_amy<- amy_last321[-80, ]
delta_amy[,  c(12:159)]<- amy_last321[-80, c(12:159)] - amy_first321[-80, c(12:159)]
delta_amy<-delta_amy[which(delta_amy$`Node 1` !=0),]
 

delta_tau<- tau_last321[-80, ]
delta_tau[,  c(12:159)]<- tau_last321[-80, c(12:159)] - tau_first321[-80, c(12:159)]
delta_tau<-delta_tau[which(delta_tau$`Node 1` !=0),]

delta_fdg<- FDG321_last[-80, ]
delta_fdg[,  c(12:159)]<- FDG321_last[-80, c(12:159)] - FDG321_first[-80, c(12:159)]
delta_fdg<-delta_fdg[which(delta_fdg$`Node 1` !=0),] 
 
```


## the second

```{r}
Predict320ATNv2<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv2$Ppredict320 <- apply(pred22[, c(3:150)]  , 2, mean)
Predict320ATNv2$Relative_deltaAmy <- apply(amy_last320[, c(12:159)], 2, mean  )
Predict320ATNv2$Relative_deltaTau <- apply(tau_last320[, c(12:159)], 2, mean  )
Predict320ATNv2$Relative_deltaFDG <- apply(FDG_last320[, c(12:159)], 2, mean  )
Predict320ATNv2 <- Predict320ATNv2[, -c(2,3,4)]

Predict320ATNv2<-Predict320ATNv2[order(Predict320ATNv2$Ppredict320), ]
 
Predict320ATNv2$id<-c(1:148)
Predict320ATNv2$riskline<-(Predict320ATNv2$Ppredict320+(0.42/2.1))*2.1

riskline<-rbind(Predict320ATNv2[, c(6,5)],Predict320ATNv2[, c(6,5)],Predict320ATNv2[, c(6,5)] )
colnames(riskline)[1]<-"Ppredict320"

dataMelt<-melt(Predict320ATNv2[, c(2:5)], id.vars = c("id"))
 

sortedPredATNlastscan <- ggplot(dataMelt, aes(x=id, y=value, colour=variable))    + geom_point(size=2)+labs(y="") +stat_smooth(se=T, size=2)+ guides(size = "none"  ) + scale_y_continuous( limits = c(0.4, 2.6), 
  labels = scales::number_format(accuracy = .05)) +labs(x="Nodes ordered by predicted risk", y="Last scan") +
  theme_bw()    +
  theme( aspect.ratio=3/4,
    
    axis.text.x=element_blank(),
    text = element_text(size=30),
     axis.ticks.x=element_blank(),
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.03,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    ) + scale_color_manual(labels = c(expression(Delta*Amyloid), expression(Delta*T*a*u),expression(Delta*FDG) ), values = c(  "#F8766D", "#00BFC4", "#7CAE00"))   
 sortedPredATNlastscan
ggsave(
  file="sortedPredATNlastscan.png",
  plot = sortedPredATNlastscan,
  device = "png",
 # path = NULL,
  #scale = 1,
  width = 4*1.8,
  height = 3*1.8,
  units = "in"
  #dpi = 300,
  #limitsize = TRUE,
)
```


```{r}

pred22 <- read.csv("~/Downloads/2020 research/pred22.csv")
Predict320ATNv2<-as.data.frame(apply(pred22[, c(3:150)]  , 2, mean))
Predict320Amy<-as.data.frame(apply(Amyloid_320[, c(12:159)]  , 2, mean))
Predict320Tau<-as.data.frame(apply(Tau_320[, c(12:159)]  , 2, mean))
Predict320FDG<-as.data.frame(apply(FDG_320[, c(12:159)]  , 2, mean))
```


# Tau Last
```{r}
TABLE<-data.frame(table(Tau_SUVR$PTID))
TABLE<- TABLE[which(TABLE$Freq<2),]
TABLE2<-data.frame(table(Tau_SUVR$PTID))
TABLE2<- TABLE2[which(TABLE2$Freq>1),]

TABLE<-data.frame(table(Tau_SUVR$PTID))
TABLE<- TABLE[which(TABLE$Freq>1),]
 
Tau_Last<- as.data.frame(matrix(0,nrow(TABLE), ncol(Tau_SUVR)))
for (i in 1:nrow(TABLE)){
Tau_Last[i,] <- as.data.frame(Tau_SUVR[max(which(Tau_SUVR$PTID == TABLE$Var1[i])), ])

}
colnames(Tau_Last) <- colnames(Tau_SUVR)

```
```{r}
Tau_320<-Tau_Last[which(pred22$PTID %in% Tau_Last$PTID),]
Tau_320<-Tau_320 %>% 
  filter(Tau_320$PTID != "NULL")
save(Tau_320,file="Tau320.Rda")
```


```{r calculate risk}


Pred320<-cbind(Predict320Amy,Predict320Tau,Predict320FDG,Predict320ATNv2,c(1:148))
colnames(Pred320)<-c("Amyloid","Tau","FDG","Predicted risk")
save(Pred320,file="Pred320.Rda")
```
```{r}
#Pred320<-cbind(Pred320,c(1:148))
colnames(Pred320)<-c("Amyloid","Tau","FDG","Predicted risk","id","1","riskline")
Pred320<-Pred320[order(Pred320$`Predicted risk`),]
Pred320$riskline<-(Pred320$`Predicted risk`+(0.42/2.1))*2.1

```
```{r}
riskline<-rbind(Pred320[, c(6,5)],Pred320[, c(6,5)],Pred320[, c(6,5)] )
colnames(riskline)[1]<-"Ppredict320"

dataMelt<-melt(Pred320[, c(2:5)], id.vars = c("id"))

```


Predict320ATNv2<-  Pdatafdg320[, c(2, 4, 5, 6)]
Predict320ATNv2$Ppredict320 <- apply(pred22[, c(3:150)]  , 2, mean)
Predict320ATNv2$Relative_deltaAmy <- apply(amy_last320[, c(12:159)], 2, mean  )
Predict320ATNv2$Relative_deltaTau <- apply(tau_last320[, c(12:159)], 2, mean  )
Predict320ATNv2$Relative_deltaFDG <- apply(FDG_last320[, c(12:159)], 2, mean  )
Predict320ATNv2 <- Predict320ATNv2[, -c(2,3,4)]
Predict320ATNv2 <- Predict320ATNv2[, -c(2,3,4)]

Predict320ATNv2<-Predict320ATNv2[order(Predict320ATNv2$Ppredict320), ]
 
Predict320ATNv2$id<-c(1:148)
Predict320ATNv2$riskline<-(Predict320ATNv2$Ppredict320+(0.42/2.1))*2.1

riskline<-rbind(Predict320ATNv2[, c(6,5)],Predict320ATNv2[, c(6,5)],Predict320ATNv2[, c(6,5)] )
colnames(riskline)[1]<-"Ppredict320"


```{r}


ok<-ggplot(dataMelt, aes(x=id, y=value, colour=variable))    + geom_point(size=2)+labs(y="") +stat_smooth(se=T, size=2)+ guides(size = "none"  ) + scale_y_continuous( limits = c(0.4, 2.6), 
  labels = scales::number_format(accuracy = .05)) +labs(x=expression('Low' %<-%'Predicted risk'%->% 'High'), y="Last scan") +
  theme_bw()    +
  theme( aspect.ratio=3/4,
    
    axis.text.x=element_blank(),
    text = element_text(size=30),
     axis.ticks.x=element_blank(),
   
    # change legend font size
    legend.text=element_text(size=26),
    # Remove panel grid lines
    
    
    panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
    legend.key=element_blank(),
    legend.background=element_blank(),
    legend.title = element_blank(),
    legend.position =c(.03,.89),
  legend.direction = "horizontal",
    legend.justification = c(0.05, 0.1),
    legend.box.just = "right",
    legend.key.size = unit(1, "cm")
    ) + scale_color_manual(labels = c(expression(Amyloid), expression(T*a*u),expression(FDG) ), values = c(  "#F8766D", "#00BFC4", "#7CAE00"))   

ggsave(
  file="sortedPredATNlastscan.png",
  plot = ok,
  device = "png",
 # path = NULL,
  #scale = 1,
  width = 4*1.8,
  height = 3*1.8,
  units = "in"
  #dpi = 300,
  #limitsize = TRUE,
)
```


